// pages/mine/addMemberCard/addMemberCard.js
import config from '../../../config.js';
var app = getApp();
var util = require('../../../utils/util.js');
var fightUtil = require('../../../utils/freeFightCutdown.js');
import ToastPannel from '../../../common/toastTest/toastTest.js';
var WxNotificationCenter = require("../../../utils/WxNotificationCenter.js");

var vipList = []; //ä¼šå‘˜å¡åˆ—è¡¨
var userVipList = []; //å·²åŠä¼šå‘˜å¡åˆ—è¡¨

var checkIndex = 0;


var vip_count = 1; //è¦åŠçš„ä¼šå‘˜å¡æ•°é‡

var jump = 1; //æ¥æº  1ï¼šä¸ªäººä¸­å¿ƒï¼Œ2å•†å“è¯¦æƒ…

var from_type = -1000
var from_type_name = -1000

var kaiKaVipType;

var loginCount;

var loginClick = 0;

var checkCardHave = false //å½“å‰é€‰ä¸­çš„ä¼šå‘˜å¡æ˜¯å¦å·²ç»åŠç†

// var extract = 0;//ç”¨æˆ·ç‚¹ç”¨æ¥æŠµæ‰£ç‚¹å¯æç°é¢åº¦


var fixMoney = 0.00; //ç”¨æˆ·ç‚¹ç”¨æ¥æŠµæ‰£å°†å¥–åŠ±é‡‘



var choosePayPrice = 0; //ç”¨æˆ·é€‰ä¸­ä¼šå‘˜å¡ååº•éƒ¨æ˜¾ç¤ºç‚¹æ”¯ä»˜ä»·æ ¼


var overVipIndex; //æ¬ è´¹çš„å¡çš„åºå·

var loadVipType = 5;

var comefromTXkaDialog = 0; //æ˜¯å¦æ˜¯ä»1æç°å¡ã€2å…æ‹¼å¡ã€3å‘è´§å¡å¼¹çª—è¿›æ¥çš„ã€è®¢å•åˆ—è¡¨å…è´¹é¢†æŒ‰é’® 5ã€è½¬ç›˜æˆä¸ºä¼šå‘˜è¿›æ¥çš„


//from_type:
//   - 1æŠ½å¥–æ¬¡æ•°ä¸è¶³ä¸”æœ‰å¤±æ•ˆçš„ä¼šå‘˜å¡
//   -2ä¼šå‘˜å¡æŠ½å¥–æ¬¡æ•°ä½†æ— å¤±æ•ˆä¼šå‘˜å¡ï¼Œä»¥åŠä¼šå‘˜å¡ç­‰çº§ä¸å¤Ÿ
//   - 3ç”¨æˆ·æ‰€æœ‰çš„ä¼šå‘˜å¡å…¨éƒ¨ä½œåºŸ

var isLoginSuccess = true;

var balance = 0; //ç”¨æˆ·æ‰€æœ‰çš„ä¼šå‘˜å¡å¡è´¹


var trialcash_num = 1; //æ¯å¼ æç°å¡ç»™çš„æç°æœºä¼šæ¬¡æ•°



var firstDiamondCard; //æ˜¯å¦æ˜¯é¦–å¼ é’»çŸ³å¡--1æ˜¯é¦–å¼ 
var firstCashcard; //æ˜¯å¦æ˜¯é¦–å¼ æç°å¡--1æ˜¯é¦–å¼ 




var raffle_money; //å½“æ—¥æŠ½ä¸­çš„è™šæ‹Ÿå¥–é‡‘  

var twoDiamondCard; //æ˜¯ä¸æ˜¯è¦è¡¥ç¬¬äºŒå¼ é’»çŸ³å¡  0ä¸è¡¥  1è¡¥

var freeOrder; //æ˜¯å¦æœ‰199å…ƒä»¥ä¸‹çš„å…è´¹é¢†è®¢å•  0æ²¡æœ‰ 1æœ‰

var pay_v_code; //ä¸‹å•åè¿”è¿˜çš„è®¢å•å·

var one_price;

var trialIsBuy; //æ˜¯å¦äºŒæ¬¡è´­ä¹°è¿‡æç°å¡

var vip_roll_type; //ç”³è¯·å‘è´§éœ€è¦çš„ä¼šå‘˜å¡

var isvip_paysuccess = false; //æ˜¯å¦ä¹°ä¼šå‘˜å¡æˆåŠŸ

var paySucDialogData; //è´­ä¹°å¡åæç¤ºä¿¡æ¯ä¸Šé¢çš„æ•°æ®
Page({

  /**
   * é¡µé¢çš„åˆå§‹æ•°æ®
   */
  data: {
    swiperH: '', //swiperé«˜åº¦
    nowIdx: 0, //å½“å‰swiperç´¢å¼•
    vipPrice: '0.00',
    freeCount: "0",
    current: 0,
    vip_count: 1,
    Upyun: config.Upyun,
    img_jian: "vip_couot_jian_end_new",
    img_jia: "vip_couot_jia_new",
    patBTname: 'å¼€é€šå¹¶æ”¯ä»˜',
    showInviteFriends: true,

    upyconfig: config.Upyun,
    jianglijin_name: "ç°é‡‘",
    messageanimationData: {},
    showPaySuccessDialog: false,

    hideModal: true, //æ¨¡æ€æ¡†çš„çŠ¶æ€  true-éšè—  false-æ˜¾ç¤º
    animationData: {},
    length: 0,
    secondimgData: ['complaint_1.png', 'complaint_2.png', 'complaint_3.png'],
    secondtextData: ['å‘é€ç»™æœ‹å‹', 'æ·»åŠ åˆ°æˆ‘çš„å°ç¨‹åº', 'æ·»åŠ åˆ°æ¡Œé¢'],
    thirdimgData: ['complaint_4.png', 'complaint_5.png', 'complaint_6.png', 'complaint_7.png'],
    thirdtextData: ['æµ®çª—', 'è®¾ç½®', 'åé¦ˆä¸æŠ•è¯‰', 'é‡æ–°è¿›å…¥å°ç¨‹åº'],
  },

  //è·å–swiperé«˜åº¦
  getHeight: function(e) {
    var winWid = wx.getSystemInfoSync().windowWidth - 2 * 50; //è·å–å½“å‰å±å¹•çš„å®½åº¦
    var imgh = e.detail.height; //å›¾ç‰‡é«˜åº¦
    var imgw = e.detail.width; //å›¾ç‰‡å®½åº¦
    var sH = winWid * imgh / imgw - 20 + "px"

    var swhpx = winWid * imgh / imgw - 20;


    this.setData({
      jiatoutop: (swhpx + 40) / 2 - 13,
      swiperH: sH //è®¾ç½®é«˜åº¦
    })
  },
  //swiperæ»‘åŠ¨äº‹ä»¶
  swiperChange: function(e) {
    this.setData({
      nowIdx: e.detail.current,
      img_jian: "vip_couot_jian_end_new",
      img_jia: "vip_couot_jia_new",
    })
    vip_count = 1
    checkIndex = e.detail.current

    vip_count = vipList[checkIndex].purchase_num; //é»˜è®¤ä¹°çš„æ•°é‡

    choosePayPrice = vipList[checkIndex].vip_num ?
      (vipList[checkIndex].arrears_price > 0 ? vipList[checkIndex].arrears_price.toFixed(2) : vipList[checkIndex].vip_price.toFixed(2)) : vipList[checkIndex].vip_price.toFixed(2);



    if (choosePayPrice <= 0) {
      choosePayPrice = 0.00
    }

    if (vipList[checkIndex].vip_code) {
      checkCardHave = true
    } else {
      checkCardHave = false

    }

    //å¦‚æœç”¨æˆ·ä¹°äº†åŠå¼ é’»çŸ³å¡åˆ‡åˆ°é’»çŸ³å¡ç•Œé¢å‡å¼¹æ­¤æ¡† 2020-3-23ä¿®æ”¹
    if (twoDiamondCard == 1 && vipList[checkIndex].vip_type == 4 && isvip_paysuccess != true) {
      var that = this;
      if (!that.data.is_fresh) {
        var cutdowntime = 30 * 60 * 1000;
        fightUtil.countdown(that, fightUtil, cutdowntime, function(data) {
          that.setData({
            is_fresh: true,
            zuanshiDaoJishiStr: data + "åå¤±æ•ˆ"
          })
        })
        that.setData({
          showBuQaunZaunShi: true,
        })
      } else {
        that.setData({
          showBuQaunZaunShi: true
        })
      }
    }
    if (isvip_paysuccess) {
      isvip_paysuccess = false;
    }


    this.setData({

      checkCardHave: checkCardHave,

      vipPrice:


        vipList[checkIndex].arrears_price > 0 ? vipList[checkIndex].arrears_price.toFixed(2) : vipList[checkIndex].vip_price.toFixed(2)

        ,

      o_price: vipList[checkIndex].original_vip_price * vip_count + "å…ƒ",


      //  vipList[checkIndex].vip_num ? vipList[checkIndex].vip_balance : 



      //  vipList[checkIndex].vip_price,






      payPrice: isLoginSuccess ? "" : choosePayPrice,

      // patBTname: vipList[checkIndex].arrears_price > 0 ? 'è¡¥è¶³ä¼šå‘˜è´¹' : 'é¢„å­˜å¹¶å¼€é€š',

      // payName: vipList[checkIndex].arrears_price > 0 ? "è¡¥è¶³ä¼šå‘˜å¡è´¹" : "é¢„å­˜",


      payName: "é¢„å­˜",

      patBTname: from_type_name == -1 ? 'å¼€é€šæ–°å¡å…è´¹é¢†ç¾è¡£' : 'é¢„å­˜å¹¶å¼€é€š',

      cashabletime: vipList[checkIndex].cashabletime,

      freeCount: vipList[checkIndex].free_count,
      shopPrice: vipList[checkIndex].vip_price,

      vip_count: vip_count,



      showPay: true,

      showCount: vipList[checkIndex].arrears_price == 0 || !vipList[checkIndex].arrears_price,

    })



    //å¦‚æœç™»å½•äº†æ˜¾ç¤ºçš„æ”¯ä»˜ä»·æ ¼å°±è°ƒæ¥å£å–
    if (isLoginSuccess) {
      this.getPayPrice();
    }



  },

  /**
   * ç”Ÿå‘½å‘¨æœŸå‡½æ•°--ç›‘å¬é¡µé¢åŠ è½½
   */
  onLoad: function(options) {


    // app.globalData.first_diamond = 1;
    // wx.redirectTo({
    //   url: "/pages/shouye/redHongBao?shouYePage=" + "ThreePage"
    // })
    // return

    comefromTXkaDialog = 0;
    from_type = -1000;

    var that = this;

    //å¤§ä¿ƒé”€å·²ç»“æŸ
    if (app.globalData.user != null) {
      var showendofpromotionDialog = app.globalData.user.showSpecialPage != 1 ? true : false;
      that.setData({
        showMainPage: true,
        showendofpromotionDialog: showendofpromotionDialog
      })
    } else {
      that.setData({
        showMainPage: true,
        showendofpromotionDialog: true
      })
    }
    
    wx.setNavigationBarTitle({
      title: 'é€‰æ‹©ä¼šå‘˜ç±»å‹',
    })
    
    // options.memberComefrom= undefined

    if (options.memberComefrom == "draw") {
      comefromTXkaDialog = 1;
    } else if (options.memberComefrom == 'freeFight') {
      comefromTXkaDialog = 2;
    } else if (options.memberComefrom == 'deliver') {
      comefromTXkaDialog = 3;
    } else if (options.memberComefrom == 'freelingOrder') {
      comefromTXkaDialog = 4;
    } else if (options.memberComefrom == 'draw_vip') {
      comefromTXkaDialog = 5;
    } else if (options.memberComefrom == 'Fight') {
      comefromTXkaDialog = 6;
    } else if (options.memberComefrom == 'sign_tixian'){
      comefromTXkaDialog = 7;
    }

    if (options.vip_roll_type != undefined) {
      vip_roll_type = options.vip_roll_type;
    }

    if (options.memberComefrom == "mine") {
      jump = 1;
    } else {
      jump = 2;

    }


    new app.ToastPannel();
    from_type = options.vip_type
    if (options.memberComefrom == 'order') {
      from_type = -1005;
    }


    from_type_name = from_type
    if (from_type == -1) {
      //ä¼šå‘˜ç”¨æˆ·å…è´¹æ¬¡æ•°é¢†å®Œåæœ‰å¤±æ•ˆçš„ä¼šå‘˜å¡
      // æç¤ºï¼šå°Šæ•¬çš„è¡£è ä¼šå‘˜ï¼Œæ‚¨çš„ä¼šå‘˜å¡è´¹å·²è¢«ç”¨äºè´­ä¹°å•†å“ï¼Œè¡¥è¶³ä¼šå‘˜å¡è´¹åå³å¯ç»§ç»­å…è´¹é¢†ã€‚
      // è·³å¤±æ•ˆä¼šå‘˜å¡

      // this.showToast("å°Šæ•¬çš„è¡£è ä¼šå‘˜ï¼Œæ‚¨çš„ä¼šå‘˜å¡è´¹å·²è¢«ç”¨äºè´­ä¹°å•†å“ï¼Œè¡¥è¶³ä¼šå‘˜å¡è´¹åå³å¯ç»§ç»­å…è´¹é¢†ã€‚", 5000);
      this.showToast("å› ä¼šå‘˜å¡è´¹ä¸è¶³ä¼šå‘˜èµ„æ ¼å·²å¤±æ•ˆï¼Œç°åœ¨å¼€é€šæ–°å¡ç«‹å³èµ é€ä¸€ä»¶399å…ƒçš„ç¾è¡£å“¦ã€‚", 5000);


    } else if (from_type == -2) {
      // ä¼šå‘˜ç”¨æˆ·å…è´¹æ¬¡æ•°é¢†å®Œåæ²¡æœ‰å¤±æ•ˆçš„ä¼šå‘˜å¡ï¼Œä»¥åŠç”¨æˆ·æœ‰å…è´¹é¢†æ¬¡æ•°ï¼Œä½†æ˜¯ç‚¹çš„æ˜¯æœ‰æ•ˆä¼šå‘˜å¡ä»¥å¤–çš„å•†å“
      // æç¤ºï¼šå°Šæ•¬çš„è¡£è ä¼šå‘˜ï¼Œæ‚¨çš„ä¼šå‘˜å…è´¹é¢†æƒç›Šä¸è¶³ï¼Œå‡çº§ä¼šå‘˜å¡åå³å¯ç»§ç»­å…è´¹é¢†ã€‚
      // è·³899è‡³å°Šå¡

      this.showToast("å°Šæ•¬çš„è¡£è ä¼šå‘˜ï¼Œæ‚¨ä»Šæ—¥çš„ä¼šå‘˜å¡å…è´¹é¢†æ¬¡æ•°å·²ä½¿ç”¨å®Œï¼Œè´­ä¹°æ–°çš„ä¼šå‘˜å¡åå³å¯ç»§ç»­å…è´¹é¢†", 5000);

    } else if (from_type == -3) {
      // ä¼šå‘˜ç”¨æˆ·å› ä¸ºæŠµæ‰£æ‰€æœ‰çš„ä¼šå‘˜å¡å…¨éƒ¨ä½œåºŸå
      // æç¤ºï¼šå°Šæ•¬çš„è¡£è ä¼šå‘˜ï¼Œæ‚¨çš„ä¼šå‘˜å¡è´¹å·²è¢«å…¨é¢ç”¨äºè´­ä¹°å•†å“ï¼Œè¯·é‡æ–°è´­ä¹°ä¼šå‘˜å¡ã€‚
      // è·³59.9é‡‘å¡
      this.showToast("å°Šæ•¬çš„è¡£è ä¼šå‘˜ï¼Œæ‚¨çš„ä¼šå‘˜å¡è´¹å·²è¢«å…¨é¢ç”¨äºè´­ä¹°å•†å“ï¼Œè¯·é‡æ–°è´­ä¹°ä¼šå‘˜å¡ã€‚", 5000);

    } else if (from_type == -4) {
      // å°Šæ•¬çš„è¡£è ä¼šå‘˜ï¼Œæ‚¨å½“å‰çš„ä¼šå‘˜å¡åªèƒ½å…è´¹é¢†" + 10000+"å…ƒä»¥ä¸‹å•†å“ï¼Œè¯·è´­ä¹°é«˜ç­‰çº§çš„ä¼šå‘˜å¡å…è´¹é¢†æ›´å¤šå•†å“ã€‚

    } else if (from_type == -5) { //è®¢å•åˆ—è¡¨éä¼šä¼šå‘˜å…è´¹é¢†æ‰“å¡å®Œæˆåç‚¹å‡»ç”³è¯·å‘è´§,åœç•™åœ¨é’»çŸ³å¡ä¸Šé¢
      this.showToast("å…è´¹é¢†æ˜¯ä¼šå‘˜ç‰¹æƒï¼Œæˆä¸ºä¼šå‘˜åï¼Œå³å¯å…è´¹å‘è´§ã€‚", 5000);

    }

    setTimeout(function() {
      that.setData({
        isShowCustomTv: true,
      });
      var animation = wx.createAnimation({
        duration: 500,
        timingFunction: 'ease',
        delay: 5000,
      })
      animation.translateX(50).opacity(0).step()
      that.setData({
        messageanimationData: animation.export()
      })
    }, 2000);

    this.initVipData(-1)
  },

  initVipData: function(kaiKa_vipType) {
    fixMoney = 0.00;
    var that = this;
    checkIndex = 0
    vipList = []
    userVipList = []
    //é»˜è®¤è´­ä¹°ä¸€å¼ å¡
    vip_count = 1

    that.setData({
      vip_count: 1
    })
    var requestUrl
    if (app.globalData.user) {
      isLoginSuccess = true
      requestUrl = config.Host + 'userVipType/queryByVipList?token=' + app.globalData.user.userToken + '&jump=' + 1 + config.Version;
    } else {
      isLoginSuccess = false


      that.setData({
        showLoginDialog: true
      })


      requestUrl = config.Host + 'userVipType/queryByVipList?jump=' + 1 + config.Version;

    }
    wx.showLoading({
      title: 'è¯·ç¨å',
      mask: true,
    })
    util.http(requestUrl, function(data) {

      if (data.status == 1) {

        balance = data.balance;

        trialcash_num = data.trialcash_num;

        twoDiamondCard = data.twoDiamondCard;
        raffle_money = data.raffle_money;


        twoDiamondCard = data.twoDiamondCard;
        trialIsBuy = data.trialIsBuy;

        firstDiamondCard = data.firstDiamondCard;
        firstCashcard = data.firstCashcard;

        vipList = data.viplist; //ä¼šå‘˜åˆ—è¡¨

        loadVipType = data.landPage;

        if (data.userVipList) {
          userVipList = data.userVipList; //å·²å¼€ä¼šå‘˜åˆ—è¡¨
        }

        if (from_type == -4) { //-4çš„æç¤ºéœ€è¦å–æœ€é«˜ä¼šå‘˜å¡çš„é‡‘é¢å¹¶æç¤º

          var maxPrice_section = userVipList[0].price_section;

          for (var i = 0; i < userVipList.length; i++) {
            if (userVipList[i].price_section > maxPrice_section) {
              maxPrice_section = userVipList[i].price_section
            }
          }
          that.showToast("å°Šæ•¬çš„è¡£è ä¼šå‘˜ï¼Œæ‚¨å½“å‰çš„ä¼šå‘˜å¡åªèƒ½å…è´¹é¢†" + maxPrice_section + "å…ƒä»¥ä¸‹å•†å“ï¼Œè¯·è´­ä¹°é«˜ç­‰çº§çš„ä¼šå‘˜å¡å…è´¹é¢†æ›´å¤šå•†å“ã€‚", 5000);
          // from_type = -1000
        }

        //æ•´åˆåˆ—è¡¨
        for (var vipIndex in vipList) {


          for (var userVipIndex in userVipList) {



            if (vipList[vipIndex].vip_type == userVipList[userVipIndex].vip_type) {


              //æ·»åŠ vipListä¸­ä¸å­˜åœ¨çš„æ•°æ®
              vipList[vipIndex].arrears_price = userVipList[userVipIndex].arrears_price;
              vipList[vipIndex].vip_balance = userVipList[userVipIndex].vip_balance;
              vipList[vipIndex].vip_num = userVipList[userVipIndex].vip_num;
              vipList[vipIndex].vip_code = userVipList[userVipIndex].vip_code;
              vipList[vipIndex].num = userVipList[userVipIndex].num;
              vipList[vipIndex].count = userVipList[userVipIndex].count;
              vipList[vipIndex].user_vip_price = userVipList[userVipIndex].vip_price;


              vipList[vipIndex].arrears_price = vipList[vipIndex].arrears_price ? vipList[vipIndex].arrears_price : 0;



              if (vipList[vipIndex].info_url) {
                vipList[vipIndex].info_url = vipList[vipIndex].info_url + '?' + Math.random()
              }

              //æ·»åŠ userVipListä¸­ä¸å­˜åœ¨çš„æ•°æ®
              // userVipList[userVipIndex].url = vipList[vipIndex].url
              // userVipList[userVipIndex].vip_name = vipList[vipIndex].vip_name
              // userVipList[userVipIndex].free_count = vipList[vipIndex].free_count
              // userVipList[userVipIndex].head_url = vipList[vipIndex].head_url
              // userVipList[userVipIndex].vip_price = vipList[vipIndex].vip_price
              // userVipList[userVipIndex].info_url = vipList[vipIndex].info_url
              // userVipList[userVipIndex].cashabletime = vipList[vipIndex].cashabletime
              // userVipList[userVipIndex].free_count = vipList[vipIndex].free_count
              // userVipList[userVipIndex].free_num = vipList[vipIndex].free_num



              //å¤„ç†days
              // userVipList[userVipIndex].days =
              //   userVipList[userVipIndex].context ? userVipList[userVipIndex].context + '' : ""

              vipList[vipIndex].days = userVipList[userVipIndex].context ? userVipList[userVipIndex].context + '' : ""



              //å¤„ç†substance
              // userVipList[userVipIndex].substance =
              //   userVipList[userVipIndex].substance ? userVipList[userVipIndex].substance + '' : ""

              vipList[vipIndex].substance = userVipList[userVipIndex].substance ? userVipList[userVipIndex].substance + '' : ""



              var isOverVip = false //æ˜¯å¦æ¬ è´¹--éœ€è¦è¡¥å¡
              if (vipList[vipIndex].arrears_price > 0) {
                isOverVip = true
                overVipIndex = vipIndex;
                vipList[vipIndex].isOver = true
              }

              //å¤„ç†cardName
              if (isOverVip) {


                // userVipList[userVipIndex].cardName =
                //   (userVipList[userVipIndex].vip_num - 1 <= 0) ? userVipList[userVipIndex].vip_name :
                //     "å·²æœ‰" + userVipList[userVipIndex].vip_name + "X" + (userVipList[userVipIndex].vip_num - 1)

                vipList[vipIndex].cardName =
                  (userVipList[userVipIndex].vip_num - 1 <= 0) ? vipList[vipIndex].vip_name :
                  "å·²æœ‰" + vipList[vipIndex].vip_name + "X" + (userVipList[userVipIndex].vip_num - 1)



              } else {
                // userVipList[userVipIndex].cardName =
                //   userVipList[userVipIndex].vip_num > 0 ? "å·²æœ‰" + userVipList[userVipIndex].vip_name + "X" + userVipList[userVipIndex].vip_num : userVipList[userVipIndex].vip_name + ""

                vipList[vipIndex].cardName =
                  userVipList[userVipIndex].vip_num > 0 ? "å·²æœ‰" + vipList[vipIndex].vip_name + "X" + userVipList[userVipIndex].vip_num : vipList[vipIndex].vip_name + ""
              }










              //å¤„ç†æ€»é‡‘é¢userVipMoney
              // userVipList[userVipIndex].userVipMoney = vipList[vipIndex].vip_balance ? 
              //   'å¡è´¹ï¿¥' + vipList[vipIndex].vip_balance.toFixed(2) : ""


              // vipList[vipIndex].userVipMoney = balance && balance >0 ?
              //   'é¢„å­˜ï¿¥' + balance : ""

              // userVipList[userVipIndex].userVipMoney =
              //   userVipList[userVipIndex].vip_num > 0 ? 'å¡è´¹ï¿¥' + userVipList[userVipIndex].vip_num * userVipList[userVipIndex].vip_price : ""


            }

            vipList[vipIndex].userVipMoney = balance && balance > 0 ?
              'å·²é¢„å­˜ï¿¥' + balance : ""


          }
          //æ²¡æœ‰åŠçš„ä¼šå‘˜å¡cardNameè¦å–vip_name
          if (!vipList[vipIndex].cardName) {
            vipList[vipIndex].cardName = vipList[vipIndex].vip_name
          }

        }

        //æ’åºï¼Œå°†å·²å¼€é€šçš„ä¼šå‘˜çš„æœ€é«˜çº§åˆ«çš„æ”¾åœ¨å‰é¢
        //vipListä¸­å·²ç»å»æ‰å·²å¼€å¡çš„ä¼šå‘˜
        // for (var i = 0; i < vipList.length; i++) {
        //   if (vipList[i].vip_code) {
        //     vipList.splice(i, 1);
        //     i--;
        //   }
        // }
        //åˆå¹¶vipListå’ŒuserVipList
        // vipList = userVipList.concat(vipList)
        var size = vipList.length

        //é»˜è®¤index
        var currentIndex = 0;
        for (var i = 0; i < vipList.length; i++) {
          if (vipList[i].vip_type == loadVipType) {
            currentIndex = i
          }
        }


        //å¼€å¡çš„é»˜è®¤åˆ‡åˆ°é‡‘å¡(æ²¡æœ‰åŠè¿‡å¡çš„)
        if (from_type == -1002) {
          for (var i = 0; i < vipList.length; i++) {
            if (vipList[i].vip_type == 2) {
              currentIndex = i
            }
          }
        }

        //ä¸ªäººä¸­å¿ƒç‚¹è¿›æ¥çš„åˆ‡åˆ°å·²åŠçš„æœ€é«˜ä¼šå‘˜ä¸åŒ…æ‹¬æç°å¡å…æ‹¼å¡å‘è´§å¡
        if (jump == 1 && from_type == -1003) {
          var maxIdex = 0;
          for (var i = 0; i < vipList.length; i++) {
            var vip_type = vipList[i].vip_type;
            if (vipList[i].vip_code && vip_type != 7 && vip_type != 8 && vip_type != 9) {
              if (vipList[i].vip_type > maxIdex) {
                maxIdex = i;
                currentIndex = maxIdex
              }
            }
          }
        }


        if (from_type == -3 || from_type == -5) { //-3è·³59.9ï¼ˆé’»çŸ³ï¼‰
          //æ‰¾åˆ°é’»çŸ³å¡çš„index
          for (var i = 0; i < vipList.length; i++) {
            if (vipList[i].vip_type == 4) {
              currentIndex = i
            }
          }
        }



        if (from_type == -2 || from_type == -1001 || from_type == -4) { //åˆ‡æ¢åˆ°è‡³å°Šä¼šå‘˜(æˆä¸ºè‡³å°Šä¼šå‘˜çš„æŒ‰é’®ç‚¹è¿›æ¥ä¹Ÿè¦åˆ‡åˆ°è‡³å°Šä¼šå‘˜)
          //æ‰¾åˆ°è‡³å°Šå¡çš„index
          for (var i = 0; i < vipList.length; i++) {
            if (vipList[i].vip_type == 6) {
              currentIndex = i
            }
          }
        }

        if (from_type == -1005 || from_type == -1) { //åˆ‡æ¢åˆ°çš‡å† ä¼šå‘˜(è®¢å•åˆ—è¡¨ç”³è¯·å‘è´§-çš‡å† ä¼šå‘˜)ï¼Œæ¬ è´¹æç¤ºä¹Ÿåˆ‡æ¢åˆ°çš‡å† å¡
          //æ‰¾åˆ°è‡³å°Šå¡çš„index
          for (var i = 0; i < vipList.length; i++) {
            if (vipList[i].vip_type == 5) {
              currentIndex = i
            }
          }
        }



        //å¼€äº†æç°å¡å°±åˆ‡åˆ°é’»çŸ³å¡å¹¶å¼¹çª—
        // if (kaiKa_vipType == -1) {
        //   for (var i = 0; i < vipList.length; i++) {
        //     if (vipList[i].vip_type == 7 && vipList[i].vip_code) { //åˆšè¿›æ¥ï¼Œå¼€äº†æç°å¡
        //       //åˆ‡åˆ°é’»çŸ³å¡
        //       for (var m = 0; m < vipList.length; m++) {
        //         if (vipList[m].vip_type == 4) {
        //           that.setData({
        //             showTixiankaDialog: true
        //           })
        //           currentIndex = m;
        //           break;
        //         }
        //       }
        //     }
        //   }
        // }




        //æç°å¡å¼¹çª—è¿›æ¥çš„åˆ‡åˆ°æç°å¡
        if (comefromTXkaDialog == 1 || comefromTXkaDialog == 7) {
          for (var i = 0; i < vipList.length; i++) {
            if (vipList[i].vip_type == 7) {
              currentIndex = i
            }
          }
          if (kaiKa_vipType == -1)
          {
            wx.setStorageSync('tixian_count', firstCashcard == 1 ? '0' : '1')
          }
        }

        //å‘è´§å¡å¼¹çª—è¿›æ¥çš„åˆ‡åˆ°å‘è´§å¡
        if (comefromTXkaDialog == 3) {
          for (var i = 0; i < vipList.length; i++) {
            if (vipList[i].vip_type == 8) {
              currentIndex = i
            }
          }
        }

        //å…æ‹¼å¡å¼¹çª—è¿›æ¥çš„åˆ‡åˆ°æç°å¡
        if (comefromTXkaDialog == 2) {
          for (var i = 0; i < vipList.length; i++) {
            if (vipList[i].vip_type == 9) {
              currentIndex = i
            }
          }
        }
        //è®¢å•åˆ—è¡¨å…è´¹é¢†æŒ‰é’®è¿›æ¥å¹¶ä¸”æœ‰éœ€è¦è¡¥è¶³çš„é’»çŸ³å¡ï¼Œåˆ‡åˆ°é’»çŸ³å¡ã€çš‡å† å¡ã€è‡³å°Šå¡
        if (comefromTXkaDialog == 4) {
          if (vip_roll_type > 0) {
            for (var i = 0; i < vipList.length; i++) {
              if (vipList[i].vip_type == vip_roll_type) {
                currentIndex = i
              }
            }
          }
        }


        //kaiKa_vipType åˆ‡æ¢åˆ°åˆšå¼€çš„å¡
        //æ‰¾åˆšå¼€çš„å¡çš„index
        if (kaiKa_vipType != -1) {
          for (var i = 0; i < vipList.length; i++) {
            if (vipList[i].vip_type == kaiKaVipType) {
              currentIndex = i
            }
          }
        }


        checkIndex = currentIndex

        //å¦‚æœç”¨æˆ·ä¹°äº†åŠå¼ é’»çŸ³å¡åˆ‡åˆ°é’»çŸ³å¡ç•Œé¢å‡å¼¹æ­¤æ¡† 2020-3-23ä¿®æ”¹
        if (twoDiamondCard == 1 && vipList[currentIndex].vip_type == 4 && isvip_paysuccess != true) {

          var cutdowntime = 30 * 60 * 1000;
          fightUtil.countdown(that, fightUtil, cutdowntime, function(data) {
            that.setData({
              is_fresh: true,
              zuanshiDaoJishiStr: data + "åå¤±æ•ˆ"
            })
          })
          that.setData({
            showBuQaunZaunShi: true
          })
        }

        choosePayPrice = vipList[currentIndex].vip_num ?
          (vipList[currentIndex].arrears_price > 0 ? vipList[currentIndex].arrears_price.toFixed(2) : vipList[currentIndex].vip_price.toFixed(2)) : vipList[currentIndex].vip_price.toFixed(2);




        if (choosePayPrice <= 0) {
          choosePayPrice = "0.00"
        }

        if (vipList[currentIndex].vip_code) {
          checkCardHave = true
        } else {
          checkCardHave = false
        }






        //é»˜è®¤å¼ æ•°
        vip_count = vipList[currentIndex].purchase_num;


        //åŠè¿‡å¡çš„æƒç›Šæ›¿æ¢ä¸ºequityYet(æç°å¡å’Œé’»çŸ³å¡)
        for (var i = 0; i < vipList.length; i++) {
          if (vipList[i].vip_type == 7 && firstCashcard != 1) {
            vipList[i].equity = vipList[i].equityYet;
          }

          if (vipList[i].vip_type == 4 && firstDiamondCard != 1) {
            vipList[i].equity = vipList[i].equityYet;
          }
        }



        that.setData({

          zaunshiTKX: raffle_money,


          firstDiamondCard: firstDiamondCard, //æ˜¯å¦æ˜¯é¦–å¼ é’»çŸ³å¡
          firstCashcard: firstCashcard, //æ˜¯å¦æ˜¯é¦–å¼ æç°å¡

          nowIdx: currentIndex,
          vipList: vipList,
          current: currentIndex,
          o_price: vipList[currentIndex].original_vip_price * vip_count + "å…ƒ",
          vip_count: vip_count,
          checkCardHave: checkCardHave,

          vipPrice: vipList[currentIndex].arrears_price > 0 ?
            vipList[currentIndex].arrears_price.toFixed(2) : vipList[currentIndex].vip_price.toFixed(2),

          payPrice: isLoginSuccess ? "" : choosePayPrice,


          payName: "é¢„å­˜",

          patBTname: from_type_name == -1 ? 'å¼€é€šæ–°å¡å…è´¹é¢†ç¾è¡£' : 'é¢„å­˜å¹¶å¼€é€š',

          cashabletime: vipList[currentIndex].cashabletime,

          freeCount: vipList[currentIndex].free_count,
          shopPrice: vipList[currentIndex].vip_price,

          showPay: true,

          showCount: vipList[currentIndex].arrears_price == 0 || !vipList[currentIndex].arrears_price,

        })


        from_type = -1000

        //å¦‚æœç™»å½•äº†æ˜¾ç¤ºçš„æ”¯ä»˜ä»·æ ¼å°±è°ƒæ¥å£å–
        if (isLoginSuccess) {
          that.getPayPrice();
        } else {
          that.setData({
            fixMoney: fixMoney
          })
        }





      } else {





        that.showToast("" + data.message, 2000);


      }
      wx.hideLoading()

    })
  }, 

  //å¦‚æœç™»å½•äº†æ˜¾ç¤ºçš„æ”¯ä»˜ä»·æ ¼å°±è°ƒæ¥å£å–
  getPayPrice: function() {
    var that = this;

    var dataUrl = config.Host + "userVipCard/selActualPrice?" + config.Version + "&token=" + app.globalData.user.userToken +
      '&vip_type=' + vipList[checkIndex].vip_type + "&vip_count=" + vip_count
    util.http(dataUrl, function(data) {

      choosePayPrice = data.actual_price;

      one_price = data.one_price;

      that.setData({
        one_price: one_price,
        payPrice: data.actual_price,
        jianglijin_name: data.isSupply == 1 ? "å¥–åŠ±é‡‘" : "ç°é‡‘",
        fixMoney: data.fixMoney,
        trialNum: data.trialNum,
        original_price: data.original_price
      })

      var reMoney = data.reMoney;
      // reMoney = 10;
      if (vipList[checkIndex].vip_type == 4 && reMoney > 0) {
        that.setData({
          zuanshiReMoney: reMoney,
          showZuanshiDJKtishi: true
        })
      } else {
        that.setData({
          zuanshiReMoney: reMoney,
          showZuanshiDJKtishi: false
        })
      }

      if (vipList[checkIndex].purchase_maxNum == -1 || vip_count < vipList[checkIndex].purchase_maxNum) {
        that.setData({
          img_jia: "vip_couot_jia_new",
        })
      } else {
        that.setData({
          img_jia: "vip_couot_jia_new_end",
        })
      }


      if (vip_count > vipList[checkIndex].purchase_num) {
        that.setData({
          img_jian: "vip_couot_jian_new",
        })
      } else {
        that.setData({
          img_jian: "vip_couot_jian_end_new",
        })
      }


    });

  },
  yucunTap: function() {
    this.showToast("é¢„å­˜æ¬¾å°†å…¨é¢è¿”è¿˜ç»™æ‚¨è‡³æ‚¨çš„è¡£è é’±åŒ…ï¼Œå¯ç”¨æ¥ä»¥ä¼šå‘˜ä»·è´­ä¹°ä»»æ„å•†å“ã€‚ä¸å†æ”¯æŒé€€æ¬¾å“¦ã€‚", 5000);
  },

  // æäº¤è®¢å•
  submitOrder: function(e) {
    if (!app.globalData.user) {
      return
    }
    //ç”·æ€§ç”¨æˆ·ä¸å¯ä¸‹å•æ”¯ä»˜
    if (app.globalData.user.gender == 1) {
      this.showToast('ç³»ç»Ÿç»´æŠ¤ä¸­ï¼Œæš‚ä¸æ”¯æŒæ”¯ä»˜', 2000);
      return;
    }
    
    util.httpPushFormId(e.detail.formId);
    wx.showLoading({
      title: "è¯·ç¨å",
      mask: true
    })
    kaiKaVipType = vipList[checkIndex].vip_type

    var dataUrl = config.Host + "userVipCard/addUserVipCard?" + config.Version + "&token=" + app.globalData.user.userToken +
      '&vip_type=' + vipList[checkIndex].vip_type + "&vip_count=" + vip_count

    util.http(dataUrl, this.confirmorderResult);
    this.setData({
      dataurl: dataUrl
    });

  },
  // æäº¤è®¢å•ç»“æœ
  confirmorderResult: function(data) {
    var that = this;
    if (data.status == 1) {

      paySucDialogData = data.data;


      //æµ‹è¯•ç”¨------------------------
      // wx.hideLoading()
      // paySucDialogData = data.data;
      // if (paySucDialogData){
      //   that.setData({
      //     paySucDialogData: paySucDialogData,
      //     showPaySuccessDialog: true
      //   })
      // }else{
      //   that.showToast("2222", 5000);
      // }
      // return
      // ---------------------------------
      if (data.actual_price <= 0) { //æ— éœ€æ”¯ä»˜
        wx.hideLoading()
        //å‘é€è´­ä¹°ä¼šå‘˜æˆåŠŸçš„é€šçŸ¥
        WxNotificationCenter.postNotificationName("memberNotificationItem1Name", "becomeMemberfinish");
        if (vipList[checkIndex].arrears_price && vipList[checkIndex].arrears_price > 0) {
          that.showToast("å·²è¡¥é½ä¼šå‘˜å¡è´¹ï¼Œä¼šå‘˜æƒç›Šå·²æ¢å¤ï¼Œä¼šå‘˜æœŸå·²ç›¸åº”é¡ºå»¶ï¼Œç¥æ‚¨è´­ç‰©æ„‰å¿«ã€‚", 5000);

          from_type_name = -1000;

        } else {
          that.showToast("è´­ä¹°æˆåŠŸï¼Œä¼šå‘˜å¡æƒç›Šå·²å¼€é€šï¼Œç¥æ‚¨è´­ç‰©æ„‰å¿«ã€‚", 5000);
        }

        //æç°å¡çš„å¤„ç†
        if (kaiKaVipType == 7) {
          wx.setStorageSync('tixian_count', '');
          
          if (comefromTXkaDialog == 1 || comefromTXkaDialog == 5) { //è½¬ç›˜å¼•å¯¼è¿›æ¥çš„ï¼Œå»è½¬ç›˜
            wx.setStorageSync("KTtxkSuccessBack", 1)
          }

          //å¦‚æœæ˜¯è½¬ç›˜å¼•å¯¼æç°å¡è¿›æ¥çš„ï¼Œè¿”å›è½¬ç›˜ å¦åˆ™è·³è½¬åˆ°è½¬ç›˜å»æŠ½å¥–
          var pages = getCurrentPages() //è·å–åŠ è½½çš„é¡µé¢
          var currentPage = pages[pages.length - 2] //è·å–ä¸Šä¸€é¡µé¢çš„å¯¹è±¡
          if (currentPage.route == "pages/mine/withdrawLimitTwo/withdrawLimitTwo") {
            wx.navigateBack({})
          } else {
            wx.navigateTo({
              url: '/pages/mine/withdrawLimitTwo/withdrawLimitTwo',
            })
          }
        }

        that.initVipData(kaiKaVipType)
        wx.hideLoading()

        return
      }



      wx.login({
        success: res => {
          // å‘é€ res.code åˆ°åå°æ¢å– openId, sessionKey, unionId, 3rd_session
          if (res.code) {
            var dataUrl = config.PayHost + "wxpaycx/wapUinifiedOrderList?" + config.Version + "&token=" + app.globalData.user.userToken + '&order_name=æˆ‘çš„' + '&code=' + res.code + '&order_code=' + data.v_code;

            pay_v_code = data.v_code;
            util.http(dataUrl, that.orderPayResult)
          } else {
            console.log('è·å–ç”¨æˆ·ç™»å½•æ€å¤±è´¥ï¼' + res.errMsg)
            wx.hideLoading()
          }
        }
      })

    } else {


      wx.hideLoading();

      that.showToast("" + data.message, 2000);

    }
  },



  orderPayResult: function(data) {

    var that = this;
    if (data.status == 1) {
      var xml = data.xml;
      wx.requestPayment({
        'timeStamp': xml.timeStamp + "",
        'nonceStr': xml.nonceStr,
        'package': xml.package,
        'signType': xml.signType,
        'paySign': xml.paySign,
        'success': function(res) { //æ”¯ä»˜æˆåŠŸ


          // that.showToast("æ”¯ä»˜æˆåŠŸ", 2000);
          wx.hideLoading()
          //å‘é€è´­ä¹°ä¼šå‘˜æˆåŠŸçš„é€šçŸ¥
          WxNotificationCenter.postNotificationName("memberNotificationItem1Name", "becomeMemberfinish");
          
          wx.showLoading({
            title: "è¯·ç¨å",
            mask: true
          })
          wx.hideLoading();

          isvip_paysuccess = true;

          //è´­ä¹°ä¼šå‘˜å¡æˆåŠŸæ ‡è®°
          if (kaiKaVipType != 7 && kaiKaVipType != 8 && kaiKaVipType != 9)
          {
            wx.setStorageSync('vipCardPaySuccess', "1");
            wx.setStorageSync('KvipSuccessBack', "1");
            wx.setStorageSync('unVipRaffleMoney', paySucDialogData.unVipRaffleMoney);
          }
          //é“å…·å¡å’Œç¬¬1ç¬¬2å¼ é’»çŸ³å¡æç¤ºæ˜¯å¼¹çª—
          if (paySucDialogData) {
 
            that.setData({
              paySucDialogData: paySucDialogData,
              showPaySuccessDialog: true
            })

          } else {
            that.showToast("è´­ä¹°æˆåŠŸï¼Œä¼šå‘˜å¡æƒç›Šå·²å¼€é€šï¼Œç¥æ‚¨è´­ç‰©æ„‰å¿«ã€‚", 5000);
          }

          setTimeout(function() {
            that.initVipData(kaiKaVipType);
          }, 2000)
          return;



        },
        'fail': function(res) { //æ”¯ä»˜å¤±è´¥

          wx.hideLoading()
          that.showToast("æ”¯ä»˜å¤±è´¥", 2000);
        }
      })
      that.data.isConfirm = false;
    } else {


      that.showToast('' + data.message, 2000);


    }
  },

  closePaySucDialog: function() {
    var that = this;
    that.setData({
      showPaySuccessDialog: false
    })

    //æç°å¡çš„å¤„ç†
    if (kaiKaVipType == 7) {
      wx.setStorageSync('tixian_count', '');

      if (comefromTXkaDialog == 1 || comefromTXkaDialog == 5) { //è½¬ç›˜å¼•å¯¼è¿›æ¥çš„ï¼Œå»è½¬ç›˜
        wx.setStorageSync("KTtxkSuccessBack", 1)
      }

      //å¦‚æœæ˜¯è½¬ç›˜å¼•å¯¼æç°å¡è¿›æ¥çš„ï¼Œè¿”å›è½¬ç›˜ å¦åˆ™è·³è½¬åˆ°è½¬ç›˜å»æŠ½å¥–
      var pages = getCurrentPages() //è·å–åŠ è½½çš„é¡µé¢
      var currentPage = pages[pages.length - 2] //è·å–ä¸Šä¸€é¡µé¢çš„å¯¹è±¡
      if (currentPage.route == "pages/mine/withdrawLimitTwo/withdrawLimitTwo") {
        wx.navigateBack({})
      } else {
        wx.navigateTo({
          url: '/pages/mine/withdrawLimitTwo/withdrawLimitTwo',
        })
      }
      return
    }
    if (kaiKaVipType == 8) {
      if (comefromTXkaDialog == 3 || comefromTXkaDialog == 4) { //å‘è´§å¡å¼•å¯¼è¿›æ¥çš„
        wx.setStorageSync('KdeliverSuccessBack', '1')
      }
      return
    }
    if (kaiKaVipType == 9) {
      if (comefromTXkaDialog == 2 || comefromTXkaDialog == 6) { //å…æ‹¼å¡å¼•å¯¼è¿›æ¥çš„
        wx.setStorageSync("KfreeSuccessBack", '1')
      }
      return
    }

    //é¦–å¼ é’»çŸ³å¡çš„å¤„ç†
    if (paySucDialogData.diamondNum == 0 && kaiKaVipType == 4) {
      // that.getVirtualJiangLi(true); //æŸ¥è¯¢è™šæ‹ŸæŠ½å¥–
      app.globalData.first_diamond = 1;
      wx.redirectTo({
        url: "/pages/shouye/redHongBao?shouYePage=" + "ThreePage"
      })
      return
    }

    //ç¬¬äºŒå¼ é’»çŸ³å¡çš„å¤„ç†
    if (paySucDialogData.diamondNum == 1 && kaiKaVipType == 4) {
      that.getVirtualJiangLi(false);
      return;
    }

  },

  getVirtualJiangLi: function(first) {
    var that = this;
    var dataUrl = config.Host + "userVipCard/selCardPurchSucc?" + config.Version + "&token=" + app.globalData.user.userToken +
      '&v_code=' + pay_v_code;
    util.http(dataUrl, function(data) {
      // if (first) {
      // var raffle_money = data.raffle_money > 0 ? data.raffle_money : 90;
      // if (data.reMoney > 0) {
      //   that.showToast("é¢„å­˜" + data.reMoney + "å…ƒçš„é“å…·å¡ï¼ŒåŠä¼šå‘˜æç°çš„" + raffle_money +
      //     "å…ƒå¥–é‡‘å·²è¢«æŠµæ‰£ã€‚æ­å–œæ‚¨ä»¥æœ€ä¼˜æƒ çš„ä»·æ ¼æˆä¸ºé’»çŸ³ä¼šå‘˜ã€‚", 5000);
      // } else {
      //   that.showToast("è´­ä¹°æˆåŠŸï¼Œä¼šå‘˜å¡æƒç›Šå·²å¼€é€šï¼Œç¥æ‚¨è´­ç‰©æ„‰å¿«ã€‚", 5000);
      // }
      // } else {
      //å½“æ˜¯ä¹°ç¬¬äºŒå¼ é’»çŸ³å¡å¦‚æœæ²¡æœ‰å¯å‘è´§çš„è®¢å•è·³è½¬é¦–é¡µ3å…è´¹é¢†ï¼Œå¦åˆ™æç¤º
      var freeOrder = data.freeOrder;
      if (freeOrder == 1) {
        that.showToast("é¢„å­˜æˆåŠŸï¼Œå…è´¹é¢†è®¢å•å·²è¿›å…¥å¾…å‘è´§çŠ¶æ€ï¼Œè¯·æ³¨æ„ç‰©æµä¿¡æ¯ã€‚", 5000);
      } else {
        wx.redirectTo({
          url: "/pages/shouye/redHongBao?shouYePage=" + "ThreePage"
        })
      }
      // }
    });
  },

  jiaCount: function() {
    //ä½•æ³¢åŠ çš„2019-12-19
    var vip_type = vipList[checkIndex].vip_type;
    var vip_num = vipList[checkIndex].vip_num;
    var cardName = vipList[checkIndex].vip_name + 'å“¦';

    var purchase_num = vipList[checkIndex].purchase_num; //ä¸€æ¬¡ä¹°å¡å¼ æ•°
    var purchase_maxNum = vipList[checkIndex].purchase_maxNum; //ä¸€å…±å¯ä»¥ä¹°å¤šå°‘å¼ ï¼Œ-1ä¸ºä¸é™åˆ¶



    //é¦–æ¬¡è´­ä¹°æç°å¡åªèƒ½ä¹°ä¸€å¼ 
    if (vip_type == 7 && firstCashcard == 1) {
      this.showToast("é¦–æ¬¡åªèƒ½è´­ä¹°1å¼ æç°å¡å“¦", 5000);

      return
    }

    //éé¦–æ¬¡ä¹°æç°å¡æœ€å¤šèƒ½ä¹°15å¼ 
    if (vip_type == 7 && (vip_num + vip_count) > 15) {

      this.showToast("åªèƒ½è´­ä¹°15å¼ æç°å¡ã€‚", 5000);

      return
    }

    if (purchase_maxNum != -1 && vip_count >= purchase_maxNum) { //è¶…å‡ºå¯ä»¥è´­ä¹°çš„æ•°é‡

      this.showToast("1æ¬¡åªèƒ½è´­ä¹°" + purchase_maxNum + "å¼ " + cardName, 5000);

      return
    }



    //å…æ‹¼å¡å‰ä¸¤å¼ æ¯æ¬¡æœ€å¤šå¯ä¹°ä¸¤å¼  ç¬¬ä¸‰å¼ æ—¶æ¯æ¬¡æœ€å¤šå¯ä¹°ä¸€å¼  æœ€å¤š3å¼ 
    // if (vip_type == 9 || vip_type == 8) {

    //   if (vip_num == 0 || vip_num == undefined) {
    //     if (vip_count >= 2) {
    //       this.showToast("1æ¬¡åªèƒ½è´­ä¹°2å¼ " + cardName, 5000);
    //       return;
    //     }else{
    //       vip_count += purchase_num;
    //     }
    //   } else {
    //     if (vip_count >= 1) {
    //       this.showToast("1æ¬¡åªèƒ½è´­ä¹°1å¼ " + cardName, 5000);
    //       return;
    //     }
    //   }
    // } else if (vipList[checkIndex].vip_type == 4) { //é’»çŸ³å¡çš„å•ç‹¬å¤„ç†
    //   vip_count += purchase_num;
    // } else if (vipList[checkIndex].vip_type == 7 && firstCashcard != 1) { ////å·²ç»ä¹°è¿‡æç°å¡çš„ä¸€æ¬¡ä¹°5å¼ æç°å¡
    //   vip_count += purchase_num;
    // } else {
    //   vip_count += purchase_num;
    // }

    vip_count += purchase_num;

    choosePayPrice = (vipList[checkIndex].vip_price * vip_count).toFixed(2)

    if (choosePayPrice <= 0) {
      choosePayPrice = "0.0"
    }



    this.setData({
      vip_count: vip_count,
      o_price: vipList[checkIndex].original_vip_price * vip_count + "å…ƒ",
      payPrice: isLoginSuccess ? "" : choosePayPrice

    })


    //å¦‚æœç™»å½•äº†æ˜¾ç¤ºçš„æ”¯ä»˜ä»·æ ¼å°±è°ƒæ¥å£å–
    if (isLoginSuccess) {
      this.getPayPrice();
    }

  },
  jianCount: function() {
    var that = this;

    var purchase_num = vipList[checkIndex].purchase_num; //ä¸€æ¬¡ä¹°å¡å¼ æ•°
    var purchase_maxNum = vipList[checkIndex].purchase_maxNum; //ä¸€å…±å¯ä»¥ä¹°å¤šå°‘å¼ ï¼Œ-1ä¸ºä¸é™åˆ¶

    if (vipList[checkIndex].vip_type == 7 && firstCashcard != 1) {
      if (vip_count > 5) {
        vip_count -= 5;

      } else {

        return;
      }


    } else if (vipList[checkIndex].vip_type == 4) {
      if (vip_count <= purchase_num) {
        that.showToast("ç¬¬ä¸‰æ¬¡é¢„å­˜é’»çŸ³å¡å¿…é¡»2å¼ èµ·", 5000);
        return
      }
      vip_count -= purchase_num;


    } else if (vip_count > 1) {
      vip_count -= purchase_num;

    }

    // var o_price = 1000;

    // switch (vipList[checkIndex].vip_type) {
    //   case 4:
    //     o_price = 399 * vip_count
    //     break
    //   case 5:
    //     o_price = 699 * vip_count
    //     break
    //   case 6:
    //     o_price = 1599 * vip_count
    //     break

    // }

    choosePayPrice = (vipList[checkIndex].vip_price * vip_count).toFixed(2)

    if (choosePayPrice <= 0) {
      choosePayPrice = "0.0"
    }

    this.setData({
      o_price: vipList[checkIndex].original_vip_price * vip_count + "å…ƒ",

      vip_count: vip_count,
      payPrice: isLoginSuccess ? "" : choosePayPrice

    })

    //å¦‚æœç™»å½•äº†æ˜¾ç¤ºçš„æ”¯ä»˜ä»·æ ¼å°±è°ƒæ¥å£å–
    if (isLoginSuccess) {
      this.getPayPrice();
    }




  },

  type7Wenhao1Tap: function() {
    this.showToast("æ¯æ—¥èµ é€1æ¬¡ï¼Œæ€»è®¡10æ¬¡ã€‚", 5000);
  },
  type7Wenhao2Tap: function() {
    this.showToast("é™å……å€¼" + vipList[checkIndex].vip_price + "å…ƒåçš„é¦–æ¬¡æç°ï¼Œä»…é™1æ¬¡ã€‚", 5000);
  },


  qunyiWenhaoTap: function(event) {

    if (!vipList[checkIndex].vip_code) {

      return;
    } else if (vipList[checkIndex].vip_type == 7 && trialIsBuy == 0) {
      return;
    }

    var postitem = event.currentTarget.dataset.postitem;

    // if (vipList[checkIndex].vip_type != 7){
    //   this.showToast("é™åŸä»·" + vipList[checkIndex].price_section + "å…ƒä»¥ä¸‹ï¼ˆå«ï¼‰çš„ç¾è¡£ã€‚", 5000);
    //   return
    // }else{
    //   switch (postitem.index) {
    //     case 0:
    //         this.showToast("æ¯æ—¥èµ é€1æ¬¡ï¼Œæ€»è®¡10æ¬¡ã€‚", 5000);
    //       break;
    //     case 1:
    //         this.showToast("é™å……å€¼" + vipList[checkIndex].vip_price + "å…ƒåçš„é¦–æ¬¡æç°ï¼Œä»…é™1æ¬¡ã€‚", 5000);
    //       break;
    //   }
    // }


    this.showToast(postitem.wenContent, 5000);
    wen


  },
  bindLeftJiantou: function() {

    checkIndex--;
    if (checkIndex < 0) {
      checkIndex = vipList.length - 1
    }
    this.setData({
      nowIdx: checkIndex,
      current: checkIndex
    })
  },
  bindRightJiantou: function() {

    checkIndex++;
    if (checkIndex > vipList.length - 1) {
      checkIndex = 0
    }
    this.setData({
      nowIdx: checkIndex,
      current: checkIndex
    })
  },

  //é‚€è¯·å‘è´§ï¼ˆVIPï¼‰
  toInviteFriends: function() {
    loginClick = 1;
    if (app.globalData.user) {
      wx.navigateTo({
        url: '/pages/sign/InviteFriendsFreeShop/InviteFriendsFreeShop'
      })

    }


    // checkIndex--;
    // if (checkIndex < 0) {
    //   checkIndex = 5
    // }
    // this.setData({
    //   nowIdx: checkIndex,
    //   current: checkIndex
    // })



  },
  //æˆæƒå¼¹çª—
  onclick: function(e) {

    var that = this;

    wx.getUserInfo({
      //å…è®¸æˆæƒ è·å–ç”¨æˆ·ä¿¡æ¯
      success: function(res) {
        if (!app.globalData.user) {
          that.globalLogin(); //é‡æ–°ç™»å½•
        }else{
          if (app.globalData.user != null && app.globalData.user.user_id != undefined) {

            var showendofpromotionDialog = app.globalData.user.showSpecialPage != 1 ? true : false;
            that.setData({
              showendofpromotionDialog: showendofpromotionDialog
            })
            if (that.data.showendofpromotionDialog){
              wx.setStorageSync("comefrom", 'showendofpromotionDialog_vip');
              wx.switchTab({
                url: '/pages/shouye/shouye?comefrom=showendofpromotionDialog',
              })
            }
          }
        }
      },
      fail: function() {

      }
    })
  },
  //è‡ªåŠ¨ç™»å½•
  globalLogin: function() {
    var that = this;
    wx.showLoading({
      title: 'è¯·ç¨å',
      mask: true,
    })
    util.autoLogin(loginCount, function(loginfailYiFuShow, login_discribution, login_buttontitle, newloginCount) {
      wx.hideLoading();
      loginCount = newloginCount;
      if (loginCount == 1) //ç™»å½•æˆåŠŸ
      {
        var showendofpromotionDialog = app.globalData.user.showSpecialPage != 1 ? true : false;
        that.setData({
          showLoginDialog: false,
          showendofpromotionDialog: showendofpromotionDialog
        })

        if (app.globalData.user != null && app.globalData.user.user_id != undefined && that.data.showendofpromotionDialog) {
          wx.setStorageSync("comefrom", 'showendofpromotionDialog_vip');
          wx.switchTab({
            url: '/pages/shouye/shouye?comefrom=showendofpromotionDialog',
          })
          return;
        } else if (app.globalData.user && app.globalData.user.userToken == undefined && app.globalData.channel_type == 1) {
          that.showToast('ä¸ç¬¦åˆæ¡ä»¶', 2000);
          return;
        }


        if (loginClick == 1) {
          wx.navigateTo({
            url: '/pages/sign/InviteFriendsFreeShop/InviteFriendsFreeShop'
          })
          loginClick = 0
        }
        that.initVipData(-1);
        util.get_vip_tofreelingPage2();//æœ‰79å…ƒå…è´¹é¢†æœªé¢†å–è‡ªåŠ¨è·³è½¬å…è´¹é¢†åˆ—è¡¨é¡µ2
      } else {
        that.showToast('ä¸ç¬¦åˆæ¡ä»¶', 2000);
      }

    })
  },
  closeInviteFriends: function() {
    this.setData({
      showInviteFriends: false
    })
  },
  txTishiTap: function() {

    if (vipList[checkIndex].vip_type == 7 || vipList[checkIndex].vip_type == 8 || vipList[checkIndex].vip_type == 9) {
      this.showToast("å®Œæˆæ¯æ—¥çš„èµšé’±ä»»åŠ¡å³æ‰“å¡æˆåŠŸã€‚æ–°äººç´¯è®¡æ‰“å¡15æ—¥å¯é¢†" + vipList[checkIndex].return_money + "å…ƒç°é‡‘ã€‚", 5000);
      return
    }

    if (checkCardHave) {
      this.setData({
        showTXtishi: true
      })
    } else {

      wx.navigateTo({
        url: '/pages/mine/addMemberCard/memberDiscription?'

          // ä¸‹å•ç”¨
          +
          "vip_type=" + vipList[checkIndex].vip_type //ä¼šå‘˜ç±»å‹
          +
          "&vip_count=" + vip_count //ä¼šå‘˜æ•°é‡

          // å±•ç¤ºç”¨
          +
          "&vip_name=" + vipList[checkIndex].vip_name //ä¼šå‘˜åç§°
          +
          "&vip_price=" + vipList[checkIndex].vip_price //é¢„å­˜299å…ƒ å’Œ 299å…ƒä¹Ÿå¯å…¨é¢ç”¨äºè´­ä¹°å•†å“
          +
          "&pay_price=" + choosePayPrice //åº•éƒ¨æ”¯ä»˜ä»·æ ¼
          +
          "&punch_days=" + vipList[checkIndex].punch_days //120å¤©
          +
          "&return_money=" + vipList[checkIndex].return_money //æ‰“å¡è¿”è¿˜400å…ƒ
          +
          "&price_section=" + vipList[checkIndex].price_section //1ä»¶299å…ƒç¾è¡£

          +
          "&one_price=" + one_price //å•å¼ ä¼šå‘˜å¡ä»·æ ¼
          ,
      })
    }

  },
  colseShowTXtishi: function() {
    this.setData({
      showTXtishi: false,
      showTixiankaDialog: false,
      showTXKkaitongdialog: false,
      showBuQaunZaunShi: false,


    })
  },
  dialog_close: function() {
    this.setData({
      showBuQaunZaunShi: false
    })
  },
  /**
   * ç”Ÿå‘½å‘¨æœŸå‡½æ•°--ç›‘å¬é¡µé¢åˆæ¬¡æ¸²æŸ“å®Œæˆ
   */
  onReady: function() {

  },

  /**
   * ç”Ÿå‘½å‘¨æœŸå‡½æ•°--ç›‘å¬é¡µé¢æ˜¾ç¤º
   */
  onShow: function() {

    var that = this;

    if (!isvip_paysuccess) {
      util.get_vip_tofreelingPage2();//æœ‰79å…ƒå…è´¹é¢†æœªé¢†å–è‡ªåŠ¨è·³è½¬å…è´¹é¢†åˆ—è¡¨é¡µ2
    }
    
    //å¤§ä¿ƒé”€å·²ç»“æŸ
    if (app.globalData.user != null) {
      var showendofpromotionDialog = app.globalData.user.showSpecialPage != 1 ? true : false;
      this.setData({
        showMainPage: true,
        showendofpromotionDialog: showendofpromotionDialog
      })
    } else {
      this.setData({
        showMainPage: true,
        showendofpromotionDialog: true
      })
    }

    if (wx.getStorageSync("payvipCardSuccess")) {
      // this.showToast("è´­ä¹°æˆåŠŸï¼Œä¼šå‘˜å¡æƒç›Šå·²å¼€é€šï¼Œç¥æ‚¨è´­ç‰©æ„‰å¿«ã€‚", 5000);
      wx.setStorageSync("payvipCardSuccess", "")
      // this.initVipData(kaiKaVipType);

      paySucDialogData = wx.getStorageSync("paySucDialogData");

      //é“å…·å¡å’Œç¬¬1ç¬¬2å¼ é’»çŸ³å¡æç¤ºæ˜¯å¼¹çª—
      if (paySucDialogData) {

        that.setData({
          paySucDialogData: paySucDialogData,
          showPaySuccessDialog: true
        })

      } else {
        that.showToast("è´­ä¹°æˆåŠŸï¼Œä¼šå‘˜å¡æƒç›Šå·²å¼€é€šï¼Œç¥æ‚¨è´­ç‰©æ„‰å¿«ã€‚", 5000);
      }

      setTimeout(function() {
        that.initVipData(kaiKaVipType);
      }, 1000)
      return;

    }

    var that = this;
    wx.onUserCaptureScreen(function (res) {
      var pages = getCurrentPages() //è·å–åŠ è½½çš„é¡µé¢
      var currentPage = pages[pages.length - 1] //è·å–å½“å‰é¡µé¢çš„å¯¹è±¡
      if (currentPage.route == "pages/mine/addMemberCard/addMemberCard") {
        console.log('â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦ç”¨æˆ·æˆªå±äº†')
        setTimeout(function () {
          that.showModal();
        }, 1000)
      }
    })
  },

  /**
   * ç”Ÿå‘½å‘¨æœŸå‡½æ•°--ç›‘å¬é¡µé¢éšè—
   */
  onHide: function() {
    isvip_paysuccess = false;
  },

  /**
   * ç”Ÿå‘½å‘¨æœŸå‡½æ•°--ç›‘å¬é¡µé¢å¸è½½
   */
  onUnload: function() {
    isvip_paysuccess = false;
  },

  /**
   * é¡µé¢ç›¸å…³äº‹ä»¶å¤„ç†å‡½æ•°--ç›‘å¬ç”¨æˆ·ä¸‹æ‹‰åŠ¨ä½œ
   */
  onPullDownRefresh: function() {

  },

  /**
   * é¡µé¢ä¸Šæ‹‰è§¦åº•äº‹ä»¶çš„å¤„ç†å‡½æ•°
   */
  onReachBottom: function() {

  },


  // æ˜¾ç¤ºé®ç½©å±‚
  showModal: function () {
    var that = this;
    that.setData({
      hideModal: false
    })
    var animation = wx.createAnimation({
      duration: 600,//åŠ¨ç”»çš„æŒç»­æ—¶é—´ é»˜è®¤600ms   æ•°å€¼è¶Šå¤§ï¼ŒåŠ¨ç”»è¶Šæ…¢   æ•°å€¼è¶Šå°ï¼ŒåŠ¨ç”»è¶Šå¿«
      timingFunction: 'ease',//åŠ¨ç”»çš„æ•ˆæœ é»˜è®¤å€¼æ˜¯linear
    })
    this.animation = animation
    setTimeout(function () {
      that.fadeIn();//è°ƒç”¨æ˜¾ç¤ºåŠ¨ç”»
    }, 200)
  },

  // éšè—é®ç½©å±‚
  hideModal: function () {
    var that = this;
    var animation = wx.createAnimation({
      duration: 800,//åŠ¨ç”»çš„æŒç»­æ—¶é—´ é»˜è®¤800ms   æ•°å€¼è¶Šå¤§ï¼ŒåŠ¨ç”»è¶Šæ…¢   æ•°å€¼è¶Šå°ï¼ŒåŠ¨ç”»è¶Šå¿«
      timingFunction: 'ease',//åŠ¨ç”»çš„æ•ˆæœ é»˜è®¤å€¼æ˜¯linear
    })
    this.animation = animation
    that.fadeDown();//è°ƒç”¨éšè—åŠ¨ç”»   
    setTimeout(function () {
      that.setData({
        hideModal: true
      })
    }, 500)//å…ˆæ‰§è¡Œä¸‹æ»‘åŠ¨ç”»ï¼Œå†éšè—æ¨¡å—

  },

  //åŠ¨ç”»é›†
  fadeIn: function () {
    this.animation.translateY(0).step()
    this.setData({
      animationData: this.animation.export()//åŠ¨ç”»å®ä¾‹çš„exportæ–¹æ³•å¯¼å‡ºåŠ¨ç”»æ•°æ®ä¼ é€’ç»™ç»„ä»¶çš„animationå±æ€§
    })
  },
  fadeDown: function () {
    this.animation.translateY(600).step()
    this.setData({
      animationData: this.animation.export(),
    })
  },

  //ç‚¹å‡»åé¦ˆå†…å®¹
  itemtap: function (e) {
    var clciktext = e.currentTarget.dataset.id;
    if (clciktext == "åé¦ˆä¸æŠ•è¯‰") {
      console.log('clciktext=', clciktext);
      this.setData({
        hideModal: true
      })
      wx.navigateTo({
        url: '/pages/mine/Complaint/Complaint?path=/addMemberCard/addMemberCard',
      })
    }
  },

  //æŠ•è¯‰åˆ†äº«
  complain_shareTap: function () {
    this.setData({
      hideModal: true
    })
  },
  /**
   * ç”¨æˆ·ç‚¹å‡»å³ä¸Šè§’åˆ†äº«
   */
  onShareAppMessage: function() {
    var that = this;

    var path = '';
    if (app.globalData.user != null && app.globalData.user.user_id != undefined) {
      path = '/pages/mine/addMemberCard/addMemberCard?' + "isShareFlag=true" + "&user_id=" + app.globalData.user.user_id + "&memberComefrom=mine";
    } else {
      path = '/pages/mine/addMemberCard/addMemberCard?' + "isShareFlag=true" + "&memberComefrom=mine";
    }

    return {

      title: 'ğŸ‘‰ç‚¹æˆ‘ç«‹å³å¼€é€šVIPä¼šå‘˜',
      path: path,
      imageUrl: that.data.Upyun + '/small-iconImages/heboImg/share_newestbuyMember.png',
      success: function(res) {
        // è½¬å‘æˆåŠŸ
        this.showToast('åˆ†äº«æˆåŠŸ', 2000);
      },
      fail: function(res) {
        // è½¬å‘å¤±è´¥
        this.showToast('åˆ†äº«å¤±è´¥', 2000);
      }
    }
  }
})