import config from '../../../config';
import ToastPannel from '../../../common/toastTest/toastTest.js';
//è·å–æœ¬åœ°åŒ–æ•°æ®
// var postdata = require('../../../data/shouyedata.js');
var app = getApp();
var token = null;
var publicUtil = require('../../../utils/publicUtil.js');
var showHongBao = require('../../../utils/showNewuserHongbao.js');
var util = require('../../../utils/util.js');
var WxNotificationCenter = require('../../../utils/WxNotificationCenter.js');
//æµè§ˆä»¶æ•°ç›¸å…³//
var firstCome; //ç¬¬ä¸€æ¬¡æ»‘åˆ°åº•æ—¶å€™ é˜²æ­¢æ¥å›æ»‘åŠ¨è®¡ç®—æ¬¡æ•°
var firstFresh;//ç¬¬ä¸€æ¬¡åˆ·æ–°
var isForceLook;
var isForceLookLimit;
var xShop_complete;
var task_type;
var xShop_signIndex;
var xShop_doValue;
var xShop_doNum;
var xShop_jiangliName;
var xShop_jiangliValue;
var xShop_shopsName;
var singvalue;
var shop_type; //1æ™®é€šå•†å“ 2ç‰¹ä»·å•†å“ 3ç‰¹ä»·å¹¿å‘Šå•†å“ 4æ­£ä»·å¹¿å‘Šå•†å“
//æµè§ˆä»¶æ•°ç›¸å…³//
var isActiveShop = false; //è™šæ‹Ÿæ˜¯å¦æ´»åŠ¨å•†å“
var isFight = false; //æ˜¯å¦å‚å›¢
var total_micro_second; //å¼€å›¢å‰©ä½™æ—¶é—´
var cutdown_total_micro_second; //å€’è®¡æ—¶æ—¶é—´

var buttonClcik; //1åˆ†äº« 2å•ç‹¬è´­ä¹° 3ç–¯æŠ¢ 4æœ€çˆ±
var formId;
var loginCount;
var oneYuanData = 0;//0æ˜¯1å…ƒè´­
var xuanfuanimationMiddleHeaderItem;
var shop_likeClick = false;
var moneyTixianShowCount = 0;
var animationTimer;
var redhongbaonotshow;
var redhongbaopopTimer;
var redhongbaoCutdoenTimer;
var countdownTimer;
Page({

  data: {
    uppertittle: 'æ¸©é¦¨æç¤º',
    upperdistribution: "æœ¬å•†å“ä¸ºç‰¹ä»·å•†å“ï¼Œå®Œæˆ1ä¸ªè¡£è èµšé’±å°ä»»åŠ¡å³å¯ä»¥ç‰¹ä»·è´­ä¹°ã€‚æ›´äº«å—0å…ƒè´­ç‰¹æƒï¼Œè´­ä¹°ç¾è¡£è¿”è¿˜å…¨éƒ¨è´­è¡£æ¬¾å…¥è´¦æˆ·ä½™é¢",
    upperbuttontitle: "å»è¡£è èµšé’±å°ä»»åŠ¡èµšé’±",

    loginupperdistribution: "éœ€è¦æ‚¨çš„æˆæƒæ‰èƒ½æ­£å¸¸ä½¿ç”¨å“¦ï¼",
    loginupperbuttontitle: "æˆæƒç™»å½•",
    isUpperNotitle: true,

    contactMsgPath: "", //å¡ç‰‡æ¶ˆæ¯è·¯å¾„

    picLink: '', //æ‹¼æ¥äº†åˆç›˜äº‘å’Œå•†å“ç¼–å·çš„é“¾æ¥
    shop_code: '',
    showDialog: false,
    noDataFlag: true,
    starCount: 0,
    postlist: {},
    evaluateList: {},
    evaluateData: [], //è¯„ä»·æ•°æ®é›†åˆ
    shop_attr: '', //å•†å“å±æ€§æ‹¼æ¥å­—ç¬¦ä¸²
    sizeData: [], //å•†å“å°ºç æ•°æ®
    strShopTag: '', //è¯¥å•†å“å•†å“æ ‡ç­¾å­—ç¬¦ä¸²
    shopTagData: [], //å•†å“æ ‡ç­¾æ•°æ®
    shopAttrData: [], //å•†å“å±æ€§æ•°æ®
    stockTypeData: [], //å•†å“åº“å­˜åˆ†ç±»è¡¨
    stockColorData: [], //å•†å“åº“å­˜é¢œè‰²
    stockSizeData: [], //å•†å“åº“å­˜å°ºå¯¸
    stockPicData: [], ////å•†å“åº“å­˜å›¾ç‰‡
    stockNameData: [], //å•†å“å±æ€§å
    stockTitleNameData: [], //å•†å“æ ‡é¢˜å±æ€§å

    selectIndexs: [], //é€‰ä¸­çš„è§’æ ‡
    selectColor_SizeIds: [], //é€‰ä¸­çš„å±æ€§
    stockColorSizeData: [], //å•†å“åº“å­˜é¢œè‰²å°ºå¯¸

    hideModal: true, //æ¨¡æ€æ¡†çš„çŠ¶æ€  true-éšè—  false-æ˜¾ç¤º
    animationData: {},
    length: 0,
    secondimgData: ['complaint_1.png', 'complaint_2.png', 'complaint_3.png'],
    secondtextData: ['å‘é€ç»™æœ‹å‹', 'æ·»åŠ åˆ°æˆ‘çš„å°ç¨‹åº', 'æ·»åŠ åˆ°æ¡Œé¢'],
    thirdimgData: ['complaint_4.png', 'complaint_5.png', 'complaint_6.png', 'complaint_7.png'],
    thirdtextData: ['æµ®çª—', 'è®¾ç½®', 'åé¦ˆä¸æŠ•è¯‰', 'é‡æ–°è¿›å…¥å°ç¨‹åº'],

    stockImage: '',
    stockCount: 0, //åº“å­˜ä¸ªæ•°
    stockPrice: 0, //åº“å­˜ä»·æ ¼
    colorIndex: 0, //é€‰ä¸­çš„é¢œè‰²è§’æ ‡
    sizeIndex: 0, //é€‰ä¸­çš„å°ºå¯¸è§’æ ‡
    coloe_sizeIndex: 0, //é€‰æ‹©çš„é¢œè‰²æˆ–å°ºå¯¸è§’æ ‡
    stock_type_id: '', //åº“å­˜id
    type_data: '', //äºŒçº§ç±»ç›®
    selectColorId: '', //é€‰ä¸­é¢œè‰²id
    selectSizeId: '', //é€‰ä¸­å°ºå¯¸id
    isFirst: "",
    isNew: "",

    buyCount: 1, //è´­ä¹°æ•°é‡
    Upyun: config.Upyun,
    upyconfig: config.Upyun,
    Version: '',
    Channel: "",
    shop: {},
    shop_name: '',
    shop_se_price: '0.0',
    shop_price: '0.0',
    save_money: 0,
    discount: 0.0,
    discount_reduceMoney: 0.0,
    reduceMoney: '0.0', //å·²æŠµæ‰£ä½™é¢
    topData: [],
    activityIndex: 0,
    imagePathData: [], //è¯¦æƒ…å›¾ç‰‡è·¯å¾„é›†åˆ
    shop_pic: '', //è¯¦æƒ…é¡µå›¾ç‰‡é›†åˆ
    eva_count: 0, //è¯„è®ºæ•°
    zeroOrderNum: 0, //0å…ƒè´­è®¢å•æ•°é‡
    progress_color: "100",
    progress_type: '100',
    progress_work: '100',
    progress_cost: '100',
    curPage: 1,
    pageSize: 10,
    strLongTag: '', //é•¿æ ‡ç­¾
    fristShortTag: '', //ç¬¬ä¸€ä¸ªçŸ­æ ‡ç­¾
    screenHeight: 0,
    screenWidth: 0,
    picHeight: 0,
    bigpicHeight: 0,
    listItemHeight: 0,
    listItemWidth: 0,
    is_look: false,
    zeroBuyDialogShowFlag: false,
    moneyDiscountShowFlag: false,
    moneyDiscount: "0.0", //ç´¯è®¡å·²æŠµæ‰£çš„ä½™é¢
    oneYuanDiscriptionTitle: "ä½™é¢æŠµæ‰£è¯´æ˜",
    getYiDouShow: false, //å¦‚ä½•è·å¾—è¡£è±†
    isOneYuanClick: false, //æ˜¯å¦ç‚¹å‡»1å…ƒè´­
    isfreeLingClick: false, //æ˜¯å¦ç‚¹å‡»å…è´¹é¢†
    oneyuanValue: 1,
    wxcx_shop_group_price: 0, //ç‰¹ä»·
    spaceName: "",
    moneyDiscount: {
      tilte: "ä½™é¢æŠµæ‰£è¯´æ˜",
      contentText: "ä½™é¢ä¸ä»…å¯ä»¥æç°ï¼Œè¿˜å¯ä»¥ä¸‹å•æ—¶æŠµæ‰£10%çš„å•†å“ä»·ï¼ˆæ´»åŠ¨å•†å“é™¤å¤–ï¼‰", //ä»»åŠ¡å®Œæˆå¼¹çª— å…·ä½“ç±»å®¹
      leftText: "çŸ¥é“äº†",
      rigthText: "å»èµšä½™é¢",
      shop_like: false,
      shop_likeimage: 'shop_newaddunlike'
    },

    scanTipsShow: false,
    signFinishShow: false, //ä»»åŠ¡å®Œæˆå¼¹çª—æ˜¯å¦æ˜¾ç¤º
    signFinishDialog: {
      top_tilte: "", //ä»»åŠ¡å®Œæˆå¼¹çª— é¡¶éƒ¨æ ‡é¢˜
      tilte: "", //ä»»åŠ¡å®Œæˆå¼¹çª— æ ‡é¢˜
      contentText: "", //ä»»åŠ¡å®Œæˆå¼¹çª— å…·ä½“ç±»å®¹
      leftText: "", //ä»»åŠ¡å®Œæˆå¼¹çª— å·¦è¾¹æŒ‰é’®
      rigthText: "" //ä»»åŠ¡å®Œæˆå¼¹çª— å³è¾¹æŒ‰é’®
    },


    sharePicLink: '',
    isShowShare: false, //åˆ†äº«å¼¹çª—
    isOneShowShare: false, //1å…ƒè´­åˆ†äº«å¼¹çª—
    isOneShowMoney: app.globalData.oneYuanValue > 0 ? app.globalData.oneYuanValue : 1, //
    shareJson: '', //åå°è·å–çš„åˆ†äº«æ ‡é¢˜
    shareTitle: '', //åˆ†äº«å¤„ç†åçš„æ ‡é¢˜
    adData: [], //é¡¶éƒ¨è½®æ’­å¹¿å‘Š
    adDataAll: [], //å…¨éƒ¨å¹¿å‘Š
    isSHowAdFlag: false, //æ˜¯å¦æ˜¾ç¤ºé¡¶éƒ¨å¹¿å‘Šè½®æ’­
    isShowJoinGroup: false, //æ˜¯å¦æ˜¾ç¤ºå‚å›¢
    isShowOpenGroup: false, //æ˜¯å¦æ˜¾ç¤ºå¼€å›¢
    getRandomTempData: [],
    detailHeight: 0,
    isShowRedPacked: false, //æ‚¬æµ®çº¢åŒ…
    isShowFuWuchengluo: false, //æœåŠ¡æ‰¿è¯º
    redHongbaoNewuserShow: false,//15å…ƒæ–°äººçº¢åŒ…
    firstredHongbaoNewuserShow: false,
    shareComeFromRedHongBao:false,
    signAdData: ['sign_ad1.png', 'sign_ad2.png', 'sign_ad3.png', 'sign_ad4.png', 'sign_ad5.png'], //åº•éƒ¨ç­¾åˆ°å›¾ç‰‡é“¾æ¥
    signBottomLink: '',
    isShowSignBottomAd: false,
    isShareFlag: false, //åˆ†äº«å‡ºå»ç›´æ¥è·³è¿›æ¥çš„
    isFreelingShareFlag:false,//åˆ†äº«å…è´¹é¢†
    isFreelingShareCount:3,//å…è´¹é¢†åˆ†äº«æ¬¡æ•°
    fristDistance: 1000,
    startDis: 0,
    endDis: 0,

    recommendTitleData: [],
    recommendListData: [],
    recommendPage: 1,
    recommend_type_name: 'çƒ­å–',
    recommend_type1: '6',
    currentTab: 0, //æ¨èç‚¹å‡»çš„æ¡ç›®

    isShowCustomTv: false,
    isSignActiveShop: false, //trueä»£è¡¨æ´»åŠ¨å•†å“
    haveCounts: 3, //æ´»åŠ¨å•†å“å‰©ä½™ä»¶æ•°

    xuanfu_animationData: {},

    isFixFlag: false,
    isRecommendFix: false,
    recommendLoadFlag: true,
    evaluateLoadMore: true,
    isNewUserShow: false,
    isNewUserFlag: false,
    isOreadyToken: false,

    isSignClose: false, //æ§åˆ¶zhuanqianå¼€å…³

    bottomOneYuan: false, //æ§åˆ¶è´­ä¹°æ–¹å¼
    bottomBtnTv: '0.0',
    bottomBtnTv1: 'èµšï¿¥0.0',
    returnOneText: '1æŠ˜è´­ä¹°',
    bottomOneBtnTv: '0.0',
    bottomOneBtnTv1: "æ‹¼å›¢ç–¯æŠ¢",
    roll_code: '', //å‚å›¢å›¢å·
    open_roll_code: '', //å¼€å›¢å›¢å·
    rnum: '', //æ‹¼å›¢å‰©ä½™äººæ•°
    userPic: '', //å›¢é•¿å¤´åƒ
    fightUserid: '', //å›¢é•¿id
    nowtime: '', //å‚å›¢å½“å‰æ—¶é—´
    timeout: '', //å‚å›¢ç»“æŸæ—¶é—´
    SurplusTime: '', //å‰©ä½™æ—¶é—´

    load_timer: true, //å®šæ—¶å™¨
    start_time: '', //å¼€å§‹æ—¶é—´
    end_time: '', //ç»“æŸæ—¶é—´
    openGroup_outTime: '', //æ—¶åˆ†ç§’
    clock_hr: '', //æ—¶
    clock_min: '', //åˆ†
    clock_ss: '', //ç§’

    fightSuccess_fail_isShow: false,
    upperMemberYiFuShow: false,
    supplementMemberShow: false,
    member_discribution: 'å°Šæ•¬çš„è¡£è ä¼šå‘˜ï¼Œæ‚¨çš„ä¼šå‘˜è´¹å·²è¢«ç”¨äºè´­ä¹°å•†å“ï¼Œè¯·è¡¥è¶³ä¼šå‘˜è´¹ã€‚',
    member_buttontitle: 'è¡¥è¶³ä¼šå‘˜è´¹',
    supply_isShow: false, //æ˜¯å¦å±•ç¤ºå“ç‰Œ
    is_redHongBao: false,
    shouYePage: '',     //å•†å“æ˜¯å¦æ¥è‡ªé¦–é¡µ3
    shop_deduction: 0.9,//å•†å“æŠµæ‰£ç™¾åˆ†æ¯”
    images: {},
    inputInvitNumberIsShow: true,
    contactkefuShow: false,
    guidebecomeMemberShow: false,
    guidebecomeMemberImage: '',
    isShowNOGroup:false,
    fightCount:'4',//å‡ äººæ‹¼å›¢
    isKT:false,//æ˜¯å¦å¼€å›¢
    task_freeling:'',//å…è´¹é¢†ä»»åŠ¡
    swiperlist:['','','',''],
    clickLogin: true,//ç‚¹å‡»çº¢åŒ…æˆæƒ
    is_vip:0,//0ä¸æ˜¯ä¼šå‘˜ >0æ˜¯ä¼šå‘˜
    delivery_time:'',//å‘è´§æ—¶é—´
    freelingpage2_comefrom:'',//ä»å“ªä¸ªç•Œé¢è¿‡æ¥çš„
  },

  onUnload() {
    clearTimeout(redhongbaopopTimer);
    clearTimeout(redhongbaoCutdoenTimer);

    this.setData({
      load_timer: false,
    })
  },

  onHide: function () {
    clearTimeout(redhongbaopopTimer);
    clearTimeout(redhongbaoCutdoenTimer);
    clearTimeout(countdownTimer);
    showHongBao.stoppopTimer(this, function () { })
    wx.hideLoading()
  },
  onLoad: function (option) {
    firstFresh = true;
    loginCount = 0;

    if (option.isShareFlag) {
      this.shareLoginSetting();
      buttonClcik = 0;
      this.globalLogin();
      app.shop_type_tagData();
    }

    if (!app.parent_id) {
      app.parent_id = option.user_id;
    }

    console.log("option.isSign----", option)
    var that = this;
    if (option.user_id && app.globalData.user && app.globalData.user.userToken) {
      util.bindRelationship(option.user_id, app.globalData.user.userToken); //ç»‘å®šç”¨æˆ·ä¸Šä¸‹çº§å…³ç³»
    }
    if (option.user_id) {
      WxNotificationCenter.addNotification("testNotificationItem1Name", function () {
        if (app.globalData.user && app.globalData.user.userToken) {
          util.bindRelationship(option.user_id, app.globalData.user.userToken); //ç»‘å®šç”¨æˆ·ä¸Šä¸‹çº§å…³ç³»
        }
      }, this);
    }
    // if (option.isNewUserFlag) {
    //   this.data.isNewUserFlag = true;
    // }
    if (option.showSignPage) {
      app.globalData.showSignPage = option.showSignPage;
    }

    if (option.homePage3ElasticFrame != undefined && option.homePage3ElasticFrame != 'undefined') {
      this.data.homePage3ElasticFrame = option.homePage3ElasticFrame;
      this.setData({
        redhongbaocanPop: true
      })
    }
    //æ˜¯å¦è™šæ‹Ÿæ´»åŠ¨å•†å“
    if (option.isActiveShop == "true") {
      isActiveShop = true;
      oneYuanData = 1;
    } else {
      isActiveShop = false;
    }
    //æ˜¯å¦æ´»åŠ¨å•†å“ è´§åˆ°ä»˜æ¬¾
    if (option.cashOnDelivery) {
      this.setData({
        cashOnDelivery: option.cashOnDelivery
      })
    }
    // if (option.isSign) { //åˆ†äº«èµ¢æç°
    //   this.data.isNewUserFlag = true;
    // }
    //æ˜¯å¦æ‹¼å›¢ä»»åŠ¡è¿›æ¥
    if (option.isKT){
      this.setData({
        isKT: option.isKT
      })
    }
    //æ˜¯å¦ä»å…è´¹é¢†åˆ—è¡¨é¡µ2è¿‡æ¥çš„
    if (option.freelingpage2_comefrom)
    {
      this.setData({
        isFreelingShareCount:0,
        freelingpage2_comefrom: option.freelingpage2_comefrom
      })
    }
    //èµšé’±ä»»åŠ¡è¿›æ¥çš„
    if (option.comefrom) {
      this.setData({
        comefrom: option.comefrom
      })
      
      //å…è´¹é¢†ä»»åŠ¡è¿›æ¥çš„
      if (option.task_freeling) {
        this.setData({
          task_freeling: option.task_freeling
        })
      }
    }

    if (app.globalData.channel_type == 1)
    {
      this.setData({
        channel_type: app.globalData.channel_type
      })
    }
    
    this.data.isShareFlag = option.isShareFlag;
    // if (option.isShareFlag){
    //   app.shareToHomepage3()

    // }
    shop_type = option.shop_type;

    wx.createSelectorQuery();
    if (option.isSignActiveShop) {
      this.data.isSignActiveShop = option.isSignActiveShop;
    }
    var returnOneText = (option.roll_code && option.is_redHongBao != 'true') ? "ä¸€é”®å‚å›¢" : this.data.returnOneText;
    var returnTwoText = this.data.returnTwoText ? this.data.returnTwoText : (this.data.wxcx_shop_group_price * 1).toFixed(1);
    this.setData({
      isSignActiveShop: this.data.isSignActiveShop,
      bottomOneBtnTv: returnTwoText,
      bottomOneBtnTv1: returnOneText,
      fightbottomOneBtnTv: this.data.assmble_price != undefined ? this.data.assmble_price : '',
      oneyuanValue: this.data.wxcx_shop_group_price,
      typePageHide: option.isShareFlag == true ? 0 : app.globalData.typePageHide,
      isActiveShop: option.isShareFlag == true ? false : isActiveShop,
      supply_isShow: app.showSub,
      isFirst: option.isFirst != undefined ? option.isFirst : '',
      isNew: option.isNew != undefined ? option.isNew : '',
      is_redHongBao: option.is_redHongBao != undefined ? true : false,
      shop_type: shop_type != undefined ? shop_type : 1,
    });

    app.ToastPannel();
    this.redMoney_popCount();
    this.getRcommendTitleData();
    this.hongBaoAnimation();
    var that = this;
    //æ•°æ®åº“åŒæ­¥æˆåŠŸé€šçŸ¥
    WxNotificationCenter.addNotification("shopNotificationItem1Name", function () {
      //è·å–å•†å“ä¸€çº§ç±»ç›®
      that.getRcommendTitleData();
      //åˆ·æ–°è¯¦æƒ…ä¸‹é¢çš„åˆ—è¡¨
      that.data.recommendPage = 1;
      that.getData(5, function (data) {
        that.dealBackData(5, data);
      });
      that.setData({
        isActiveShop: option.isShareFlag == true ? false : isActiveShop,
        typePageHide: option.isShareFlag == true ? 0 : app.globalData.typePageHide
      })
      console.log('^^^^^^^^^^^^^^^^^^^^^isActiveShop', that.data.isActiveShop);
    }, this);

    // //æ˜¯å¦æ˜¯ç¬¬äºŒæ¬¡æŠ½å¥–å›æ¥
    // WxNotificationCenter.addNotification("luckDraw", function(){
    //   util.get_LuckDraw(function (luckDraw) {
    //     if (luckDraw == true) {
    //       that.setData({
    //         upperMemberYiFuShow: true
    //       })
    //     } 
    //   })
    // }, that)

    that.data.shop_code = option.shop_code;

    if (this.data.isSignActiveShop) {
      var count = wx.getStorageSync("ssss" + option.shop_code);
      if (count) {
        this.setData({
          haveCounts: count
        })
      } else {
        var s = Math.floor(Math.random() * 25 + 3);
        wx.setStorageSync("ssss" + option.shop_code, s);
        this.setData({
          haveCounts: s
        });
      }
    }


    var rand = parseInt(Math.random() * 5);
    this.data.signBottomLink = this.data.signAdData[rand];
    if (null != app.globalData.user) {
      token = app.globalData.user.userToken;
    } else {
      token = null;
    }
    this.setData({
      token: token
    })
    isForceLookLimit = option.isForceLookLimit;
    isForceLook = option.isForceLook;
    if (!this.data.isShareFlag) {
      if (null != this.data.token) {
        publicUtil.getBalanceNum(function (isSHow) {
          if (isSHow) {
            that.setData({
              isShowRedPacked: true
            })
          } else {
            that.setData({
              isShowRedPacked: false
            })
          }
        });
      } else {
        this.setData({
          isShowRedPacked: true
        })
      }
    }
    //æµè§ˆXä»¶ä»»åŠ¡
    if (isForceLook || isForceLookLimit) {
      // that.setData({ is_look: true });
      firstCome = true;
      var signTask = wx.getStorageSync("SIGN-TASK");

      xShop_complete = signTask.complete;
      task_type = signTask.task_type;
      xShop_signIndex = signTask.index;
      xShop_doValue = signTask.value;
      xShop_doNum = signTask.num;
      xShop_jiangliName = signTask.jiangliDanWei + signTask.jiangliContent;
      xShop_jiangliValue = signTask.jiangliValue;
      xShop_shopsName = signTask.shopsName;

      try {
        singvalue = parseInt(xShop_doValue.split(",")[1])
      } catch (e) {
        singvalue = parseInt(xShop_doNum);
      }
      var dataString = new Date().toDateString();
      var saveDay = wx.getStorageSync("scanshop_tips_day");
      if (saveDay != dataString) {
        that.setData({
          is_look: false, //ä¾§è¾¹æµè§ˆå…ˆä¸æ˜¾ç¤º
          scanTipsShow: true
        });
        wx.setStorageSync("scanshop_tips_day", dataString);
      } else {
        that.setData({
          is_look: true,
          scanTipsShow: false
        });
      }
    }

    //è¯¦æƒ…ç›¸å…³æ¥å£è°ƒç”¨
    this.setData({
      signBottomLink: this.data.signBottomLink,
      starCount: 5,
      Version: config.Version,
      // Channel: config.ChannelPost,
      activityIndex: 0,

      // topData:
      // [{ name: 'è¯¦æƒ…', },
      // { name: 'å‚æ•°', },
      // { name: 'è¯„ä»·', },
      // ],

      adDataAll: [{
        link: 'icon_duobao_new',
        name: '0å…ƒå›¢è´­',
        award: 'IPHONE X',
        id: 0
      },
      {
        link: 'icon_fenxiangri',
        name: 'è¶…çº§åˆ†äº«æ—¥',
        award: '150å…ƒ/äºº',
        id: 0
      },
      {
        link: 'icon_honbaoyu',
        name: 'åƒå…ƒçº¢åŒ…é›¨ ',
        award: '1000ä¸ª',
        id: 0
      },
      {
        link: 'icon_liulan_sign',
        name: 'æµè§ˆ2åˆ†é’Ÿè¶…å€¼ç‰¹ä»· ',
        award: '5.0',
        id: 1
      },
      {
        link: 'icon_liulan_sign',
        name: 'æµè§ˆ2åˆ†é’ŸSHOWç¤¾åŒº',
        award: '5.0',
        id: 1
      },
      {
        link: 'icon_fenxiang_nom',
        name: 'åˆ†äº«1ä»¶æ—¶å°šç©¿æ­',
        award: '5.0',
        id: 1
      },
      {
        link: 'icon_liulan_sign',
        name: 'æµè§ˆ1åˆ†é’Ÿå†¬è£…ç‰¹å–',
        award: '3.0',
        id: 1
      },
      {
        link: 'icon_liulan_sign',
        name: 'æµè§ˆ2ç¯‡ç©¿æ­è¯é¢˜ ',
        award: '3.0',
        id: 1
      },
      {
        link: 'icon_fenxiang_nom',
        name: 'åˆ†äº«1ä»¶å†¬æ—¥æ¯›è¡£',
        award: '2.0',
        id: 1
      },
      {
        link: 'icon_liulan_sign',
        name: 'æµè§ˆ2ä»¶æ–°æ¬¾å«è¡£',
        award: '3.0',
        id: 1
      },
      {
        link: 'icon_gouwuche_sign',
        name: 'åŠ 1ä»¶å•†å“åˆ°è´­ç‰©è½¦',
        award: '3.0',
        id: 1
      }
      ]
    })
    var that = this;
    if (shop_type == 2 || shop_type == 3) {
      this.setData({
        topData: [{
          name: 'å•†å“è¯¦æƒ…',
        }],
        isShowFuWuchengluo: false,
      })
    } else {
      this.setData({
        topData: [{
          name: 'è¯¦æƒ…',
        },
        {
          name: 'å‚æ•°',
        },
        {
          name: 'è¯„ä»·',
        },
        ],
        isShowFuWuchengluo: true,
      })
    }
    this.getData(0, function (data) {
      that.dealBackData(0, data);
    });
    this.getData(3, function (data) {
      that.dealBackData(3, data);
    });
    this.getDataJson(4, function (data) {
      that.dealBackData(4, data);
    });

    if (app.globalData.user && app.globalData.user.userToken) {
      this.getData(6, function (data) { //å¼€å…³
        that.dealBackData(6, data);
      });
    } else {
      WxNotificationCenter.addNotification("testNotificationItem1Name_isSignClose", function () {
        if (app.globalData.user && app.globalData.user.userToken) {
          that.getData(6, function (data) { //å¼€å…³
            that.dealBackData(6, data);
          });
        }
      }, this);
    }
    this.getTopAdData();
    this.getRawardMoneyStatus();
    // this.get_discountHttp();

    wx.getSystemInfo({
      success: function (res) {
        var picHeight = res.windowWidth * 9 / 6;
        var bigpicHeight = res.windowWidth * 7 / 6;
        var listItemHeight = (res.windowWidth * 9 / 6) * 0.96 * 0.504;
        var listItemWidth = res.windowWidth * 0.96 * 0.504;
        that.setData({
          screenHeight: res.windowHeight,
          screenWidth: res.windowWidth,
          bigpicHeight: bigpicHeight,
          picHeight: picHeight,
          listItemHeight: listItemHeight,
          listItemWidth: listItemWidth,
        });
      }
    });

    if (option.roll_code) {

      this.setData({
        roll_code: option.roll_code,
      })
      isFight = false;
    }
    //æ˜¯å¦æœ‰éä¼šå‘˜ç”¨æˆ·æ‹¼å›¢
    // if (option.unvip_roll_code) {
    //   this.setData({
    //     unvip_roll_code: option.unvip_roll_code,
    //   })
    // }

    //åˆ—è¡¨æ˜¯å¦æ˜¯é¦–é¡µ3
    if (option.shouYePage) {
      this.setData({
        shouYePage: option.shouYePage
      })
    }

  },
  onShow: function (option) {
    var that = this;
    isFight = false;

    var FightSuccess = wx.getStorageSync('FightSuccess');
    //å½“æ˜¯é€€æ¬¾è¯¦æƒ…å›æ¥çš„å¼¹æ‹¼å•æˆåŠŸæç¤ºç”¨æˆ·å»æç°çš„å¼¹çª—
    if (FightSuccess == true) {
      that.getcoupon_http();
    }

    if (firstFresh == false) {
      that.oneYuan_httpData();
    }
    firstFresh = false;

    //å…è´¹é¢†åˆ†äº«æ¬¡æ•°
    if (that.data.isFreelingShareFlag == true)
    {
      if (that.data.isFreelingShareCount <= 1){//4æ¬¡åˆ†äº«å®Œåå³å¯å…è´¹é¢†
        // that.oneBuyClick(); 

        that.setData({
          showDialog: true,
        });
        if (that.data.stockTypeData.length == 0) {
          that.getData(2, function (data) {
            that.dealBackData(2, data);
          });
        } else {
          that.showNewShopStock(that.data.selectIndexs, that.data.selectColor_SizeIds);
        }
      }else{
        that.getShareShop(function(success){
          if(success){
            that.setData({
              isShowShare: true
            })
          }
        });
      }

      that.setData({
        isFreelingShareFlag: false,
        isFreelingShareCount: that.data.isFreelingShareCount - 1,
      })
    }

    //è·å–éä¼šå‘˜ç”¨æˆ·æ‹¼å›¢ä¿¡æ¯
    if (that.data.unvip_roll_code) {
      that.get_unvip_fightInfoHttp();
    }

    if (app.globalData.user != null && app.globalData.user.userToken != undefined) {

    }else{
      if (that.data.shouYePage != 'TwoPage') {
        showHongBao.getShowHongbao(that, function (is_show) {
          if (is_show) {
            that.setData({
              firstredHongbaoNewuserShow: false
            })
          }
        });
      }
    }

    //å¤§ä¿ƒé”€å·²ç»“æŸ
    var showendofpromotionDialog;
    if (app.globalData.user != null) {
      showendofpromotionDialog = app.globalData.user.showSpecialPage != 1 ? true : false;
    } else {
      showendofpromotionDialog = app.globalData.channel_type == 1 ? false : true;
    }
    that.setData({
      showendofpromotionDialog: showendofpromotionDialog
    })

    wx.onUserCaptureScreen(function (res) {
      console.log('â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦ç”¨æˆ·æˆªå±äº†')
      that.showModal();
    })
  },

  //å…è´¹é¢†åˆ†äº«æ•°æ®
  getShareShop: function (callBack) {

    var that = this;

    var dataUrl = config.Host + "shop/shareShop" +
      "?getShop=" + "true" +
      config.Version;
    wx.showLoading({
      title: 'è¯·ç¨å',
      mask: true,
    })
    util.http(dataUrl, function (data) {
      if (data.status == 1) {
        var shop_code = data.shop.shop_code;
        var shop_pic = data.shop.four_pic.split(",")[2];
        var shareP;
        if (data.shop.four_pic) {
          var str = data.shop.four_pic.split(",");
          if (str.length > 2) {
            shareP = str[2];
          }
        }
        var shop_code_cut = '';
        shop_code_cut = shop_code.substring(1, 4);
        var sharePic = that.data.Upyun + shop_code_cut + '/' + shop_code + '/' + shareP;
        var shareTitle = 'ç‚¹å‡»è´­ä¹°ğŸ‘†' + 'ã€' + data.shop.shop_name + 'ã€‘' + "ä»Šæ—¥ç‰¹ä»·" + data.shop.assmble_price + "å…ƒï¼";

        var sharepath = '';
        if (app.globalData.user != null && app.globalData.user.user_id != undefined) {
          sharepath = '/pages/mine/toexamine_test/toexamine_test?shouYePage=ThreePage' + "&isShareFlag=true" + "&user_id=" + app.globalData.user.user_id;
        } else {
          sharepath = '/pages/mine/toexamine_test/toexamine_test?shouYePage=ThreePage' + "&isShareFlag=true";
        }

        that.setData({
          freeling_shareTitle: shareTitle,
          freeling_sharePath: sharepath,
        });

        that.freelinggetCanvasPictiure(sharePic, data.shop.assmble_price,callBack);
      } else
        wx.hideLoading();
    })

  },

  //ç”Ÿæˆåˆ†äº«çš„åˆæˆå›¾ç‰‡
  freelinggetCanvasPictiure: function (imagesrc, price ,callBack) {
    var that = this;

    util.getCanvasPictiure("shareCanvas", imagesrc, price, 'å•†å“åˆ†äº«', function (tempFilePath) {
      wx.hideLoading();
      if (tempFilePath != undefined && tempFilePath != null) {
        that.setData({
          freeling_shareImageUrl: tempFilePath
        })
      } else {
        that.setData({
          freeling_shareImageUrl: imagesrc
        })
      }
      callBack(true);
    })
  },
  //è·å–30å…ƒçº¢åŒ…å¼¹å‡ºæ—¶é—´å’Œæ¬¡æ•°
  redMoney_popCount: function () {
    var that = this;
    var noMemberHomePage3ElasticFrame = wx.getStorageSync('noMemberHomePage3ElasticFrame');
    if ((noMemberHomePage3ElasticFrame != undefined && noMemberHomePage3ElasticFrame != '') || noMemberHomePage3ElasticFrame == '0') {
      this.data.noMemberHomePage3ElasticFrame = noMemberHomePage3ElasticFrame;
      return;
    }
    util.get_shouyeSwitch('', function (swhitchdata) {
      var homePage3ElasticFrame = swhitchdata.homePage3ElasticFrame != undefined ? swhitchdata.homePage3ElasticFrame : '';
      var noMemberHomePage3ElasticFrame = swhitchdata.noMemberHomePage3ElasticFrame != undefined ? swhitchdata.noMemberHomePage3ElasticFrame : '';

      wx.setStorageSync('noMemberHomePage3ElasticFrame', noMemberHomePage3ElasticFrame);
      that.setData({
        homePage3ElasticFrame: homePage3ElasticFrame,
        noMemberHomePage3ElasticFrame: noMemberHomePage3ElasticFrame
      })

    });
  },
  //è·å–æ˜¯å¦æœ‰å…è´¹
  freeText_httpData: function () {
    var that = this;
    var token = "";
    if (app.globalData.user != null) {
      token = app.globalData.user.userToken;
    }
    var url = config.Host + 'shop/query?token=' + token + config.Version + "&code=" + this.data.shop_code;
    util.http(url, that.freeTextData);
  },
  freeTextData: function (data) {
    var that = this;
    if (data.status == 1) {
      var returnTwoText = data.vipFreeText ? data.vipFreeText : (that.data.wxcx_shop_group_price * 1).toFixed(1);
    }
  },
  //è·å–ç”¨æˆ·ç›¸å…³ä¿¡æ¯
  userInfo_httpData: function () {
    var that = this;
    var returnTwoText = "";
    var t = that.data.shop_code ? 2 : 1;
    var page3 = 0;
    // if (that.data.comefrom == 'sign' && ((that.data.shouYePage == 'ThreePage' || that.data.shouYePage == 'FivePage'))){
    //   page3 = 1;
    // }
    //è·å–ä¼šå‘˜ä¿¡æ¯
    util.get_VipUserIfon(that.data.shop_code, t, page3, function (data) {
      if (data.status == 1) {
        var is_buy = data.is_buy != undefined ? data.is_buy : "";
        var vip_type = data.vip_type != undefined ? data.vip_type : "";
        var is_vip = data.isVip != undefined ? data.isVip : "";
        var is_vipPage = data.vip_page != undefined ? data.vip_page : "";
        var first_group = data.first_group != undefined ? data.first_group : "";
        var vip_free = data.vip_free != undefined ? data.vip_free : "";
        var ordervip_free = data.vip_free != undefined ? data.vip_free : "";
        var free_page = data.free_page != undefined ? data.free_page : "";

        if (is_vip > 0) {
          if (that.data.roll_code.length > 0 && that.data.rnum > 0 && that.data.SurplusTime > 0 && !that.data.is_redHongBao) {
            returnTwoText = "å…è´¹å‚å›¢";
          } 
          // else if (is_vip == 1) {
          //   returnTwoText = "ä¼šå‘˜å…è´¹é¢†";
          // }
        }
        else {
          //éä¼šå‘˜ç•Œé¢ ä¸”ä¸æ˜¯æ´»åŠ¨å•†å“ ä¸æ˜¯ç‰¹ä»·å•†å“ ä¸æ˜¯é¦–é¡µ3 æ˜¾ç¤ºä¼šå‘˜å…è´¹é¢† + 2äººæ‹¼å›¢
          // if (shop_type != 2 && shop_type != 3 && that.data.isActiveShop == false && that.data.shouYePage != 'ThreePage') 
          if (that.data.isActiveShop == false && that.data.shouYePage != 'ThreePage') {
            vip_free = '2';//ä¼šå‘˜å…è´¹é¢† + 2äººæ‹¼å›¢
          }
        }


        //å½“æ˜¯ä¼šå‘˜å…è´¹é¢†ã€ç‰¹ä»·å•†å“ã€é¦–é¡µ3å•†å“é»˜è®¤ä¼šå‘˜ç•Œé¢
        // if (vip_free == 1 || shop_type == 2 || shop_type == 3 ||that.data.shouYePage == 'ThreePage')
        if (vip_free == 1 || that.data.shouYePage == 'ThreePage') {
          is_vipPage = '1';//1æ˜¯ä¼šå‘˜é¡µé¢  0ä¸æ˜¯ä¼šå‘˜é¡µé¢ 
        }

        that.setData({
          is_vip: is_vip,//0ä¸æ˜¯ 1æ˜¯
          is_buy: is_buy,
          vip_type: vip_type,
          vip_free: vip_free, //1\2ä¼šå‘˜å…è´¹é¢† 0ä¸æ˜¯ä¼šå‘˜å…è´¹é¢†
          ordervip_free: ordervip_free,//1ä¼šå‘˜å…è´¹é¢† 0ä¸æ˜¯ä¼šå‘˜å…è´¹é¢†
          free_page: free_page,
          is_vipPage: is_vipPage,//1æ˜¯ä¼šå‘˜é¡µé¢  0ä¸æ˜¯ä¼šå‘˜é¡µé¢ 
          first_group: first_group,//å¦æ˜¯é¦–å•ï¼Œ 0ä¸æ˜¯ï¼Œ1æ˜¯
          returnTwoText: returnTwoText
        })
      } else {
        //å½“æ˜¯ç‰¹ä»·å•†å“ é¦–é¡µ3å•†å“é»˜è®¤ä¼šå‘˜ç•Œé¢
        // if (shop_type == 2 || shop_type == 3 || that.data.shouYePage == 'ThreePage')
        if (that.data.shouYePage == 'ThreePage') {
          that.setData({
            is_vip: 0,//0ä¸æ˜¯ 1æ˜¯ 2ä¼šå‘˜å¤±æ•ˆ
            vip_type: '0',
            is_vipPage: '1',//1æ˜¯ä¼šå‘˜é¡µé¢  0ä¸æ˜¯ä¼šå‘˜é¡µé¢ 
          })
        }

        //å½“æ—¶é¦–é¡µ3é»˜è®¤ä¼šå‘˜å…è´¹é¢† 
        if (that.data.shouYePage == 'ThreePage') {
          that.setData({
            vip_free: '1',//ä¼šå‘˜å…è´¹é¢†
          })
        }
        else if (that.data.shouYePage == 'FivePage') {
          that.setData({
            vip_free: '1',//ä¼šå‘˜å…è´¹é¢† + 2äººæ‹¼å›¢
          })
        }
        else if (that.data.isActiveShop == false) {
          that.setData({
            vip_free: '2',//ä¼šå‘˜å…è´¹é¢† + 2äººæ‹¼å›¢
          })
        }
        

        that.setData({
          returnTwoText: returnTwoText
        })
      }

      


      that.get_discountHttp();
    })

    //è·å–ç”¨æˆ·æ˜¯å¦å®Œæˆå½“å¤©ä»»åŠ¡
    var dataUrl = config.Host + "clockIn/clockInTodayByUserId?" + config.Version + "&token=" + token;
    util.http(dataUrl, function (data) {
      if (data.data == 1) {
        that.setData({
          nowDayisDaka:true
        })
      }
    });
  },

  //è·å–æ˜¯å¦æ˜¯ä¸€å…ƒè´­
  oneYuan_httpData: function () {
    var that = this;
    var url = config.Host + 'cfg/on_off_3_7?' + config.Version;
    util.http(url, that.oneYuanData);
  },
  oneYuanData: function (data) {
    var that = this;
    if (data.status == 1) {
      oneYuanData = this.data.isActiveShop ? 1 : 0;
    }

    if (that.data.roll_code.length > 8) {
      that.get_fightInfoHttp(); //å‚å›¢ä¿¡æ¯
    } else {
      that.get_openGroupInfoHttp(); //å¼€å›¢ä¿¡æ¯
    }

    //è·å–ç”¨æˆ·æœ€é«˜ä¼šå‘˜ç­‰çº§
    util.get_vip(function (data) {
      if (data.status == 1) {
        var maxType = data.maxType != undefined ? data.maxType : 999; //ä¼šå‘˜ç­‰çº§

        that.setData({
          max_vipType: maxType,
        })
      }
    });
  },

  //è·å–å‚å›¢ä¿¡æ¯
  get_fightInfoHttp: function () {
    var that = this;
    var token = "";
    if (app.globalData.user != null && app.globalData.user.userToken != undefined) {
      token = app.globalData.user.userToken;
    }
    var oldurl = config.Host + '/order/getRollInfo?' + config.Version + '&token=' + token + '&roll_code=' + that.data.roll_code;
    util.http(oldurl, that.fight_data);

  },
  fight_data: function (data) {
    if (data.status == 1) {
      var isShowJoinGroup = (this.data.roll_code.length > 0 && data.rnum > 0 && data.time > 0 && !this.data.is_redHongBao) ? true : false;
      
      var userid = data.fight_userid;
      var picData = data.userPic;
      var fightcount = data.count;
      var rollNum = data.rollNum;
      var is_twice = data.is_twice;//æ˜¯å¦æœ‰å‚å›¢ 0æ²¡æœ‰ 1æœ‰
      var userPicList = [];
      for (var i = 0; i < fightcount; i++) {
        if (picData[i]) {

          var fdStart = picData[i].indexOf("http");
          if (fdStart == 0)
            picData[i] = picData[i];
          else {
            picData[i] = config.Upyun + picData[i];
          }
          userPicList.push(picData[i]);
        } else {
          userPicList.push('../../../iconImages/icon_question_mark.png');
        }
      }

      var returnOneText = ((this.data.roll_code.length > 0 && data.rnum > 0 && data.time > 0 && !this.data.is_redHongBao) ? "ä¸€é”®å‚å›¢" : this.data.returnOneText);
      var returnTwoText = this.data.returnTwoText ? this.data.returnTwoText : (this.data.wxcx_shop_group_price * 1).toFixed(1);

      this.setData({
        rnum: data.rnum,
        SurplusTime: data.time,
        fightUserid: userid,
        fightCount:data.count,
        userPic: userPicList,
        isShowJoinGroup: isShowJoinGroup,
        rollNum: rollNum,
        is_twice: is_twice
        // bottomOneBtnTv: returnTwoText,
        // bottomOneBtnTv1: returnOneText,
      })

      // if (isFight == true) {
      //   //åœ¨å›¢çŠ¶æ€ç»“æŸï¼ˆå³æ‹¼å›¢æˆåŠŸï¼Œå›¢è¿‡æœŸï¼Œæˆ–è€…äººå·²æ»¡çš„æƒ…å†µä¸‹ï¼‰å‚å›¢çš„äººç‚¹ä¸€é”®å‚å›¢ï¼Œç­‰åŒäºç‚¹æ‹¼å›¢ç–¯æŠ¢ï¼Œç›´æ¥è¿›å…¥æ‹¼å›¢æµç¨‹
      //   this.buyOrder();
      // }


    } else {
      this.showToast(data.message, 2000);
      this.setData({
        bottomOneBtnTv1: this.data.returnOneText,
      })

    }

    this.userInfo_httpData();//è·å–ç”¨æˆ·ä¿¡æ¯
  },

  //è·å–éä¼šå‘˜ç”¨æˆ·æ‹¼å›¢ä¿¡æ¯
  get_unvip_fightInfoHttp: function () {
    var that = this;
    var token = "";
    if (app.globalData.user != null && app.globalData.user.userToken != undefined) {
      token = app.globalData.user.userToken;
    }
    var oldurl = config.Host + '/order/getRollInfo?' + config.Version + '&token=' + token + '&roll_code=' + that.data.unvip_roll_code;
    util.http(oldurl, that.unvip_fight_data);

  },
  unvip_fight_data: function (data) {
    var that = this;
    if (data.rnum <= 0 || data.time <= 0 || data.status != 1)//å¦‚æœæ‹¼å›¢æ—¶é—´è¿‡æœŸæˆ–è€…äººæ•°æ»¡roll_codeç½®ç©º
    {
      that.data.unvip_roll_code = '';
    }
  },
  //è·å–å¼€å›¢ä¿¡æ¯
  get_openGroupInfoHttp: function () {
    var that = this;
    var token = "";
    if (app.globalData.user != null && app.globalData.user.userToken != undefined) {
      token = app.globalData.user.userToken;
    }
    var oldurl = config.Host + '/order/getUserRollOrder?' + config.Version + '&token=' + token;
    util.http(oldurl, that.open_data);
  },
  open_data: function (data) {
    if (data.status == 1 ) {    
      
      var userPicList = [];
      if(data.userPic != undefined)
      {
        var picData = data.userPic;
        for (var i = 0; i < this.data.fightCount; i++) {
          if (picData[i]) {
            userPicList.push(picData[i]);
          } else {
            userPicList.push('../../../iconImages/icon_question_mark.png');
          }
        }
      }
      //é€šæ ä¸æ˜¯ä¼šå‘˜æƒ…å†µä¸‹æ˜¾ç¤º å¦‚æœæ˜¯ä¼šå‘˜ä¸”æ˜¯å¼€å›¢ä¹Ÿå¯æ˜¾ç¤º
      var isShowOpenGroup = false;
      if (data.roll_code && this.data.shouYePage != 'FivePage')
      {
        if (data.is_vip > 0 && data.is_vip != 3)
        {
          if(this.data.isKT)
          {
            isShowOpenGroup = true
          }
        }else{
          isShowOpenGroup = true
        }
      }
      this.setData({
        isShowOpenGroup: isShowOpenGroup,
        userPic: userPicList,
        start_time: data.stratTime != undefined ? data.stratTime:"",
        end_time: data.endTime != undefined ? data.endTime:'',
        SurplusTime: data.time != undefined ? data.time:'',
        fightCount: data.count != undefined ? data.count:'',
        open_roll_code: data.roll_code != undefined ? data.roll_code:'',
        shortCount: data.rnum != undefined ? data.rnum:'',
        isShowNOGroup: (data.rollNum == 0 && this.data.shouYePage != 'FivePage' && data.is_vip == 0)?true:false
      });

      var NowTime = Number(this.data.start_time) || [];
      var EndTime = Number(this.data.end_time) || [];
      total_micro_second = this.data.SurplusTime || [];
      total_micro_second = total_micro_second*1.8;
      this.countdown();
    }
    this.userInfo_httpData();//è·å–ç”¨æˆ·ä¿¡æ¯
  },

  //è·å–è™šæ‹Ÿæ‹¼å›¢æ•°æ®
  getFictitiousDatas:function(){
    var fictitiousPic = [];
    var success_groupPic = {};
    var fail_groupPic = {};

    for(var i=0; i<100; i++)
    {
      var userPic = [];
      for(var j=0; j<4;j++)
      {
        userPic.push(config.Upyun + "defaultcommentimage/" + util.getDefaultImg()); 
      }
      success_groupPic['userPic'] = userPic;
      success_groupPic['success'] = true;

      fictitiousPic.push(success_groupPic);
    }

    for(var k=0; k<10;k++)
    {
      var userPic = [];
      for (var j = 0; j < 4; j++) {
        if (j == 3) {
          userPic.push('../../../iconImages/icon_question_mark.png');
        } else {
          userPic.push(config.Upyun + "defaultcommentimage/" + util.getDefaultImg());
        }
      }

      var num = Math.floor(Math.random() * (0 - 99) + 99);
      var dic = fictitiousPic[num];
      dic.userPic = userPic;
      dic.success = false;

      // fictitiousPic[num] = dic;

      // fictitiousPic[num].userPic = userPic;
      // fictitiousPic[num].success = false;
    }

    total_micro_second = 10*60*1000;
    this.countdown();
    this.setData({
      swiperlist: fictitiousPic
    })
  },
  //æ‹¼å›¢å€’è®¡æ—¶
  countdown: function () {
    var that = this;

    that.dateformat(total_micro_second);
    if (total_micro_second <= 0 || this.data.load_timer == false) {

      //æ—¶é—´æˆªè‡³
      that.setData({
        clock_hr: "00",
        clock_min: "00",
        clock_ss: "00",
        isShowOpenGroup: false,
        openGroup_outTime: '00' + ':' + '00' + ':' + '00'
      });
      return;
    }

    countdownTimer=setTimeout(function () {
      total_micro_second -= 1000;
      that.countdown();
    }, 555)
  },

  dateformat: function (micro_second) {

    var that = this;
    // æ€»ç§’æ•°
    var second = Math.floor(micro_second / 1000);

    // å¤©æ•°
    var day = "" + Math.floor(second / 3600 / 24);
    // å°æ—¶
    var hr = "" + Math.floor(second / 3600 % 24);
    // åˆ†é’Ÿ
    var min = "" + Math.floor(second / 60 % 60);
    // ç§’
    var sec = "" + Math.floor(second % 60);

    if (hr.length < 2) {
      hr = '0' + hr;
    }

    if (min.length < 2) {
      min = '0' + min;
    }

    if (sec.length < 2) {
      sec = '0' + sec;
    }
    var openGroup_outTime = hr + ':' + min + ':' + sec;

    that.setData({
      clock_hr: hr,
      clock_min: min,
      clock_ss: sec,
      openGroup_outTime: openGroup_outTime,
    });
  },

  invitFriendTap: function () {
    wx.navigateTo({
      url: '../fightDetail/fightDetail?' + "code=" + this.data.open_roll_code + "&isFromDetail=" + true,
    })
  },
  fictitiousinvitFriendTap:function(){
    var that = this;
    wx.showLoading({ title: 'è¯·ç¨å', mask: true, })
    setTimeout(function () {
      wx.hideLoading();
      that.showToast('è¯¥å›¢å·²æ»¡',2000);
    }, 1000);
  },
  getRcommendTitleData: function () {
    var basesData = wx.getStorageSync("shop_tag_basedata");
    var titleDataTemp = [];
    var recommendTitleData = [];
    if (basesData) {
      titleDataTemp = basesData.data.shop_type;
    }
    if (titleDataTemp) {
      for (var i = 0; i < titleDataTemp.length; i++) {
        if (titleDataTemp[i].parent_id == 0 && titleDataTemp[i].is_show == 1) {
          var str = (titleDataTemp[i].ico).split(',')[0];
          var str1 = str.split('/')[2].split('.')[0];
          titleDataTemp[i]['link'] = this.data.Upyun + 'small-iconImages/zzq/' + str1;
          recommendTitleData.push(titleDataTemp[i]);
        }
      }
    }
    var by = function (name) { //æ•°ç»„æ’åºå‡½æ•°
      return function (o, p) {
        var a, b;
        if (typeof o === "object" && typeof p === "object" && o && p) {
          a = parseInt(o[name]);
          b = parseInt(p[name]);
          if (a === b) {
            return 0;
          }
          if (typeof a === typeof b) {
            return a < b ? -1 : 1;
          }
          return typeof a < typeof b ? -1 : 1;
        } else {
          throw ("error");
        }
      }
    }
    recommendTitleData.sort(by("sequence"));
    this.setData({
      recommendTitleData: recommendTitleData,
    })
    if (recommendTitleData.length > 0) {
      this.data.recommend_type_name = recommendTitleData[0].type_name;
      this.data.recommend_type1 = recommendTitleData[0].id;
    }

  },
  dealBackData(flag, data) { //å¤„ç†æ¥å£è¿”å›çš„æ•°æ®
    var that = this;
    if (flag == 0) {
      console.log('^^^^^^^^^^^^^^^^^^^^^^è¯¦æƒ…æ•°æ®=' + data);

      if (data.status != 1) {
        this.setData({
          noDataFlag: true
        });
        this.showToast(data.message, 2000);
      } else {
        this.setData({
          noDataFlag: false
        });
        if (shop_type != 2 && shop_type != 3) {
          that.data.topData[2].name = 'è¯„ä»·(' + data.eva_count + ')';
          this.setData({
            eva_count: data.eva_count
          });
        }
        var path = "detail?shop_code=" + data.shop.shop_code;

        //æŸ¥è¯¢è¯¥ä»¶å•†å“æ˜¯å¦åŠ è¿‡å–œå¥½
        var shop_like = false;
        var shop_likeimage = "shop_newaddunlike";
        var like_id = data.like_id;
        if (like_id) {
          shop_like = like_id == that.data.shop_code ? true : false;
          shop_likeimage = like_id == that.data.shop_code ? "shop_newaddlike" : "shop_newaddunlike";
        }

        that.setData({
          postlist: data,
          shop: data.shop,
          shop_name: data.shop.shop_name,
          shop_pic: data.shop.shop_pic,
          // eva_count: data.eva_count,
          // zeroOrderNum: data.zeroOrderNum,
          topData: that.data.topData,
          shop_attr: data.shop.shop_attr,
          shopAttrData: data.attrList,
          strShopTag: data.shop.shop_tag,
          returnOneText: data.returnOneText,
          // returnTwoText: data.vipFreeText,
          // wxcx_shop_group_price: data.shop.wxcx_shop_group_price,
          wxcx_shop_group_price: data.shop.assmble_price,
          oneyuanValue: data.shop.wxcx_shop_group_price,
          contactMsgPaht: path,
          showShopData: true,
          memberdiscount: data.discount != undefined ? data.discount : '',
          shop_likeimage: shop_likeimage,
          shop_like: shop_like,
          assmble_price: data.shop.assmble_price,
          delivery_time: data.shop.advance_sale_days,
        })

        this.cutShopCode();
        this.ForDight();
        this.getImagePath();
        this.getShopAttrData();
        this.getShopTagData();
        this.toshareData(false);

        // var animation2 = wx.createAnimation({
        //   duration: 1000,
        //   timingFunction: 'ease',
        // })
        // animation2.translateX(-50).opacity(1).step()
        // that.setData({
        //   animationData: animation2.export()
        // })
        setTimeout(function () {
          that.setData({
            isShowCustomTv: true,
          });
          var animation = wx.createAnimation({
            duration: 500,
            timingFunction: 'ease',
            delay: 5000,
          })
          animation.translateX(50).opacity(0).step()
          that.setData({
            xuanfu_animationData: animation.export()
          })
        }, 2000);

        setTimeout(function () {
          that.setData({
            isShowCustomTv: false,
          });
        }, 8000);
      }
      // this.get_discountHttp();
      this.oneYuan_httpData();
      this.queryMultipleNodes();
    } else if (flag == 1) {
      var dealData = that.dateFormat(data.comments);
      for (var i = 0; i < dealData.length; i++) {
        var pic = dealData[i].pic;
        var picData = [];
        if (pic != null && '' != pic) {
          picData = pic.split(",");
          dealData[i]['pic_data'] = picData;
        }
        try {
          if (dealData[i].suppComment != undefined && dealData[i].suppComment != null) {
            dealData[i]['frist_replay'] = (dealData[i].suppComment)[0].supp_content;
          }
          if (dealData[i].suppEndComment != undefined && dealData[i].suppEndComment != null) {
            dealData[i]['second_replay'] = (dealData[i].suppEndComment)[0].supp_content;
          }
          if (dealData[i].comment != undefined && dealData[i].comment != null) {
            dealData[i]['second_judge'] = (dealData[i].comment)[0].content;
            var pic2 = (dealData[i].comment)[0].pic;
            var picData2 = [];
            if (pic2 != null && '' != pic2 && pic2 != undefined) {
              picData2 = pic2.split(",");
              dealData[i]['pic_data2'] = picData2;
            }
          }
        } catch (e) {

        }
      }
      that.setData({
        evaluateData: dealData,
      })
    } else if (flag == 2) {
      that.data.stockTypeData = data.stocktype;
      // this.getStockTypeSizeColor();
      this.getNewStockTypeSizeColor();
    } else if (flag == 3) {
      var sharePicLink;
      if (data.data == undefined || data.data.pic == undefined) {
        sharePicLink = that.data.Upyun + "small-iconImages/zzq/icon_share_defalut.png";
      } else {
        sharePicLink = that.data.Upyun + data.data.pic;
      }
      that.setData({
        sharePicLink: sharePicLink,
      })
    } else if (flag == 4) { //è·å–åˆ†äº«æ–‡æ¡ˆ
      that.data.shareJson = data.wxcx_wxdddfx.title;
    } else if (flag == 5) { //è·å–æ¨èåˆ—è¡¨
      if (data.status == 1) {
        var isVip = data.isVip != undefined ? data.isVip : '';
        // this.data.is_vipPage = isVip;

        if (this.data.recommendPage == 1) {
          this.data.recommendListData = [];
        }
        var page = this.data.recommendPage + 1;
        this.data.recommendPage = page;
        this.newshoplist(data.listShop);
      } else {
        this.showToast(data.message, 2000);
      }
      this.data.recommendLoadFlag = true;
    } else if (flag == 6) { //å¼€å…³ï¼Œæ§åˆ¶zhuanqianå…¥å£
      // console.log("%%%%%%%%%%%%%%", data)
      if (data.data == 0) {
        // var paymoney = (this.data.shop.shop_se_price - this.data.reduceMoney).toFixed(1);

        var paymoney = this.get_discountPrice(this.data.shop.shop_se_price, this.data.reduceMoney);
        var rawardMoney = this.data.shop.shop_se_price * 0.5 > 50 ? 50 : this.data.shop.shop_se_price * 0.5;
        this.setData({
          isSignClose: true,
          bottomBtnTv: (paymoney > 0 ? paymoney : 0.01),
          bottomBtnTv1: 'èµšï¿¥' + rawardMoney.toFixed(1),
        })
      } else {
        if (this.data.isShareFlag) {
          this.setData({
            isShowRedPacked: true
          })
        }
      }
    }
  },
  newshoplist: function (obj) {
    for (var i = 0; i < obj.length; i++) {
      var new_clde = obj[i].shop_code.substr(1, 3);
      var new_pic = new_clde + '/' + obj[i].shop_code + '/' + obj[i].def_pic;
      obj[i].def_pic = new_pic;
      var shop_se_price = 0.0;
      if (this.data.isNewUserFlag) {
        // shop_se_price = ((obj[i].shop_se_price) * (this.data.shop.shop_rebate) * 1).toFixed(0);
        shop_se_price = ((obj[i].shop_se_price) * 1).toFixed(0);
      } else {
        shop_se_price = (obj[i].shop_se_price).toFixed(1);
      }
      var newshopname = obj[i].shop_name;
      if (newshopname.length > 24) {
        newshopname = '... ' + newshopname.substr(newshopname.length - 24, 24);
      }
      if (this.data.currentTab == 0) {
        var discount;
        if (this.data.isNewUserFlag) {
          // discount = ((obj[i].shop_se_price) * (this.data.shop.shop_rebate) * 1 / obj[i].shop_price * 10).toFixed(0);

          discount = ((obj[i].shop_se_price) * 1 / obj[i].shop_price * 10).toFixed(0);
        } else {
          discount = (obj[i].shop_se_price / obj[i].shop_price * 10).toFixed(1);
          obj[i].shop_price = (obj[i].shop_price * 1).toFixed(1);
        }

        obj[i]["discount"] = discount;
      }
      if (this.data.isNewUserFlag) {
        obj[i].shop_price = (obj[i].shop_price * 1).toFixed(0);
      } else {
        obj[i].shop_price = (obj[i].shop_price * 1).toFixed(1);
      }
      obj[i].shop_name = newshopname;
      obj[i].shop_se_price = shop_se_price;

      //ä½•æ³¢ä¿®æ”¹2018-4-4
      if (oneYuanData == 0) //æ˜¯1å…ƒè´­
      {
        var se_price = (obj[i].assmble_price * 1).toFixed(1);
        if (this.data.is_vipPage == 1) //å¦‚æœæ˜¯ä¼šå‘˜ç•Œé¢ åˆ—è¡¨ä»·æ ¼=å•ç‹¬è´­ä¹°ä»·-æŠµæ‰£ä»·æ ¼
        {
          // se_price = obj[i].shop_se_price - this.data.reduceMoney > 0 ? (obj[i].shop_se_price - this.data.reduceMoney) : '0.0';

          se_price = this.get_discountPrice(obj[i].shop_se_price, this.data.orangereduceMoney);
        }

        obj[i].shop_price = obj[i].shop_se_price;
        obj[i].shop_se_price = (se_price * 1).toFixed(1);
      } else {
        obj[i].shop_se_price = shop_se_price;
        obj[i].supp_label = '';
      }
    }
    var all_shoplists = this.data.recommendListData;
    for (var j = 0; j < obj.length; j++) {
      all_shoplists.push(obj[j]);
    }
    this.setData({
      recommendListData: all_shoplists,
    })
  },
  queryMultipleNodes() {
    const that = this
    setTimeout(() => {
      wx.createSelectorQuery().select('.shop-detail-out').fields({
        dataset: true,
        size: true,
        scrollOffset: true,
        properties: ['scrollX', 'scrollY']
      }, function (res) {
        that.setData({
          detailHeight: res.height
        })
        console.log("res.height", that.data.detailHeight);
      }).exec()
    }, 300)

  },
  getTopAdData: function () { //è·å–é¡¶éƒ¨å¹¿å‘Šè½®æ’­æ•°æ®
    var that = this;
    // å¾ªç¯Næ¬¡ç”Ÿæˆéšæœºæ•° 
    for (var i = 0; i < 1000; i++) {
      // åªç”Ÿæˆ4ä¸ªéšæœºæ•° 
      if (that.data.getRandomTempData.length < 4) {
        that.generateRandom();
      } else {
        break;
      }
    }
    for (var i = 0; i < that.data.getRandomTempData.length; i++) {
      that.data.adData.push(that.data.adDataAll[that.data.getRandomTempData[i]])
    }
    this.setData({
      adData: that.data.adData,
    });
  },
  // ç”Ÿæˆéšæœºæ•°çš„æ–¹æ³• 
  generateRandom: function () {
    var that = this;
    var rand = parseInt(Math.random() * 11);
    for (var i = 0; i < that.data.getRandomTempData.length; i++) {
      if (that.data.getRandomTempData[i] == rand) {
        return;
      }
    }
    that.data.getRandomTempData.push(rand);
  },
  handletouchStart: function (event) {
    this.data.startDis = event.touches[0].clientY;
  },
  handletouchmove: function (event) {

    console.log('event', event)
    let pageX = event.touches[0].pageX;
    let pageY = event.touches[0].clientY;
    var temp = pageY - this.data.startDis;
    if (temp != 0) {
      this.data.fristDistance = this.data.fristDistance + temp;
    }


    //å±å¹•è¾¹ç•Œåˆ¤æ–­
    if (pageX < 30 || pageY < 30)
      return;
    if (pageX > this.data.screenWidth - 30)
      return;
    if (pageY > this.data.screenHeight - 30)
      return;
    this.setData({
      ballTop: event.touches[0].pageY - 30,
      ballLeft: event.touches[0].pageX - 30,
    });
  },

  getShopTagData: function () { //è·å¾—å•†å“æ ‡ç­¾çš„æ•°æ®
    // shopTagData
    var that = this;
    var arrTemp = [];
    var arrTag = [];
    var strTemp = '';
    arrTag = this.data.strShopTag.split(',');
    var shopTagAll = [];
    shopTagAll = wx.getStorageSync("shop_tag_basedata").data.shop_tag;
    for (var i = 0; i < arrTag.length; i++) {
      for (var j = 0; j < shopTagAll.length; j++) {
        if (arrTag[i] == shopTagAll[j].id) {
          if (shopTagAll[j].tag_name.endsWith('å«)')) {
            if ('10' == shopTagAll[j].parent_id) {
              strTemp = "ä¸»é¢æ–™æˆä»½å«é‡:" + shopTagAll[j].tag_name;
            } else {
              strTemp = "ç¾½ç»’æœå……ç»’é‡:" + shopTagAll[j].tag_name;
            }

          } else {
            arrTemp.push(shopTagAll[j]);
          }
          break;
        }
      }
    }
    var fristShortTag = '';
    if (arrTemp.length > 0) {
      if (strTemp) {
        fristShortTag = arrTemp[0].tag_name;
        arrTemp.shift();
      }
    }
    this.setData({
      shopTagData: arrTemp,
      strLongTag: strTemp,
      fristShortTag: fristShortTag
    })
    // var by = function (name) {//æ•°ç»„æ’åºå‡½æ•°
    //   return function (o, p) {
    //     var a, b;
    //     if (typeof o === "object" && typeof p === "object" && o && p) {
    //       a = parseInt(o[name]);
    //       b = parseInt(p[name]);
    //       if (a === b) { return 0; }
    //       if (typeof a === typeof b) { return a < b ? -1 : 1; }
    //       return typeof a < typeof b ? -1 : 1;
    //     }
    //     else { throw ("error"); }
    //   }
    // }
    // arrTemp.sort(by("sequence"));
  },
  showShopStock: function (colorId, sizeId) { //æ˜¾ç¤ºå•†å“çš„åº“å­˜
    var that = this;
    var dataTemp = [];
    dataTemp = that.data.stockTypeData;
    if (colorId != -1 && sizeId != -1) {
      for (var i = 0; i < dataTemp.length; i++) {
        var color_size = "";
        if (colorId) {
          color_size = colorId;
        }
        if (sizeId) {
          color_size = colorId + ":" + sizeId;
        }
        var sType = dataTemp[i];
        if (sType.color_size == color_size) {

          var stock = sType.stock;
          var price = sType.price;

          var shopPic = that.data.Upyun + that.data.shop.shop_code.substring(1, 4) + '/' + that.data.shop.shop_code + '/' + that.data.shop.def_pic;
          var image = '';
          if (shop_type == 2 || shop_type == 3) {
            image = sType.attr_pic ? (that.data.picLink + sType.attr_pic) : shopPic;
          } else {
            image = sType.pic ? (that.data.picLink + sType.pic) : shopPic;
          }

          that.data.stock_type_id = sType.id;
          if (that.data.isOneYuanClick) //1å…ƒè´­
          {
            // var se_price = app.globalData.oneYuanValue;
            var se_price = that.data.wxcx_shop_group_price;
            price = (se_price * 1).toFixed(1);
            if (app.globalData.oneYuanFree > 0) //æ–°ç”¨æˆ·0å…ƒè´­
            {
              price = '0.0';
            }
          } else {

            if (that.data.isActiveShop == true) {
              price = price;
            } else {
              // price = (price * that.data.shop_deduction - that.data.reduceMoney > 0) ? (price * that.data.shop_deduction - that.data.reduceMoney).toFixed(1) : 0.00;

              price = that.get_discountPrice(price, that.data.reduceMoney);

            }
          }
          that.setData({
            stockCount: stock,
            stockPrice: price,
            stockImage: image
          })

          break;
        }
      }
    }
  },
  getStockTypeSizeColor: function () { //å¾—åˆ°è¯¥å•†å“çš„é¢œè‰²å’Œå°ºç 
    var that = this;
    var dataTemp = [];
    dataTemp = that.data.stockTypeData;
    var arrColorList = [];
    var arrSizeList = [];
    var arrNameList = [];
    var selectIndexs = [];
    var selectColor_SizeIds = [];

    var colorIds = [];
    var listPic = [];
    var sizeIds = [];
    var shopAttrData = that.data.shopAttrData;
    for (var i = 0; i < dataTemp.length; i++) {
      var sType = dataTemp[i];
      var color_size = sType.color_size;
      var arrColorSize = color_size.split(":");
      //æ ¹æ®idæŸ¥è¯¢é¢œè‰²åå­—
      for (var j = 0; j < shopAttrData.length; j++) {
        if (arrColorSize[0] == shopAttrData[j].id) { //æŸ¥è¯¢é¢œè‰²
          var flag = false;
          for (var z = 0; z < arrColorList.length; z++) { //å¦‚æœæœ‰åˆ™ä¸åŠ å…¥
            if (shopAttrData[j].attr_name == arrColorList[z].name) {
              flag = true;
              break;
            }
          }
          if (!flag) {
            var jsons = {};
            jsons['name'] = shopAttrData[j].attr_name;
            jsons['parent_id'] = shopAttrData[j].parent_id;
            jsons['id'] = arrColorSize[0];
            arrColorList.push(jsons);
            colorIds.push(arrColorSize[0]);
            if (sType.pic == undefined) {
              listPic.push(that.data.picLink + that.data.shop.def_pic)
            } else {
              listPic.push(that.data.picLink + sType.pic);
            }
          }
          break;
        }

        var flagSizeId = false;
        for (var g = 0; g < sizeIds.length; g++) { //æ·»åŠ å°ºç id
          if (arrColorSize[1] == sizeIds[g]) {
            flagSizeId = true;
            break;
          }
        }
        if (!flagSizeId) {
          sizeIds.push(arrColorSize[1]);
        }
      }
    }
    if (arrColorList.length > 0) {
      that.data.selectColorId = arrColorList[0].id;
    }

    sizeIds.sort(function (a, b) {
      return a - b;
    })
    if (sizeIds.length > 0) {
      that.data.selectSizeId = sizeIds[0];
    }
    for (var i = 0; i < sizeIds.length; i++) {
      for (var j = 0; j < shopAttrData.length; j++) {
        if (sizeIds[i] == shopAttrData[j].id) { //æŸ¥è¯¢å°ºç 
          var jsons = {};
          jsons['name'] = shopAttrData[j].attr_name;
          jsons['parent_id'] = shopAttrData[j].parent_id;
          jsons['id'] = sizeIds[i];
          if (jsons['name'] && jsons['id']) {
            arrSizeList.push(jsons)
          }
          break;
        }
      }
    }

    //æ ¹æ®å±æ€§å€¼æŸ¥æ‰¾å±æ€§å
    var dataList = [arrColorList, arrSizeList];
    for (var l = 0; l < dataList.length; l++) {
      var list = dataList[l];
      for (var k = 0; k < list.length; k++) {
        var parent_id = list[k].parent_id;
        var findflag = false;
        for (var j = 0; j < shopAttrData.length; j++) {
          var id = shopAttrData[j].id;
          var name = shopAttrData[j].attr_name;
          if (id == parent_id) {
            arrNameList.push(name);
            selectIndexs.push('');
            selectColor_SizeIds.push('');
            findflag = true;
            break;
          }
        }
        if (findflag == true) {
          break;
        }
      }
    }
    this.setData({
      stockColorData: arrColorList,
      stockSizeData: arrSizeList,
      stockPicData: listPic,
      stockNameData: arrNameList,
      selectIndexs: selectIndexs,
      selectColor_SizeIds: selectColor_SizeIds
    });
    // this.showShopStock(that.data.selectColorId, that.data.selectSizeId);
    this.showNewShopStock(that.data.selectIndexs, that.data.selectColor_SizeIds);
  },


  showNewShopStock: function (selectIndexs, selectColor_sizeIds) { //æ˜¾ç¤ºå•†å“çš„åº“å­˜
    var that = this;
    var dataTemp = [];
    dataTemp = that.data.stockTypeData;
    if (selectColor_sizeIds.length > 0) {
      for (var i = 0; i < dataTemp.length; i++) {
        var color_size = selectColor_sizeIds.join(':');
        var sType = dataTemp[i];
        if (sType.color_size == color_size) {

          var stock = sType.stock;
          var price = sType.price;
          var stock_shop_se_price = sType.price;
          var shopPic = that.data.Upyun + that.data.shop.shop_code.substring(1, 4) + '/' + that.data.shop.shop_code + '/' + that.data.shop.def_pic;
          var image = '';
          if (shop_type == 2 || shop_type == 3) {
            image = sType.attr_pic ? (that.data.picLink + sType.attr_pic) : shopPic;
          } else {
            image = sType.pic ? (that.data.picLink + sType.pic) : shopPic;
          }

          that.data.stock_type_id = sType.id;
          if (that.data.isOneYuanClick) //ç‚¹å‡»1å…ƒè´­
          {
            var se_price = this.data.wxcx_shop_group_price;
            price = (se_price * 1).toFixed(1);
            if (app.globalData.oneYuanFree > 0) //æ–°ç”¨æˆ·0å…ƒè´­
            {
              price = '0.0';
            }
          } else {

            if (that.data.isActiveShop == true) {
              price = price;
            } else if (that.data.isShowJoinGroup || that.data.is_vip == 0 || that.data.isKT)//å¼€å›¢æˆ–è€…å‚å›¢çš„ä»·æ ¼
            {
              price = that.data.fightbottomOneBtnTv;
            }
            else {
              // price = that.get_discountPrice(that.data.shop.shop_se_price, that.data.reduceMoney);
              price = that.get_discountPrice(price, that.data.reduceMoney);
            }
          }

          that.setData({
            stockCount: stock,
            stockPrice: price,
            stockImage: image,
            stock_shop_se_price: stock_shop_se_price,
          })
          break;
        }
      }
    }
  },
  getNewStockTypeSizeColor: function () { //å¾—åˆ°è¯¥å•†å“çš„é¢œè‰²å’Œå°ºç 
    var that = this;
    var dataTemp = [];
    dataTemp = that.data.stockTypeData;
    var arrColorList = [];
    var arrSizeList = [];

    var arrNameList = [];
    var arrNameIds = [];
    var arrTitleNameList = [];
    var arrTitleNameIds = [];
    var selectIndexs = [];
    var selectColor_SizeIds = [];
    var arrColor_SizeList = [];
    var arrColor_SizeIds = [];

    var colorIds = [];
    var listPic = [];
    var sizeIds = [];
    var shopAttrData = that.data.shopAttrData;
    for (var i = 0; i < dataTemp.length; i++) {
      var sType = dataTemp[i];
      var color_size = sType.color_size;
      var arrColorSize = color_size.split(":");
      var color_sizeList = [];
      var color_sizeIds = [];

      //æ ¹æ®idæŸ¥è¯¢é¢œè‰²åå­—
      for (var k = 0; k < arrColorSize.length; k++) {
        for (var j = 0; j < shopAttrData.length; j++) {
          if (arrColorSize[k] == shopAttrData[j].id) { //æŸ¥è¯¢é¢œè‰²
            var flag = false;
            for (var z = 0; z < color_sizeList.length; z++) { //å¦‚æœæœ‰åˆ™ä¸åŠ å…¥
              if (shopAttrData[j].attr_name == color_sizeList[z].name) {
                flag = true;
                break;
              }
            }
            if (!flag) {
              var jsons = {};
              jsons['name'] = shopAttrData[j].attr_name;
              jsons['parent_id'] = shopAttrData[j].parent_id;
              jsons['id'] = arrColorSize[k];

              var color_sizeflag = false;
              for (var m = 0; m < arrColor_SizeList.length; m++) {
                var json1 = arrColor_SizeList[m];
                if (jsons['id'] == json1['id']) {
                  color_sizeflag = true;
                  break;
                }
              }
              if (!color_sizeflag) {
                arrColor_SizeList.push(jsons);
              }

              var color_sizeIdflag = false;
              for (var n = 0; n < arrColor_SizeIds.length; n++) {
                var id = arrColor_SizeIds[n];
                if (id == arrColorSize[k]) {
                  color_sizeIdflag = true;
                  break;
                }
              }
              if (!color_sizeIdflag) {
                arrColor_SizeIds.push(arrColorSize[k]);
              }

              if (shop_type == 2 || shop_type == 3) //ç‰¹ä»·
              {
                if (sType.attr_pic == undefined) {
                  listPic.push(that.data.picLink + that.data.shop.def_pic)
                } else {
                  listPic.push(that.data.picLink + sType.attr_pic);
                }
              } else {
                if (sType.pic == undefined) {
                  listPic.push(that.data.picLink + that.data.shop.def_pic)
                } else {
                  listPic.push(that.data.picLink + sType.pic);
                }
              }

            }
            break;
          }
        }
      }
    }

    //æ ¹æ®å±æ€§å€¼æŸ¥æ‰¾å±æ€§å
    for (var l = 0; l < arrColor_SizeList.length; l++) {
      var parent_id = arrColor_SizeList[l].parent_id;
      var findflag = false;

      for (var j = 0; j < shopAttrData.length; j++) {
        var id = shopAttrData[j].id;
        var name = shopAttrData[j].attr_name;
        if (id == parent_id) {
          findflag = true;
          var findNameFlag = false;
          for (var k = 0; k < arrNameList.length; k++) {
            if (name == arrNameList[k]) {
              findNameFlag = true
              break;
            }
          }
          if (!findNameFlag) {
            arrNameList.push(name);
            arrNameIds.push(id);
          }
        }
        if (findflag == true) {
          break;
        }
      }
    }

    var Color_SizeList = [];
    for (var k = 0; k < arrNameIds.length; k++) {
      var arrlist = [];
      var id = arrNameIds[k];
      for (var l = 0; l < arrColor_SizeList.length; l++) {
        var parent_id = arrColor_SizeList[l].parent_id;
        if (parent_id == id) {
          arrlist.push(arrColor_SizeList[l]);
        }
      }
      Color_SizeList.push(arrlist);
      selectIndexs.push('0');
      selectColor_SizeIds.push(arrlist[0].id);
    }

    //æŸ¥æ‰¾å±æ€§æ ‡é¢˜
    for (var m = 0; m < arrNameIds.length; m++) {
      var nameid = arrNameIds[m];
      for (var n = 0; n < shopAttrData.length; n++) {
        var id = shopAttrData[n].id;
        if (nameid == id) {
          arrTitleNameList.push(shopAttrData[n].attr_name);
          arrTitleNameIds.push(id);
          break;
        }
      }
      if (arrTitleNameList.length <= 0) {
        arrTitleNameList.push('');
      }
    }

    this.setData({
      colorIndex: 0,
      stockColorData: arrColorList,
      stockSizeData: arrSizeList,
      stockColorSizeData: Color_SizeList,
      stockPicData: listPic,
      stockNameData: arrTitleNameList,
      stockTitleNameData: arrTitleNameList,
      selectIndexs: selectIndexs,
      selectColor_SizeIds: selectColor_SizeIds,
      spaceName: "å "
    });

    // this.showShopStock(that.data.selectColorId, that.data.selectSizeId);
    this.showNewShopStock(that.data.selectIndexs, that.data.selectColor_SizeIds);
  },
  getShopAttrData: function () { //è·å¾—è¯¥å•†å“å±æ€§æ•°æ®(å‚æ•°é‡Œå°ºç å‚è€ƒ)
    var that = this;
    var str = [];
    var sizeData1 = [];
    str = that.data.shop_attr.split("_");
    for (var i = 0; i < str.length; i++) {
      var strson = str[i].split(",");
      sizeData1.push(strson);
    }
    var rows = 0;
    if (sizeData1.length == 0) {
      return;
    }
    var sizeData2 = [];
    for (var i = 0; i < sizeData1.length; i++) {
      var strTemp = sizeData1[i];
      if (strTemp[0] == '501') {
        sizeData2.push(strTemp);
        var len = strTemp.length;
        if (len > rows) {
          rows = len;
        }
      }
    }
    rows = rows - 2;
    var lSize = parseInt(rows / 5);
    var mond = rows % 5;
    if (mond > 0) {
      lSize = lSize + 1;
    }
    var p = 1;
    // var strFenGe = "åˆ†å‰²";
    var sizeDataNew = [];
    for (var i = 0; i < lSize; i++) {
      for (var j = 0; j < sizeData2.length; j++) {
        var strY = sizeData2[j];
        var str = new Array(6);
        str[0] = strY[1];
        var len = strY.length;

        if ((5 * p - 3) < len) {
          str[1] = strY[(5 * p - 3)];
        }
        if ((5 * p - 2) < len) {
          str[2] = strY[(5 * p - 2)];
        }
        if ((5 * p - 1) < len) {
          str[3] = strY[(5 * p - 1)];
        }
        if ((5 * p) < len) {
          str[4] = strY[5 * p];
        }
        if ((5 * p + 1) < len) {
          str[5] = strY[5 * p + 1];
        }

        sizeDataNew.push(str);

      }
      p++;
      // if (i != lSize - 1) {
      //   sizeDataNew.push(strFenGe);
      // }
    }

    var arrLast = [];
    for (var i = 0; i < sizeDataNew.length; i++) { //å±æ€§æ¯è¡Œå¾ªç¯
      var arrTemp1 = [];
      var arr = sizeDataNew[i];
      for (var j = 0; j < arr.length; j++) { //å•è¡Œå¯¹åº”çš„å±æ€§å

        var id = arr[j];
        var flag = false;
        for (var z = 0; z < that.data.shopAttrData.length; z++) { //æ ¹æ®idæŸ¥è¯¢å±æ€§å
          if (id == that.data.shopAttrData[z].id) {
            flag = true;
            arrTemp1.push(that.data.shopAttrData[z].attr_name)
            break;
          }
        }
        if (!flag) { //å¦‚æœæ²¡æœ‰æŸ¥åˆ°å¯¹åº”çš„å±æ€§åå­—ï¼Œæ·»åŠ ä¸€ä¸ªç©ºå­—ç¬¦ä¸²
          arrTemp1.push('null')
        }
      }
      if (arrTemp1.length > 1 && '' != arrTemp1[1]) {
        arrLast.push(arrTemp1);
      }
    }
    this.setData({
      sizeData: arrLast
    });
  },
  getImagePath: function () { //è·å¾—å•†å“è¯¦æƒ…é¡µè¯¦æƒ…çš„å›¾ç‰‡é›†åˆ
    var that = this;
    var imagePathData = that.data.shop_pic.split(',');
    for (var i = 0; i < imagePathData.length; i++) {
      if (imagePathData[i]) {
        if (imagePathData[i].indexOf("reveal_") >= 0 || imagePathData[i].indexOf("real_") >= 0 || imagePathData[i].indexOf("detail_") >= 0) {
          that.data.imagePathData.push(imagePathData[i])
        }
      }
    }
    this.setData({
      imagePathData: that.data.imagePathData,
    })
  },


  touchMove: function (e) {
    if (!this.data.isRecommendFix && !this.data.isFixFlag && this.data.isShareFlag) {
      this.setData({
        isSHowAdFlag: false
      })
    }
  },
  touchEnd: function (e) {
    if (!this.data.isRecommendFix && !this.data.isFixFlag && this.data.isShareFlag) {
      this.setData({
        isSHowAdFlag: true
      })
    }
  },
  // é¡µé¢é‡Œçš„ç‚¹å‡»  ---start
  upperlimittap: function () { //æ–°ç”¨æˆ·å¼¹çª—å…³é—­
    this.setData({
      isNewUserShow: false
    })
  },
  upperlimittap: function () { //è·³å»èµšé’±
    this.setData({
      isNewUserShow: false
    })
    wx.redirectTo({
      url: "../../sign/sign?firstLogin=true",
    })
  },
  recommendShopItemClick: function (event) { //æ¨èå•†å“æ¡ç›®ç‚¹å‡»
    var path = '';
    var shopcode = event.currentTarget.dataset.shop_code;
    if (this.data.isNewUserFlag) {
      path = '../detail/detail?' + "shop_code=" + shopcode + '&isNewUserFlag=' + this.data.isNewUserFlag;
    } else {
      path = '../detail/detail?' + "shop_code=" + shopcode;
    }
    wx.redirectTo({
      url: path,
    })
  },
  recommendTitleClick: function (event) { //å•†å“æ¨èå¤´çš„ç‚¹å‡»
    var that = this;
    this.data.currentTab = event.currentTarget.dataset.index;
    var type_name = event.currentTarget.dataset.name;
    var id = event.currentTarget.dataset.id;
    this.data.recommendPage = 1;
    this.data.recommend_type_name = type_name;
    this.data.recommend_type1 = id;
    this.getData(5, function (data) {
      that.dealBackData(5, data)
    })
    this.setData({
      currentTab: this.data.currentTab
    });
  },
  zeroBuyCloseClick: function () { //0å…ƒè´­å¼¹çª—ä¸Šå…³é—­æŒ‰é’®
    this.setData({
      zeroBuyDialogShowFlag: false
    });
  },
  zeroBuyToSign: function () { //0å…ƒè´­å¼¹çª—ä¸Šå»èµšé’±
    wx.redirectTo({
      url: "../../sign/sign",
    })
  },

  zeroBuyNowClick: function () { //0å…ƒè´­å¼¹çª—ä¸Šç«‹å³è´­ä¹°
    this.setData({
      zeroBuyDialogShowFlag: false
    });
    var that = this;
    this.setData({
      showDialog: true
    });
    if (that.data.stockTypeData.length == 0) {
      this.getData(2, function (data) {
        that.dealBackData(2, data);
      });
    } else {
      // this.showShopStock(that.data.selectColorId, that.data.selectSizeId);
      this.showNewShopStock(that.data.selectIndexs, that.data.selectColor_SizeIds);
    }
  },

  //å•ç‹¬è´­ä¹°
  buyOrder: function () {
    var that = this;
    var t = that.data.roll_code ? 2 : 1;
    var page3 = 0;
    if (that.data.comefrom == 'sign' && (that.data.shouYePage == 'ThreePage' || that.data.shouYePage == 'FivePage')) {
      page3 = 1;
    }
    //è·å–ä¼šå‘˜ä¿¡æ¯
    util.get_VipUserIfon(that.data.shop_code, t, page3, function (data) {
      if (data.status == 1) {
        var is_buy = data.is_buy != undefined ? data.is_buy : "";
        var vip_type = data.vip_type != undefined ? data.vip_type : "";
        var vip_free = data.vip_free != undefined ? data.vip_free : "";
        var free_page = data.free_page != undefined ? data.free_page : "";
        var isVip = data.isVip != undefined ? data.isVip : "";

        if (that.data.isOneYuanClick) {

          // if (is_buy == 1 && vip_free != 1)//è´­ä¹°ä¼šå‘˜å¡
          // {
          //     if (!that.data.nowDayisDaka)//å½“å¤©ä»»åŠ¡æ²¡å®Œæˆå¼•å¯¼åˆ°èµšé’±ä»»åŠ¡
          //     {
          //       that.setData({
          //         guidebecomeMemberImage: 'å®Œæˆä»»åŠ¡',
          //         guidebecomeMemberShow: true
          //       })
          //     }else{
          //     var guidebecomeMemberImage = '';
          //     if (that.data.isfreeLingClick) {
          //       guidebecomeMemberImage = 'å…è´¹é¢†';
          //     } else {
          //       guidebecomeMemberImage = 'å•ç‹¬è´­ä¹°';
          //     }
          //     that.setData({
          //       guidebecomeMemberImage: guidebecomeMemberImage,
          //       guidebecomeMemberShow: true
          //     })
          //   }
          // } else {
          //   if (vip_type > 0 || vip_free == 1)// > 0ä¼šå‘˜å¡çº§åˆ«æ­£å¸¸æˆ–è€…æœ‰ä¼šå‘˜å…è´¹é¢†
          //   {
          //     that.setData({
          //       showDialog: true
          //     });
          //     if (that.data.stockTypeData.length == 0) {
          //       that.getData(2, function (data) {
          //         that.dealBackData(2, data);
          //       });
          //     } else {
          //       that.showNewShopStock(that.data.selectIndexs, that.data.selectColor_SizeIds);
          //     }
          //   } else {// <0ä¼šå‘˜å¡çº§åˆ«å¤±æ•ˆ

          //       if (!that.data.nowDayisDaka)//å½“å¤©ä»»åŠ¡æ²¡å®Œæˆå¼•å¯¼åˆ°èµšé’±ä»»åŠ¡
          //       {
          //         that.setData({
          //           guidebecomeMemberImage: 'å®Œæˆä»»åŠ¡',
          //           guidebecomeMemberShow: true
          //         })
          //       }else{
          //           wx.navigateTo({
          //             url: '../../mine/addMemberCard/addMemberCard?memberComefrom=' + 'detail' + "&vip_type=" + vip_type,
          //           })
          //       }
          //   }
          // }

          //2020-2-13 æœ€æ–°ä¿®æ”¹
          // if (that.data.task_freeling != 'freeling')//å¦‚æœæ˜¯å…è´¹é¢†ä»»åŠ¡ç›´æ¥å»å…è´¹é¢†
          // {
          //   if (isVip == 1)//å¦‚æœæ˜¯ä¼šå‘˜å…ˆå»å®Œæˆå½“å¤©ä»»åŠ¡å†å»å…è´¹é¢† éä¼šå‘˜ç›´æ¥å…è´¹é¢†
          //   {
          //     if (!that.data.nowDayisDaka)//å½“å¤©ä»»åŠ¡æ²¡å®Œæˆå¼•å¯¼åˆ°èµšé’±ä»»åŠ¡
          //     {
          //       that.setData({
          //         guidebecomeMemberImage: 'å®Œæˆä»»åŠ¡',
          //         guidebecomeMemberShow: true
          //       })
          //       return;
          //     }
          //   } else {//éä¼šå‘˜å…ˆåˆ†äº«4æ¬¡å†è´­ä¹°
          //     if (that.data.isFreelingShareCount > 0) {
          //       that.setData({
          //         isShowShare: true,
          //       })
          //       return;
          //     }
          //   }
          // } else {//æ˜¯å…è´¹é¢†ä»»åŠ¡ éä¼šå‘˜å…ˆåˆ†äº«4æ¬¡å†è´­ä¹°ï¼Œä¼šå‘˜ç›´æ¥å…è´¹é¢†
          //   if (isVip == 0)
          //   {
          //     if (that.data.isFreelingShareCount > 0) {
          //       that.setData({
          //         isShowShare: true,
          //       })
          //       return;
          //     }
          //   }
          // }

          //å…è´¹é¢†åˆ†äº«å®Œåå»ä¸‹å•
          if (that.data.isFreelingShareCount > 0) {
            that.getShareShop(function (success) {
              if (success) {
                that.setData({
                  isShowShare: true
                })
              }
            });
            return;
          }

          // if (vip_free == 1 || vip_type >0 )//å…è´¹é¢†
          // {
          //   that.setData({
          //     showDialog: true
          //   });
          //   if (that.data.stockTypeData.length == 0) {
          //     that.getData(2, function (data) {
          //       that.dealBackData(2, data);
          //     });
          //   } else {
          //     that.showNewShopStock(that.data.selectIndexs, that.data.selectColor_SizeIds);
          //   }
          // }else{
          //   if(vip_type < 0 || is_buy == 1)//ä¼šå‘˜ç­‰çº§ä¸å¤Ÿ
          //   {
          //     wx.navigateTo({
          //       url: '../../mine/addMemberCard/addMemberCard?memberComefrom=' + 'detail' + "&vip_type=" + vip_type,
          //     })
          //   }
          // }

          that.setData({
            showDialog: true
          });
          if (that.data.stockTypeData.length == 0) {
            that.getData(2, function (data) {
              that.dealBackData(2, data);
            });
          } else {
            that.showNewShopStock(that.data.selectIndexs, that.data.selectColor_SizeIds);
          }

        } else {

          //æ¯ä¸ªç”¨æˆ·åªé™ä¸€æ¬¡å‚å›¢
          if (that.data.is_twice == 1 && that.data.isShowJoinGroup)//å†æ¬¡å‚å›¢
          {
            if (that.data.is_vip > 0 && that.data.is_vip !=3)//æ˜¯ä¼šå‘˜
            {
              that.showToast('æ¯ä¸ªä¼šå‘˜ä»…é™å‚å›¢1æ¬¡ç‰¹ä»·å›¢å“¦ã€‚', 2000);
            } else {
              that.setData({
                guidebecomeMemberImage: 'ç‰¹ä»·å‚å›¢',
                guidebecomeMemberShow: true
              })
            }
          }else{//å•ç‹¬è´­ä¹° æˆ–è€…å‚å›¢
            that.setData({
              showDialog: true
            });
            if (that.data.stockTypeData.length == 0) {
              that.getData(2, function (data) {
                that.dealBackData(2, data);
              });
            } else {
              that.showNewShopStock(that.data.selectIndexs, that.data.selectColor_SizeIds);
            }
          }
        }
        that.setData({
          vip_type: vip_type,
          free_page: free_page
        })
      } else {
        that.showToast(data.message, 2000);
      }

    })
  },

  moneyDiscountClick: function () { //ä½™é¢æŠµæ‰£ç‚¹å‡»
    this.setData({
      moneyDiscountShowFlag: true,
      oneYuanDiscriptionTitle: "ä½™é¢æŠµæ‰£è¯´æ˜",
      moneyDiscount: this.data.moneyDiscount,
      reduceMoney: this.data.reduceMoney,
    })
  },
  //ä½™é¢æŠµæ‰£å¼¹çª—ç‚¹å‡»å»èµšä½™é¢ å…³é—­
  getMoneyBtn: function () {
    this.setData({
      moneyDiscountShowFlag: false
    })
    wx.navigateTo({
      url: "../../sign/sign",
    })
  },
  //ä½™é¢æŠµæ‰£å¼¹çª—ç‚¹å‡»æŸ¥çœ‹ä½™é¢ å…³é—­
  getYueBtn: function () {
    wx.navigateTo({
      url: '../../mine/wallet/wallet',
    })
    this.setData({
      moneyDiscountShowFlag: false
    })
  },
  closeYiDouBtn: function () {
    this.setData({
      moneyDiscountShowFlag: false,
      moneyTixianShowFlag: false,
      shareDiscriptionShow: false
    })
  },
  closeGogoTab: function () {
    this.setData({
      shareDiscriptionShow: false
    })
  },
  //èµ„é‡‘æ˜ç»†
  zijingmingxiBtn: function () {
    wx.navigateTo({
      url: '../../mine/wallet/accountDetail/accountDetail?activityIndex=3',
    })
    this.setData({
      moneyTixianShowFlag: false
    })
  },
  //æˆä¸ºä¼šå‘˜
  becomeMenberBtn: function () {
    wx.navigateTo({
      url: '../../mine/addMemberCard/addMemberCard'
    })
    this.setData({
      moneyTixianShowFlag: false
    })
  },
  //è®¡ç®—æŠµæ‰£åä»·æ ¼
  get_discountPrice: function (before_price, reduceMoney) {

    var after_price = before_price * 1;

    //é¦–é¡µ2 é¦–é¡µ3 é¦–é¡µ4 ä¸å‚ä¸æŠµæ‰£
    if (this.data.shouYePage == "TwoPage") {
      after_price = Number(after_price - reduceMoney) > 0 ? (after_price - reduceMoney) : 0.0;
    } else {
      if (Number(this.data.shop_deduction) > 0 && Number(this.data.shop_deduction * after_price) <= Number(reduceMoney)) {
        if (this.data.max_vipType == 6)//è‡³å°Šä¼šå‘˜æ‰“95æŠ˜
        {
          after_price = after_price * (1 - this.data.shop_deduction - 0.05);
        } else {
          after_price = after_price * (1 - this.data.shop_deduction);
        }

      } else {
        if (this.data.max_vipType == 6)//è‡³å°Šä¼šå‘˜æ‰“95æŠ˜
        {
          after_price = Number(after_price * 0.95 - reduceMoney) > 0 ? (after_price * 0.95 - reduceMoney) : 0.0;
        } else {
          after_price = Number(after_price - reduceMoney) > 0 ? (after_price - reduceMoney) : 0.0;
        }
      }
    }
    after_price = Number(after_price) >= 0 ? after_price : 0.0;

    return after_price.toFixed(1);
  },
  //è·å–å¯æŠµæ‰£ä½™é¢
  get_discountHttp: function () {
    var that = this;
    var token = "";
    if (app.globalData.user != null) {
      token = app.globalData.user.userToken;
    }
    var oldurl = config.Host + 'order/getZeroOrderDeductible?' + config.Version + '&token=' + token;
    util.http(oldurl, that.discount_data);
  },

  discount_data: function (data) {
    if (data.status == 1) {
      var money = data.one_not_use_price.toFixed(2);

      var reduceMoney = Number(money) > Number(this.data.shop.shop_se_price) ? this.data.shop.shop_se_price : money;
      var shop_deduction = Number(data.shop_deduction) > 1 ? 1.0 : data.shop_deduction;

      var discount_reduceMoney = Number(this.data.shop.shop_se_price * shop_deduction) < Number(reduceMoney) ? (this.data.shop.shop_se_price * shop_deduction) : reduceMoney;

      if (this.data.shop_type == 3)//ç‰¹ä»·å¹¿å‘Šå•†å“æœ€å¤šå¯æŠµæ‰£15å…ƒ æŠµæ‰£ä¸æ»¡15å…ƒä¸€æ¬¡æ€§æŠµæ‰£å®Œ
      {
        money = Number(money) >= 15 ? 15 : money;
        reduceMoney = money;
      }

      this.setData({
        moneyDiscount: data.order_price.toFixed(1),
        reduceMoney: reduceMoney > 0 ? (reduceMoney * 1).toFixed(2) : '0.0',
        discount_reduceMoney: discount_reduceMoney > 0 ? (discount_reduceMoney * 1).toFixed(2) : '0.0',
        orangereduceMoney: data.one_not_use_price.toFixed(2),
        shop_deduction: shop_deduction,
        is_open: data.is_open != undefined ? data.is_open : 0
      })

    } else {
      this.setData({
        moneyDiscount: '0.0',
        reduceMoney: '0.0',
        shop_deduction: '0.9'
      })
    }

    if (oneYuanData == 0) //1å…ƒè´­
    {
      var returnOneText = ((this.data.roll_code.length > 0 && this.data.rnum > 0 && this.data.SurplusTime > 0 && !this.data.is_redHongBao) ? "ä¸€é”®å‚å›¢" : this.data.returnOneText);
      var returnTwoText = this.data.returnTwoText ? this.data.returnTwoText : (this.data.wxcx_shop_group_price * 1).toFixed(1);

      //æ˜¯å¦æ˜¯0å…ƒè´­
      if (app.globalData.oneYuanFree > 0) { //æ–°ç”¨æˆ·0å…ƒè´­
        var rawardMoney = this.data.shop.shop_se_price * 0.5 > 50 ? 50 : this.data.shop.shop_se_price * 0.5;
        // var bottomOneYuan = (this.data.shop_type == 2 || this.data.shop_type == 3) ? false : true;
        this.setData({
          bottomOneYuan: true,
          bottomBtnTv: this.data.shop.shop_se_price,
          bottomBtnTv1: 'èµšï¿¥' + rawardMoney.toFixed(1),
          bottomOneBtnTv: returnTwoText,
          bottomOneBtnTv1: returnOneText,
          fightbottomOneBtnTv: this.data.assmble_price != undefined ? this.data.assmble_price : '',
          shop_se_price: this.data.shop_se_price,
          shop_price: (this.data.shop.shop_price * 1).toFixed(1),
        });
      } else {


        var paymoney = this.get_discountPrice(this.data.shop.shop_se_price, this.data.reduceMoney);
        var rawardMoney = this.data.shop.shop_se_price * 0.5 > 50 ? 50 : this.data.shop.shop_se_price * 0.5;
        var spacetitle = this.data.shop_type == 3 ? "ç–¯æŠ¢" : "";
        var bottomBtnTvTitle = (paymoney > 0 ? paymoney : '0.0');
        var shareRawardMoney = (this.data.shop.shop_se_price * 0.1).toFixed(1);
        // var bottomOneYuan = (this.data.shop_type == 2 || this.data.shop_type == 3) ? false : true;


        var shop_price; var shop_se_price;
        if (this.data.is_vipPage == 1)//ä¼šå‘˜ç•Œé¢
        {
          shop_se_price = (paymoney > 0) ? (paymoney * 1).toFixed(1) : '0.0';
          shop_price = (this.data.shop.shop_price * 1).toFixed(1);
        } else {
          shop_se_price = this.data.shop_se_price;
          shop_price = (this.data.shop.shop_price * 1).toFixed(1);
        }

        this.setData({
          spacetitle: spacetitle,
          bottomOneYuan: true,
          bottomBtnTv: bottomBtnTvTitle,
          bottomBtnTv1: 'èµšï¿¥' + rawardMoney.toFixed(1),
          bottomOneBtnTv: returnTwoText,
          bottomOneBtnTv1: returnOneText,
          fightbottomOneBtnTv: this.data.assmble_price != undefined ? this.data.assmble_price:'',
          shareRawardMoney: shareRawardMoney,
          shop_se_price: shop_se_price,
          shop_price: shop_price,
        });


      }
    } else {

      var paymoney = this.get_discountPrice(this.data.shop.shop_se_price, this.data.reduceMoney);
      var rawardMoney = this.data.shop.shop_se_price * 0.5 > 50 ? 50 : this.data.shop.shop_se_price * 0.5;
      var bottomTitle = "";
      if (this.data.isActiveShop) {
        paymoney = this.data.shop_se_price;
        bottomTitle = "ç«‹å³è´­ä¹°";
      } else {
        bottomTitle = 'èµšï¿¥' + rawardMoney.toFixed(1);
      }

      var shop_price; var shop_se_price;
      if (this.data.is_vipPage == 1)//ä¼šå‘˜ç•Œé¢
      {
        shop_se_price = (paymoney > 0) ? (paymoney * 1).toFixed(1) : '0.0';
        shop_price = (this.data.shop.shop_price * 1).toFixed(1);
      } else {
        shop_se_price = this.data.shop_se_price;
        shop_price = (this.data.shop.shop_price * 1).toFixed(1);
      }

      var spacetitle = this.data.shop_type == 3 ? "ç–¯æŠ¢" : "";
      var bottomBtnTvTitle = (paymoney > 0 ? paymoney : '0.0');

      this.setData({
        spacetitle: spacetitle,
        bottomOneYuan: false,
        bottomBtnTv: bottomBtnTvTitle,
        bottomBtnTv1: bottomTitle,

        shop_se_price: shop_se_price,
        shop_price: shop_price,
      });

    }
  },

  //è·å–æ˜¯å¦å¼¹å‡ºå¥–åŠ±é‡‘çš„å¼¹çª—
  getRawardMoneyStatus: function () {
    var that = this;
    var token = "";
    if (app.globalData.user != null) {
      token = app.globalData.user.userToken;
    }
    var oldurl = config.Host + 'userVipCard/rewardDrawPop?' + config.Version + "&token=" + token;
    util.http(oldurl, that.rawardMoney_data);
  },
  rawardMoney_data: function (data) {
    var that = this;
    var is_pop = data.is_pop != undefined ? data.is_pop : 0;
    var draw = data.draw != undefined ? data.draw : 0;
    //ä¼šå‘˜å¥–åŠ±é‡‘å¼¹çª—
    if (is_pop > 0 && app.globalData.moneyTixianShowCount == 0) {
      that.setData({
        moneyTixianShowFlag: true,
        rawardMoney: draw,
        oneYuanDiscriptionTitle: data.is_pop == 2 ? 'å¥–åŠ±é‡‘æ¸…0' : 'æ­å–œæ‚¨',
      })
      app.globalData.moneyTixianShowCount += 1;
    }
  },
  // btnLeftClick: function () {//ä½™é¢æŠµæ‰£å¼¹çª—ç‚¹å‡»çŸ¥é“äº†
  //   this.setData({ moneyDiscountShowFlag: false })
  // },
  // btnRightClick: function () {//ä½™é¢æŠµæ‰£å¼¹çª—ç‚¹å‡»å»èµšé’±
  //   wx.redirectTo({
  //     url: "../../sign/sign",
  //   })// è·³è½¬åˆ° tabBar é¡µé¢ï¼Œå¹¶å…³é—­å…¶ä»–æ‰€æœ‰é tabBar é¡µé¢
  // },

  suppClick: function () { //ä¾›åº”å•†çš„ç‚¹å‡»

    wx.redirectTo({
      url: '../../listHome/brandsDetail/brandsDetail?' +
        "class_id=" + this.data.shop.supp_label_id +
        "&navigateTitle=" + this.data.shop.supp_label
    })


  },
  signBottomAdCloseClick: function () {
    this.setData({
      isShowSignBottomAd: false
    })
  },
  // redPackeClick: function () {//æ‚¬æµ®çº¢åŒ…
  //   if (this.data.isShareFlag) {
  //     wx.redirectTo({
  //       url: "../../sign/sign",
  //     })
  //     return;
  //   }
  //   var that = this;
  //   if (null == this.data.token) {
  //     util.toAuthorizeWx(function (isSuccess) {
  //       if (isSuccess) {
  //         if (app.globalData.user != null) {
  //           that.data.token = app.globalData.user.userToken;
  //         }
  //         publicUtil.getBalanceNum(function (isSHow) {
  //           if (isSHow) {
  //             that.data.isShowRedPacked = true;
  //           } else {
  //             that.data.isShowRedPacked = false;
  //           }
  //           that.setData({ isShowRedPacked: that.data.isShowRedPacked });
  //         });
  //       } else {
  //         return;
  //       }
  //     });
  //   } else {
  //     wx.navigateTo({
  //       url: '../../sign/withdrawLimit/withdrawLimit?isBalanceLottery=true',
  //     })
  //   }
  // },

  toInviteFriendsClick: function () { //è·³è½¬åˆ°é‚€è¯·å¥½å‹
    var that = this;
    this.setData({
      isShowShare: false
    })
    var share_pic = '';
    if (this.data.shop.four_pic) {
      var picArray = this.data.shop.four_pic.split(',');
      if (picArray.length > 2) {
        share_pic = picArray[2] + '!450';
      } else {
        share_pic = this.data.shop.def_pic + '!450';
      }
    } else {
      share_pic = this.data.shop.def_pic + '!450';
    }
    wx.navigateTo({
      url: 'inviteFriends/invite?title=' + that.data.shareTitle + '&link=' + that.data.picLink + share_pic + '&shop_code=' + that.data.shop.shop_code,
    })
  },
  openSignClick: function () { //æ‰“å¼€èµšé’±é¡µ
    wx.redirectTo({
      url: "../../sign/sign",
    }) // è·³è½¬åˆ° tabBar é¡µé¢ï¼Œå¹¶å…³é—­å…¶ä»–æ‰€æœ‰é tabBar é¡µé¢
  },

  clickOneShare: function () { //1å…ƒè´­åˆ†äº«
    this.setData({
      isOneShowShare: true,
    })
    this.top_shopHttp();
  },
  cancelOneShare: function (e) { //å–æ¶ˆ1å…ƒè´­åˆ†äº«
    this.setData({
      isOneShowShare: false
    })
    // util.httpPushFormId(e.detail.formId);
  },

  //è·å–äºŒçº§ç±»ç›®
  top_shopHttp: function () {
    var that = this;
    var token = "";
    if (app.globalData.user != null) {
      token = app.globalData.user.userToken;
    }
    var oldurl = config.Host + 'shop/queryShopType2?' + config.Version + '&token=' + token + '&shop_code=' + that.data.shop_code;
    util.http(oldurl, that.type_data);
  },
  type_data: function (data) {
    if (data.status == 1) {
      this.setData({
        type_data: data.type2
      })

      var supp_label = 'è¡£è ';
      if (this.data.shop.supp_label) {
        supp_label = this.data.shop.supp_label;
      }

      var sharemoney = app.globalData.oneYuanFree > 0 ? '0' : this.data.wxcx_shop_group_price;

      var shareJson = 'å¿«æ¥' + this.data.wxcx_shop_group_price + 'å…ƒæ‹¼' + 'ã€' + supp_label + 'æ­£å“' + data.type2 + 'ã€‘,' + 'ä¸“æŸœä»·' + this.data.shop.shop_se_price + 'å…ƒ!';
      if (shop_type == 2 || shop_type == 3) {
        shareJson = 'å¿«æ¥' + this.data.wxcx_shop_group_price + 'å…ƒæ‹¼' + 'ã€' + this.data.shop.shop_name + 'ã€‘,' + 'åŸä»·' + this.data.shop.shop_se_price + 'å…ƒ!';
      }
      this.data.shareTitle = shareJson;

      this.setData({
        isOneShowMoney: sharemoney
      })
    }
  },

  clickShare: function () { //åˆ†äº«æŒ‰é’®
    buttonClcik = 1;
    if (app.globalData.user) {
      this.toshareData(false);
    }
  },
  toshareData: function (share) {
    var shareJson = this.data.shareJson;
    var supp_label = 'è¡£è ';
    if (this.data.shop.supp_label) {
      supp_label = this.data.shop.supp_label;
    }
    var str1 = shareJson.replace('\$\{replace\}', this.data.shop_se_price);
    var str2 = str1.replace('\$\{replace\}', supp_label);
    var str3 = str2.replace('\$\{replace\}', '' + this.data.shop.shop_name);
    var str4 = str3.replace('\$\{replace\}', '' + this.data.shop_se_price);
    this.data.shareTitle = str4;
    this.setData({
      isShowShare: share
    })

    this.top_shopHttp();
  },
  confirmShare: function (e) { //ç¡®è®¤åˆ†äº«
    
    var other_userid = e.detail.value.message;
    this.setData({
      isShowShare: false,
      other_userid: other_userid,
      isFreelingShareFlag:true
    })
    formId = e.detail.formId;
    if (app.globalData.user != null) {
      util.httpPushFormId(e.detail.formId);
    }
  },
  cancelShare: function (e) { //å–æ¶ˆåˆ†äº«æŒ‰é’®
    this.setData({
      isShowShare: false
    })
    formId = e.detail.formId;
    if (app.globalData.user != null) {
      util.httpPushFormId(e.detail.formId);
    }
  },

  selectClick: function (e) {
    formId = e.detail.formId;
    if (app.globalData.user != null) {
      util.httpPushFormId(e.detail.formId);
    }
  },
  selectColorClick: function (event) { //é€‰æ‹©é¢œè‰²
    var that = this;
    const index = event.currentTarget.dataset.index;
    this.setData({
      colorIndex: index,
      selectColorId: event.currentTarget.dataset.id
    })
    this.showShopStock(that.data.selectColorId, that.data.selectSizeId);
  },
  selectSizeClick: function (event) { //é€‰æ‹©å°ºå¯¸
    var that = this;
    const index = event.currentTarget.dataset.index;
    this.setData({
      sizeIndex: index
    })
    this.showShopStock(that.data.selectColorId, that.data.selectSizeId);
  },

  //é€‰æ‹©å°ºå¯¸å’Œé¢œè‰²2018-5-24
  selectColorSizeClick: function (event) {
    var that = this;
    const stockindex = event.currentTarget.dataset.stockindex;
    const index = event.currentTarget.dataset.index;

    var selectIndexs = that.data.selectIndexs;
    var selectColor_SizeIds = that.data.selectColor_SizeIds;
    selectIndexs[stockindex] = index;
    selectColor_SizeIds[stockindex] = event.currentTarget.dataset.id;

    this.setData({
      colorIndex: index,
      selectIndexs: selectIndexs,
      selectColor_SizeIds: selectColor_SizeIds
    })
    this.showNewShopStock(that.data.selectIndexs, that.data.selectColor_SizeIds);
  },


  toBuyClick: function () { //ç«‹å³è´­ä¹°
    var that = this;
    buttonClcik = 2;
    that.setData({
      isOneYuanClick: false,
      isfreeLingClick: false,
    });

    //å•ç‹¬è´­ä¹°
    if(!that.data.isKT && !that.data.task_freeling != 'freeling' && that.data.is_vip >0)
    {
      that.setData({
        isOnlyBuyClick: true
      })
    }

    if (app.globalData.user && app.globalData.user.userToken != undefined) {
      if (this.data.isNewUserFlag) {
        if (this.data.isOreadyToken) { //å·²ç»ç™»å½•
          wx.redirectTo({
            url: "../../sign/sign?firstLogin=true",
          })

        } else {
          util.toAuthorizeWx(function (isSuccess) {
            if (isSuccess) {
              that.data.isOreadyToken = true;
              if (app.globalData.user && app.globalData.user.userToken && !app.globalData.user.firstLogin) {
                wx.redirectTo({
                  url: "../../sign/sign?firstLogin=true",
                })
              }
            } else {
              return;
            }
          });
        }
        return;
      }
      var that = this;

      if (this.data.isSignClose) {
        this.setData({
          showDialog: true
        });
        if (that.data.stockTypeData.length == 0) {
          this.getData(2, function (data) {
            that.dealBackData(2, data);
          });
        } else {

          this.showNewShopStock(that.data.selectIndexs, that.data.selectColor_SizeIds);

        }
      } else {
        // that.buyOrder();
        that.gotobuy();
      }
    } else {

      //æŸ¥çœ‹ç”¨æˆ·æ˜¯å¦æˆæƒ
      wx.getSetting({
        success: res => {
          if (res.authSetting['scope.userInfo']) { //æˆæƒè¿‡
            //æˆæƒæˆåŠŸå»ç™»å½•
            wx.showLoading({ title: 'è¯·ç¨å', mask: true, })
            setTimeout(function () { wx.hideLoading(); }, 10000)

            app.New_userlogin(function (data) {
              wx.hideLoading();
            });
          }
        }
      })
    }
  },

  //é¦–é¡µ
  gotabshouye: function () {
    wx.switchTab({
      url: '../shouye',
    })
  },
  //æˆ‘çš„æœ€çˆ±
  gotabwode: function () {
    // wx.switchTab({
    //   url: '../../mine/mine',
    // })
    buttonClcik = 4;
    if (!shop_likeClick) {
      var shop_likeurl = this.data.shop_like ? 'like/delLike?' : 'like/addLike?';
      var shop_like = this.data.shop_like;
      var shop_likeimage = this.data.shop_like ? 'shop_newaddunlike' : 'shop_newaddlike';
      var that = this;
      util.handle_shoplike(shop_likeurl, that.data.shop_code, function (data) {
        if (data.status == 1) {
          if (!shop_like) {
            that.xuanfuHongBaoAnimation();
          } else {
            setTimeout(function () {
              shop_likeClick = false;
            }, 3000);

            that.showToast('ä¸å†å–œæ¬¢æ­¤å®è´', 2000);
          }

          that.setData({
            shop_like: !shop_like,
            shop_likeimage: shop_likeimage
          })
        }
      });
    }
  },

  //çº¢åŒ…ç¼©æ”¾åŠ¨ç”»
  hongBaoAnimation: function () {
    var circleCount = 0;
    // å¿ƒè·³çš„å¤–æ¡†åŠ¨ç”»  
    this.animationMiddleHeaderItem = wx.createAnimation({
      duration: 1000, // ä»¥æ¯«ç§’ä¸ºå•ä½  
      timingFunction: 'linear',
      delay: 100,
      transformOrigin: '50% 50%',
      success: function (res) {
        console.log("***************************");
      }
    });
    animationTimer = setInterval(function () {
      if (circleCount % 2 == 0) {
        this.animationMiddleHeaderItem.scale(1.15).step();
      } else {
        this.animationMiddleHeaderItem.scale(1.0).step();
      }

      this.setData({
        animationMiddleHeaderItem: this.animationMiddleHeaderItem.export() //è¾“å‡ºåŠ¨ç”»
      });

      circleCount++;
      if (circleCount == 1000) {
        circleCount = 0;
      }
    }.bind(this), 1000);
  },
  //åŠ å–œæ¬¢åŠ¨ç”»
  xuanfuHongBaoAnimation: function () {
    var that = this;
    shop_likeClick = true;
    that.setData({
      is_showShopAnimation: true
    })

    xuanfuanimationMiddleHeaderItem = wx.createAnimation({
      duration: 2000, // ä»¥æ¯«ç§’ä¸ºå•ä½  
      timingFunction: 'linear',
      delay: 10,
      transformOrigin: '50% 50%',
      success: function (res) {
        console.log("***************************");
      }
    });

    setTimeout(function () {
      xuanfuanimationMiddleHeaderItem.scale(1.5).step({
        duration: 500
      }).scale(1.0).step({
        duration: 500
      }).scale(0.0).step({
        duration: 1000
      });

      that.setData({
        xuanfuanimationMiddleHeaderItem: xuanfuanimationMiddleHeaderItem.export() //è¾“å‡ºåŠ¨ç”»
      });
    }.bind(that), 0)

    setTimeout(function () {
      shop_likeClick = false;
      clearInterval(xuanfuanimationMiddleHeaderItem);
      that.setData({
        xuanfuanimationMiddleHeaderItem: '',
        is_showShopAnimation: false
      })
    }, 2500);
  },
  oneBuyClick: function (e) { //1å…ƒè´­ä¹°

    var that = this;
    buttonClcik = 3;
    if (e != undefined) {
      that.data.currentTargetclick = e.currentTarget.dataset.click;
    }

    //å½“æ˜¯ç‚¹å‡»ä¼šå‘˜å…è´¹é¢†æ—¶ å•†å“å±æ€§æ¡†ä¸å±•ç¤ºä»·æ ¼
    var isfreeLingClick = (that.data.currentTargetclick != "fightClick") ? true : false;
    if (that.data.returnTwoText == 'ä¼šå‘˜å…è´¹é¢†' || that.data.returnTwoText == 'å…è´¹å‚å›¢') {
      isfreeLingClick = true;
    }

    that.setData({
      isOneYuanClick: true,
      isfreeLingClick: isfreeLingClick,
      isOnlyBuyClick:false,
      buyCount: '1',
    });

    if (app.globalData.user && app.globalData.user.userToken != undefined) {
      var that = this;
      //è·å–æ˜¯å¦æ˜¯ä¼šå‘˜
      // util.get_vip(function (data) {
      //   var is_vip = data.isVip != undefined ? data.isVip : 0; //0ä¸æ˜¯ 1æ˜¯
      //   var commingSign = wx.getStorageSync('commingSign');
        //å¦‚æœç”¨æˆ·ä¸”ä¸æ˜¯ä¼šå‘˜ä¸”æ²¡è¿›å…¥è¿‡èµšé’±é¡µä¸”ä¸æ˜¯å‚å›¢å¼¹æ­¤æ¡†
      //   if (commingSign != true && is_vip <= 0 && !that.data.isShowJoinGroup) {
      //     that.setData({
      //       redHongbaoNewuserShow: true
      //     })
      //     that.data.noMemberHomePage3ElasticFrame--;
      //     wx.setStorageSync('noMemberHomePage3ElasticFrame', that.data.noMemberHomePage3ElasticFrame);
      //   } else {
      //     if (!that.data.firstredHongbaoNewuserShow) {
      //       that.gotobuy();
      //     }
      //   }
      // })

      if (!that.data.firstredHongbaoNewuserShow) {
        that.gotobuy();
      }
    } else {

      //æŸ¥çœ‹ç”¨æˆ·æ˜¯å¦æˆæƒ
      wx.getSetting({
        success: res => {
          if (res.authSetting['scope.userInfo']) { //æˆæƒè¿‡
            //æˆæƒæˆåŠŸå»ç™»å½•
            wx.showLoading({ title: 'è¯·ç¨å', mask: true, })
            setTimeout(function () { wx.hideLoading(); }, 10000)

            app.New_userlogin(function (data) {
              wx.hideLoading();
            });
          }
        }
      })
    }
  },
  gotobuy: function () {
    var that = this;

    if (that.data.roll_code.length > 8) {
      var userid = "";
      if (app.globalData.user != null) {
        userid = app.globalData.user.user_id;
      }
      if (that.data.fightUserid == userid && that.data.fightUserid && userid) {
        if (that.data.rnum == 0 || that.data.SurplusTime <= 0) {
          that.buyOrder(); //è¿‡æœŸäº†é‡æ–°å¼€å›¢
        } else{
          that.showToast('å›¢é•¿ä¸èƒ½å‚ä¸è‡ªå·±çš„å›¢å“¦ï¼', 2000);
        }
          
      } else {
        that.buyOrder();
      }
    } else
      that.buyOrder();
  },
  closeClick: function (e) {
    formId = e.detail.formId;
    util.httpPushFormId(formId);
    this.closeSkuDialog();
  },
  closeSkuDialog: function () { //å…³é—­ç«‹å³è´­ä¹°å¼¹çª—
    //chushihua shuju
    var that = this;
    if (that.data.stockColorData.length > 0) {
      that.data.selectColorId = that.data.stockColorData[0].id;
    } else {
      that.data.selectColorId = '';
    }
    if (that.data.stockSizeData.length > 0) {
      that.data.selectSizeId = that.data.stockSizeData[0].id;
    } else {
      that.data.selectSizeId = '';
    }
    if (that.data.stockColorSizeData.length > 0) {
      for (var k = 0; k < that.data.selectColor_SizeIds.length; k++) {
        that.data.selectColor_SizeIds[k] = that.data.stockColorSizeData[k][0].id;
        that.data.selectIndexs[k] = 0;
      }
    }

    this.setData({
      showDialog: false,
      selectColorId: that.data.selectColorId,
      selectSizeId: that.data.selectSizeId,
      colorIndex: 0,
      sizeIndex: 0,
      selectColor_SizeIds: that.data.selectColor_SizeIds,
      selectIndexs: that.data.selectIndexs
    });
  },

  btnReduceClick: function () { //è´­ä¹°æ•°é‡å‡

    var that = this;
    that.data.buyCount = that.data.buyCount - 1;
    if (that.data.buyCount < 1) {
      that.data.buyCount = 1;
    }
    this.setData({
      buyCount: that.data.buyCount
    });

  },
  btnAddClick: function () { //è´­ä¹°æ•°é‡åŠ 
    var that = this;
    if (this.data.stockCount > that.data.buyCount) {
      if (!this.data.isOneYuanClick) {
        that.data.buyCount = that.data.buyCount + 1;
      }
    } else {
      this.showToast('åº“å­˜ä¸è¶³ï¼', 3000);
    }
    if (that.data.buyCount > 2) {
      that.data.buyCount = 2;
      this.showToast('æŠ±æ­‰ï¼Œæ•°é‡æœ‰é™ï¼Œæœ€å¤šåªèƒ½è´­ä¹°ä¸¤ä»¶å™¢ï¼', 3000);
    } else if (this.data.isOneYuanClick) {
      that.data.buyCount = 1;
      this.showToast('1å…ƒè´­å•æ¬¡åªèƒ½é€‰æ‹©1ä»¶å“¦~', 3000);
    }
    this.setData({
      buyCount: that.data.buyCount
    });
  },
  onTapClick: function (event) { //è¯¦æƒ…ã€å‚æ•°ã€è¯„ä»·çš„åˆ‡æ¢
    var thiscopy;
    thiscopy = this;
    const index = event.currentTarget.dataset.index;
    if (thiscopy.data.activityIndex == index) {
      return;
    }

    this.setData({
      activityIndex: index
    });
    if (index == 2) {
      // this.loadProgress();
      this.setProgress();
      var that = this;
      if (that.data.curPage == 1 && that.data.evaluateData.length == 0) {
        that.getData(1, function (data) {
          that.dealBackData(1, data)
        });
      }
    }
  },
  // é¡µé¢é‡Œçš„ç‚¹å‡»   ----end
  dateFormat: function (data) {
    var that = this;
    for (var i = 0; i < data.length; i++) {
      var date = that.getMyDate(data[i].add_date);
      data[i].add_date = date;

      if (data[i].comment_type == 1) {
        data[i].comment_type = 'å¥½è¯„';
      } else if (data[i].comment_type == 2) {
        data[i].comment_type = 'ä¸­è¯„';
      } else if (data[i].comment_type == 3) {
        data[i].comment_type = 'å·®è¯„';
      }
    }
    return data;
  },
  // åˆ‡å‰²å­—ç¬¦ä¸²å¹¶æ·»åŠ æ–°å­—æ®µ
  cutShopCode: function () {
    var thiscopy;
    thiscopy = this;
    var shop_code_cut = '';
    shop_code_cut = thiscopy.data.shop.shop_code.substring(1, 4);
    thiscopy.data.shop["cut_shop_code"] = shop_code_cut;
    var link = thiscopy.data.Upyun + shop_code_cut + '/' + thiscopy.data.shop.shop_code + '/';
    var bigImage = thiscopy.data.Upyun + shop_code_cut + '/' + thiscopy.data.shop.shop_code + '/' + thiscopy.data.shop.def_pic;

    thiscopy.setData({
      shop: thiscopy.data.shop,
      picLink: link,
      bigImage: bigImage
    })
    this.getCanvasPictiure();
  },

  // è®¾ç½®è¿›åº¦æ¡
  setProgress: function () {
    var that = this;
    if (that.data.postlist.eva_count == '0') {
      this.setData({
        progress_color: "100",
        progress_type: '100',
        progress_work: '100',
        progress_cost: '100',
      });
    } else {
      var color_count = that.data.postlist.color_count * 100;
      var type_count = that.data.postlist.type_count * 100;
      var work_count = that.data.postlist.work_count * 100;
      var cost_count = that.data.postlist.cost_count * 100;
      var eva_count = that.data.postlist.eva_count;
      var color = color_count / eva_count > 100 ? 100 : color_count / eva_count;
      var progress_type = type_count / eva_count > 100 ? 100 : type_count / eva_count;
      var work = work_count / eva_count > 100 ? 100 : work_count / eva_count;
      var cost = cost_count / eva_count > 100 ? 100 : cost_count / eva_count;

      this.setData({
        progress_color: parseInt(color),
        progress_type: parseInt(progress_type),
        progress_work: parseInt(work),
        progress_cost: parseInt(cost),
      });
    }
  },
  //è·å¾—å¹´æœˆæ—¥      å¾—åˆ°æ—¥æœŸoTime  
  getMyDate: function (str) {
    var oDate = new Date(str);
    var oYear = oDate.getFullYear();
    var oMonth = oDate.getMonth() + 1;
    var oDay = oDate.getDate();
    // oHour = oDate.getHours(),
    // oMin = oDate.getMinutes(),
    // oSen = oDate.getSeconds(),
    var oTime = oYear + '-' + this.getzf(oMonth) + '-' + this.getzf(oDay); //æœ€åæ‹¼æ¥æ—¶é—´  
    return oTime;
  },
  //è¡¥0æ“ä½œ  
  getzf: function (num) {
    if (parseInt(num) < 10) {
      num = '0' + num;
    }
    return num;
  },
  // å››èˆäº”å…¥ Dightè¦æ ¼å¼åŒ–çš„ æ•°å­—ï¼ŒHowè¦ä¿ç•™çš„å°æ•°ä½æ•°ã€‚
  ForDight: function () { //Dight, How
    var that = this;
    var shop_se_price;
    if (this.data.isSignActiveShop) {
      shop_se_price = that.data.shop.shop_se_price;
    } else {
      if (this.data.isNewUserFlag) {
        // shop_se_price = that.data.shop.shop_se_price * that.data.shop.shop_rebate;
        shop_se_price = that.data.shop.shop_se_price;
      } else {
        shop_se_price = that.data.shop.shop_se_price;
      }

    }
    var shop_price = that.data.shop.shop_price * 1;
    if (this.data.isNewUserFlag) {
      that.data.shop_se_price = (shop_se_price * 1).toFixed(0);
      that.data.shop_price = shop_price.toFixed(0);
      that.data.discount = (shop_se_price * 10 / shop_price).toFixed(0);

      if (oneYuanData == 0) //1å…ƒè´­
      {
        // var se_price = app.globalData.oneYuanValue;
        var se_price = this.data.wxcx_shop_group_price;
        that.data.shop_se_price = (se_price * 1).toFixed(1);
        that.data.shop_price = (shop_se_price * 1).toFixed(1);

        if (app.globalData.oneYuanFree > 0) //æ–°ç”¨æˆ·0å…ƒè´­
        {
          that.data.shop_se_price = '0.0';
        }
      } else {
        that.data.shop_se_price = (shop_se_price * 1).toFixed(1);
        that.data.shop_price = shop_price.toFixed(1);

      }
      that.data.discount = (shop_se_price * 10 / shop_price).toFixed(1);

      console.log('ä»·æ ¼=' + that.data.shop_se_price + '||' + that.data.shop_price);
    } else {

      if (oneYuanData == 0) //1å…ƒè´­
      {
        // var se_price = app.globalData.oneYuanValue;
        var se_price = this.data.wxcx_shop_group_price;
        that.data.shop_se_price = (se_price * 1).toFixed(1);
        that.data.shop_price = (shop_se_price * 1).toFixed(1);

        if (app.globalData.oneYuanFree > 0) //æ–°ç”¨æˆ·0å…ƒè´­
        {
          that.data.shop_se_price = '0.0';
        }

      } else {
        that.data.shop_se_price = (shop_se_price * 1).toFixed(1);
        that.data.shop_price = shop_price.toFixed(1);
      }
      that.data.discount = (shop_se_price * 10 / shop_price).toFixed(1);
    }

    var reduceMoney = that.data.reduceMoney > that.data.shop_price ? that.data.shop_price : that.data.reduceMoney;
    console.log('ä»·æ ¼=' + that.data.shop_se_price + '||' + that.data.shop_price);
    var save_money = ((shop_price - shop_se_price) * 1).toFixed(1);
    this.setData({
      // shop_se_price: that.data.shop_se_price,
      // shop_price: (that.data.shop.shop_price * 1).toFixed(1),
      discount: that.data.discount,
      detaildiscount: that.data.memberdiscount > 0 ? that.data.memberdiscount : that.data.discount,
      reduceMoney: (reduceMoney * 1).toFixed(1),
      save_money: save_money,
    })
    // return Dight;
  },
  onReady: function () {
    if (this.data.isShareFlag) {
      this.setData({
        isShowSignBottomAd: true,
        isSHowAdFlag: true,
      })
    }
    // é¡µé¢æ¸²æŸ“å®Œæˆ  
    // this.loadProgress();
    // this.setProgress();
    // this.getScrollOffset();

  },
  getScrollOffset: function () {
    wx.createSelectorQuery().selectViewport().scrollOffset(function (res) {
      // res.id      // èŠ‚ç‚¹çš„ID
      // res.dataset // èŠ‚ç‚¹çš„dataset
      // res.scrollLeft // èŠ‚ç‚¹çš„æ°´å¹³æ»šåŠ¨ä½ç½®
      // res.scrollTop  // èŠ‚ç‚¹çš„ç«–ç›´æ»šåŠ¨ä½ç½®
      console.log("res.scrollTop", res.id)
    }).exec()
  },
  getRect: function () {
    var that = this;
    wx.createSelectorQuery().select('.bottom-image-pic').boundingClientRect(function (rect) {
      // rect.id      // èŠ‚ç‚¹çš„ID
      // rect.dataset // èŠ‚ç‚¹çš„dataset
      // rect.left    // èŠ‚ç‚¹çš„å·¦è¾¹ç•Œåæ ‡
      // rect.right   // èŠ‚ç‚¹çš„å³è¾¹ç•Œåæ ‡
      // rect.top     // èŠ‚ç‚¹çš„ä¸Šè¾¹ç•Œåæ ‡
      // rect.bottom  // èŠ‚ç‚¹çš„ä¸‹è¾¹ç•Œåæ ‡
      // rect.width   // èŠ‚ç‚¹çš„å®½åº¦
      // rect.height  // èŠ‚ç‚¹çš„é«˜åº¦
      // console.log("rect.top", rect.top)
      // console.log("rect.height", rect.height) 
      if (rect.top <= -rect.height) {
        if (that.data.isFixFlag == false && that.data.isRecommendFix == false) {
          that.setData({
            isFixFlag: true,
            isSHowAdFlag: false,
          })
        }
      } else {
        if (that.data.isFixFlag == true && that.data.isRecommendFix == false) {
          that.setData({
            isFixFlag: false,
            // isSHowAdFlag: true,
          })
        }
      }
    }).exec()
  },
  getRect2: function () {
    var that = this;
    wx.createSelectorQuery().select('.shop-recommend-tv').boundingClientRect(function (rect) {
      if (rect.top <= -rect.height) { //-rect.height
        if (that.data.isRecommendFix == false) {
          that.setData({
            isRecommendFix: true,
            isFixFlag: false,
            isSHowAdFlag: false,
          })
        }
      } else {
        if (that.data.isRecommendFix == true) {
          that.setData({
            isRecommendFix: false,
            isFixFlag: false,
            // isSHowAdFlag: true,
          })
        }
      }
    }).exec()
  },
  onScroll: function (e) {
    this.getRect();
    this.getRect2();
  },
  getData: function (flag, fun) { //flag:0ï¼Œè¯¦æƒ…æ¥å£1;1ï¼Œè¯„è®ºæ¥å£;2ï¼Œå•†å“å±æ€§æ¥å£
    wx.showNavigationBarLoading();
    var thiscopy;
    thiscopy = this;
    var requestUrl = config.Host;
    var that = this;
    if (null != app.globalData.user && app.globalData.user != undefined) {
      token = app.globalData.user.userToken;
    }
    thiscopy.setData({
      token: token
    });

    if (flag == 0) { //è¯¦æƒ…æ¥å£
      if (null != thiscopy.data.token) {
        requestUrl = requestUrl + 'shop/query?token=' + thiscopy.data.token;
        requestUrl = requestUrl + "&code=" + this.data.shop_code + this.data.Version;
        console.log("è¯¦æƒ…æ¥å£**********" + requestUrl);
        util.httpNeedLogin(requestUrl, function (data) {
          fun(data);
        }, function () {
          that.getData(0, function (data) {
            that.dealBackData(0, data);
          });
        })
        return;
      } else {
        requestUrl = requestUrl + 'shop/queryUnLogin?';
        requestUrl = requestUrl + "&code=" + this.data.shop_code + this.data.Version;
      }
    } else if (flag == 1) { //è¯„è®ºæ¥å£

      requestUrl = requestUrl + "shopComment/selCommentByShop?" + this.data.Version + "&page=" + this.data.curPage + "&rows=" + this.data.pageSize + "&shop_code=" + this.data.shop_code;
    } else if (flag == 2) { //å•†å“å±æ€§æ¥å£ 
      requestUrl = requestUrl + "shop/queryAttr?shop_code=" + this.data.shop_code + this.data.Version + "&find=false"
    } else if (flag == 3) { //åˆ†äº«å•†å“å›¾
      requestUrl = requestUrl + 'initiateApp/queryShareLifePic?' + this.data.Version;
    } else if (flag == 5) { //æ¨èåˆ—è¡¨

      if (token != undefined && token != '') {
        requestUrl = requestUrl + "shop/queryConUnLogin?" + this.data.Version + "&pager.curPage=" + this.data.recommendPage + "&pager.pageSize=30" + "&type1=" + this.data.recommend_type1 + "&type_name=" + this.data.recommend_type_name + '&token=' + token;
      } else {
        requestUrl = requestUrl + "shop/queryConUnLogin?" + this.data.Version + "&pager.curPage=" + this.data.recommendPage + "&pager.pageSize=30" + "&type1=" + this.data.recommend_type1 + "&type_name=" + this.data.recommend_type_name;
      }
    } else if (flag == 6) { //å¼€å…³ 
      requestUrl = requestUrl + 'cfg/getCurrWxcxType?token=' + this.data.token + this.data.Version;
    } else if (flag == 7) { //ç‰¹ä»·å•†å“
      if (null != thiscopy.data.token) {
        requestUrl = requestUrl + 'shop/queryPackage?token=' + thiscopy.data.token;
        requestUrl = requestUrl + "&code=" + this.data.shop_code + this.data.Version;
        console.log("è¯¦æƒ…æ¥å£**********" + requestUrl);
        util.httpNeedLogin(requestUrl, function (data) {
          fun(data);
        }, function () {
          that.getData(0, function (data) {
            that.dealBackData(0, data);
          });
        })
        return;
      } else {
        requestUrl = requestUrl + 'shop/queryUnLogin?';
        requestUrl = requestUrl + "&code=" + this.data.shop_code + this.data.Version;
      }
    }
    util.http(requestUrl, function (data) {
      // console.log('--------', data)
      fun(data)
    })

    // wx.request({
    //   url: requestUrl,
    //   // method: 'POST',
    //   data: jsonParames,
    //   header: {
    //     'content-type': 'application/json' // é»˜è®¤å€¼
    //     // "Content-Type": "application/x-www-form-urlencoded"
    //   },
    //   success: function (res) {
    //     wx.hideNavigationBarLoading();
    //     fun(res.data)
    //   }

    // })
  },

  getDataJson: function (flag, fun) { //è·å–åˆ†äº«æ–‡æ¡ˆ
    wx.showNavigationBarLoading();
    var thiscopy;
    thiscopy = this;
    var requestUrl = '';
    var jsonParames = {};
    requestUrl = config.Upyun + "paperwork/paperwork.json";
    var tongji_url = "default";
    var tongji_parameter = "default"
    var mUrl = requestUrl + "";

    if (mUrl) {
      var tepm = mUrl.split("?");
      tongji_url = mUrl.split("?")[0]
      tongji_url = tongji_url.replace(config.Host, "");
      tongji_url = tongji_url.replace(config.PayHost, "")
      tongji_url = tongji_url.replace(config.Upyun, "")

      tongji_url = tongji_url.replace("//", "/")

      tongji_parameter = mUrl.substring(mUrl.indexOf("?") + 1, mUrl.length - 1)

      if (!tongji_url) {
        tongji_url = "default"
      }
      if (!tongji_parameter) {
        tongji_parameter = "default"
      }
    }

    wx.request({
      url: requestUrl,
      header: {
        'content-type': 'application/json' // é»˜è®¤å€¼
      },
      success: function (res) {
        app.mtj.trackEvent('i_f_success_count', {
          i_f_name: tongji_url,
          // i_f_from: "10",
        });
        wx.hideNavigationBarLoading();
        fun(res.data)
      },
      fail: function (error) {
        app.mtj.trackEvent('i_f_error_count', {
          i_f_name: tongji_url,
          // i_f_from: "10",
        });
      }
    })
  },


  /**
   * é¡µé¢ä¸Šæ‹‰è§¦åº•äº‹ä»¶çš„å¤„ç†å‡½æ•°
   */
  onReachBottom: function () {
    var that = this;

    if ((isForceLook || isForceLookLimit) && that.data.activityIndex == 0) {
      // that.scanFinish();
      if (firstCome) {
        firstCome = false;
        publicUtil.scanFinish(that, isForceLook, isForceLookLimit, singvalue);
      }
    }
    if (that.data.activityIndex == 0) {
      that.getData(5, function (data) {
        that.dealBackData(5, data);
      })
    }
    if (that.data.activityIndex == 2) {
      that.data.curPage = that.data.curPage + 1;
      that.getData(1, function (data) {
        if (data.comments.length == 0) {
          that.data.curPage = that.data.curPage - 1;
        }
        var dealData = that.dateFormat(data.comments);
        for (var i = 0; i < dealData.length; i++) {
          var pic = dealData[i].pic;
          var picData = [];
          try {
            if (pic != null && '' != pic) {
              picData = pic.split(",");
              dealData[i]['pic_data'] = picData;
            }
            if (dealData[i].suppComment != undefined && dealData[i].suppComment != null) {
              dealData[i]['frist_replay'] = (dealData[i].suppComment)[0].supp_content;
            }
            if (dealData[i].suppEndComment != undefined && dealData[i].suppEndComment != null) {
              dealData[i]['second_replay'] = (dealData[i].suppEndComment)[0].supp_content;
            }

            if (dealData[i].comment != undefined && dealData[i].comment != null) {
              dealData[i]['second_judge'] = dealData[i].comment.content;

              var pic2 = (dealData[i].comment)[0].pic;
              var picData2 = [];
              if (pic2 != null && '' != pic2 && pic2 != undefined) {
                picData2 = pic2.split(",");
                dealData[i]['pic_data2'] = picData2;
              }
            }
          } catch (e) {

          }
        }

        var dataTemp = that.data.evaluateData.concat(dealData);
        that.setData({
          evaluateData: dataTemp,
        })

      });
    }

  },
  toLoadMore: function () {
    var that = this;

    if ((isForceLook || isForceLookLimit) && that.data.activityIndex == 0) {
      // that.scanFinish();
      if (firstCome) {
        firstCome = false;
        publicUtil.scanFinish(that, isForceLook, isForceLookLimit, singvalue);
      }
    }
    // recommendLoadFlag: true,
    //   evaluateLoadMore:true,
    if (this.data.recommendLoadFlag && this.data.activityIndex == 0) {
      this.data.recommendLoadFlag = false;
      this.getData(5, function (data) {
        that.dealBackData(5, data);
      })
    }
    if (this.data.evaluateLoadMore && that.data.activityIndex == 2) {
      this.data.evaluateLoadMore = false;
      that.data.curPage = that.data.curPage + 1;
      that.getData(1, function (data) {
        if (data && data.comments) {
          if (data.comments.length == 0) {
            that.data.curPage = that.data.curPage - 1;
          }
          var dealData = that.dateFormat(data.comments);
          for (var i = 0; i < dealData.length; i++) {
            var pic = dealData[i].pic;
            var picData = [];
            try {
              if (pic != null && '' != pic) {
                picData = pic.split(",");
                dealData[i]['pic_data'] = picData;
              }
              if (dealData[i].suppComment != undefined && dealData[i].suppComment != null) {
                dealData[i]['frist_replay'] = (dealData[i].suppComment)[0].supp_content;
              }
              if (dealData[i].suppEndComment != undefined && dealData[i].suppEndComment != null) {
                dealData[i]['second_replay'] = (dealData[i].suppEndComment)[0].supp_content;
              }

              if (dealData[i].comment != undefined && dealData[i].comment != null) {
                dealData[i]['second_judge'] = dealData[i].comment.content;

                var pic2 = (dealData[i].comment)[0].pic;
                var picData2 = [];
                if (pic2 != null && '' != pic2 && pic2 != undefined) {
                  picData2 = pic2.split(",");
                  dealData[i]['pic_data2'] = picData2;
                }
              }
            } catch (e) {

            }
          }


          var dataTemp = that.data.evaluateData.concat(dealData);
          that.setData({
            evaluateData: dataTemp,
          })
        } else {
          that.data.curPage = that.data.curPage - 1;
        }
        that.data.evaluateLoadMore = true;
      });
    }
  },
  loadProgress: function () {
    this.canvasCircular('canvasColor'); //è‰²å·®
    this.canvasCircular('canvasType'); //ç‰ˆå‹
    this.canvasCircular('canvasWorkmanship'); //åšå·¥
    this.canvasCircular('canvasCostPerformance'); //æ€§ä»·æ¯”
  },
  canvasCircular: function (canvasArc) {
    var cxt_arc = wx.createCanvasContext(canvasArc); //åˆ›å»ºå¹¶è¿”å›ç»˜å›¾ä¸Šä¸‹æ–‡contextå¯¹è±¡ã€‚  
    var x = 34,
      y = 34,
      lineWidth = 4,
      radius = 30;
    cxt_arc.setLineWidth(lineWidth);
    cxt_arc.setStrokeStyle('#d2d2d2');
    cxt_arc.setLineCap('round')
    cxt_arc.beginPath(); //å¼€å§‹ä¸€ä¸ªæ–°çš„è·¯å¾„  
    cxt_arc.arc(x, y, radius, 0, 2 * Math.PI, false); //è®¾ç½®ä¸€ä¸ªåŸç‚¹(106,106)ï¼ŒåŠå¾„ä¸º100çš„åœ†çš„è·¯å¾„åˆ°å½“å‰è·¯å¾„  
    cxt_arc.stroke(); //å¯¹å½“å‰è·¯å¾„è¿›è¡Œæè¾¹  

    cxt_arc.setLineWidth(lineWidth);
    cxt_arc.setStrokeStyle('#ff3f8b');
    cxt_arc.setLineCap('round');
    cxt_arc.beginPath(); //å¼€å§‹ä¸€ä¸ªæ–°çš„è·¯å¾„  
    cxt_arc.arc(x, y, radius, -Math.PI * 1 / 2, Math.PI * 1, false);
    cxt_arc.stroke(); //å¯¹å½“å‰è·¯å¾„è¿›è¡Œæè¾¹  

    cxt_arc.draw();
  },













  // //æµè§ˆXä»¶ä»»åŠ¡
  // scanFinish: function () {
  //   var that = this;
  //   if (firstCome) {
  //     firstCome = false;
  //     that.setData({ is_look: false });

  //     var signUrl = config.Host + "signIn2_0/signIning" +
  //       "?token=" + token +
  //       "&share=false" +
  //       "&index_id=" + xShop_signIndex +
  //       "&day=" + wx.getStorageSync("SIGN_DAY") + config.Version;

  //     if (isForceLook) {
  //       var forcelookNum = 0;
  //       var forceLookXShopNumKey = xShop_signIndex + "forceLookXShopNum";
  //       var dataString = new Date().toDateString();

  //       forcelookNum = wx.getStorageSync(forceLookXShopNumKey);

  //       if (!forcelookNum || wx.getStorageSync("forcelookNowTime") !== dataString) {
  //         forcelookNum = 0;
  //       }
  //       forcelookNum++;
  //       wx.setStorageSync("forcelookNowTime", dataString);

  //       if (xShop_doNum > 1) {// éœ€è¦å¥–åŠ±åˆ†å¤šæ¬¡å‘æ”¾
  //         that.signForceLook(forceLookXShopNumKey, forcelookNum, signUrl);
  //       } else {

  //         if (forcelookNum < singvalue) {
  //           wx.setStorageSync(forceLookXShopNumKey, forcelookNum);
  //           var showText = "å†æµè§ˆ" + (singvalue - forcelookNum) + "ä»¶å³å¯å®Œæˆä»»åŠ¡å–”~"
  //           that.showToast(showText, 4000);

  //         } else if (forcelookNum >= singvalue) {
  //           that.signForceLook(forceLookXShopNumKey, forcelookNum, signUrl);
  //         }
  //       }
  //     } else if (isForceLookLimit) {

  //       var forcelookLimitNum = 0;
  //       var forceLookLimitXShopNumKey = xShop_signIndex + "forceLookLimitXShopNum";
  //       var dataString = new Date().toDateString();

  //       forcelookLimitNum = wx.getStorageSync(forceLookLimitXShopNumKey);

  //       if (!forcelookLimitNum || wx.getStorageSync("nowTimeForcelookLimit") !== dataString) {
  //         forcelookLimitNum = 0;
  //       }

  //       wx.setStorageSync("nowTimeForcelookLimit", dataString);

  //       if (forcelookLimitNum / singvalue >= xShop_doNum
  //         || xShop_complete) {
  //         //æµè§ˆ å¥–åŠ±é¢åº¦ è¾¾åˆ°ä¸Šé™
  //         xShop_complete = true;
  //         // wx.showModal({
  //         //   title: "å®Œæˆæµè§ˆä»»åŠ¡~",
  //         //   content: "ä»Šæ—¥çš„æµè§ˆå¥–åŠ±å·²è¾¾ä¸Šé™ï¼Œè®°å¾—æ˜å¤©å†æ¥ã€‚",
  //         //   showCancel: false,
  //         //   confirmColor: "#FF3F8B"
  //         // });
  //         that.setData({
  //           signFinishShow: true,
  //           signFinishDialog: {
  //             top_tilte: "ä»»åŠ¡å®Œæˆï¼",
  //             tilte: "å®Œæˆæµè§ˆä»»åŠ¡~",
  //             contentText: "ä»Šæ—¥çš„æµè§ˆå¥–åŠ±å·²è¾¾ä¸Šé™ï¼Œè®°å¾—æ˜å¤©å†æ¥ã€‚",
  //             leftText: "ä»»åŠ¡åˆ—è¡¨",
  //             rigthText: "ä¹°ä¹°ä¹°"
  //           },
  //         });
  //         forcelookLimitNum++;
  //         wx.setStorageSync(forceLookLimitXShopNumKey, forcelookLimitNum);

  //       } else {

  //         if (forcelookLimitNum % singvalue + 1 < singvalue) {
  //           var showText = "å†æµè§ˆ" + (singvalue - (forcelookLimitNum % singvalue + 1)) + "ä»¶å³å¯èµ¢å¾—" + xShop_jiangliValue +
  //             "å…ƒæç°é¢åº¦,ç»§ç»­åŠªåŠ›~"
  //           that.showToast(showText, 4000);
  //           forcelookLimitNum++;
  //           wx.setStorageSync(forceLookLimitXShopNumKey, forcelookLimitNum);

  //         } else if (forcelookLimitNum % singvalue + 1 == singvalue) {
  //           that.signForceLookLimit(forceLookLimitXShopNumKey, forcelookLimitNum, signUrl);
  //         }

  //       }
  //     }

  //   }

  // },

  // signForceLook: function (forceLookXShopNumKey, forcelookNum, signUrl) {
  //   var that = this;
  //   util.http(signUrl, function (data) {
  //     if (data == null || data.status != 1) {
  //       that.showToast(data.message, 3000);
  //       return;
  //     }

  //     wx.setStorageSync(forceLookXShopNumKey, forcelookNum);

  //     if (forcelookNum < singvalue) {//å°äºè¦æµè§ˆæ¬¡æ•°
  //       var showText = "æµè§ˆå®Œæˆï¼Œå¥–åŠ±" + xShop_jiangliValue + xShop_jiangliName + ",è¿˜æœ‰" + (singvalue - forcelookNum) + "æ¬¡æµè§ˆæœºä¼šå–”~";
  //       that.showToast(showText, 4000);

  //     } else if (forcelookNum >= singvalue) {//ä»»åŠ¡å®Œæˆ
  //       xShop_complete = true;
  //       var showText = xShop_jiangliValue * xShop_doNum + xShop_jiangliName + "å¥–åŠ±å·²ç»å­˜å…¥è´¦æˆ·ï¼Œèµ¶ç´§å»ä¹°ä¹°ä¹°å§~";
  //       // wx.showModal({
  //       //   title: "å®Œæˆã€" + xShop_shopsName + "ã€‘æµè§ˆ~",
  //       //   content: showText,
  //       //   showCancel: false,
  //       //   confirmColor: "#FF3F8B"
  //       // });
  //       // wx.removeStorageSync(shareXShopNumKey);
  //       that.setData({
  //         signFinishShow: true,
  //         signFinishDialog: {
  //           top_tilte: "ä»»åŠ¡å®Œæˆï¼",
  //           tilte: "å®Œæˆã€" + xShop_shopsName + "ã€‘æµè§ˆ~",
  //           contentText: showText,
  //           leftText: "ä»»åŠ¡åˆ—è¡¨",
  //           rigthText: "ä¹°ä¹°ä¹°"
  //         },
  //       });
  //     }
  //   })

  // },

  // signForceLookLimit: function (forceLookLimitXShopNumKey, forcelookLimitNum, signUrl) {
  //   var that = this;

  //   util.http(signUrl, function (data) {

  //     if (data == null || data.status != 1) {
  //       that.showToast(data.message, 3000);
  //       return;
  //     }
  //     var showText = xShop_jiangliValue + "å…ƒæç°é¢åº¦å·²ç»å­˜å…¥æ‚¨çš„ä½™é¢ï¼Œå†æµè§ˆ" + singvalue + "ä»¶å¯å†èµ¢å¾—" + xShop_jiangliValue + "å…ƒæç°é¢åº¦,ç»§ç»­åŠªåŠ›~";
  //     that.showToast(showText, 4000);
  //     forcelookLimitNum++;
  //     wx.setStorageSync(forceLookLimitXShopNumKey, forcelookLimitNum);
  //   })
  // },
  scan_tips_know: function () {
    this.setData({
      is_look: true,
      scanTipsShow: false
    });
  },
  dialog_close: function () {
    this.setData({
      signFinishShow: false
    });
  },
  btn_left: function () {
    this.setData({
      signFinishShow: false
    });
  },
  btn_rigth: function () {
    // this.toMainPager();
    this.toSignPager();
  },
  //å»é¦–é¡µ
  toMainPager: function () {
    wx.switchTab({
      url: '../shouye',
    });
  },

  //å»èµšé’±é¡µé¢
  toSignPager: function () {
    util.backToSignPager('../../sign/sign');
  },


  // å»ä¸‹å•
  buyToOrder: function (e) {
    var that = this;
    if (app.globalData.user != null && app.globalData.user.userToken != undefined) {
      util.httpPushFormId(e.detail.formId);

      if (this.data.stockCount == 0) {
        that.showToast('åº“å­˜ä¸è¶³ï¼', 3000);
        return;
      }
      var color = "";
      var size = "";
      var color_size = "";

      // if (this.data.stockColorData.length > 0) {
      //   color = this.data.stockColorData[this.data.colorIndex].name;
      // }
      // if (this.data.stockSizeData.length > 0) {
      //   size = this.data.stockSizeData[this.data.sizeIndex].name;
      // }

      // var color_sizeArr = [color, size];
      // for (var i = 0; i < this.data.stockNameData.length; i++) {
      //   color_size += this.data.stockNameData[i] + ":" + color_sizeArr[i] + " "
      // }

      for (var k = 0; k < this.data.selectColor_SizeIds.length; k++) {
        var index = this.data.selectIndexs[k];
        color_size += this.data.stockNameData[k];
        color_size += ':';
        color_size += this.data.stockColorSizeData[k][index].name;
        color_size += ' ';
      }

      var shopData = {
        stock_type_id: this.data.stock_type_id, //åº“å­˜id
        // shopPic: this.data.stockPicData[this.data.colorIndex],
        shopPic: this.data.Upyun + this.data.shop.shop_code.substring(1, 4) + '/' + this.data.shop.shop_code + '/' + this.data.shop.def_pic,
        shopCode: this.data.shop_code,
        shopName: this.data.shop.shop_name,
        shopNum: this.data.buyCount,
        color: color,
        size: size,
        color_size: color_size,
        shopOldPrice: this.data.shop.shop_price,
        // shopPrice: this.data.shop.shop_se_price,
        shopPrice: this.data.stock_shop_se_price,
        brander: this.data.shop.supp_label,
        assmble_price: this.data.shop.assmble_price,

      };
      var s = 0;
      var wxcx_shop_group_price = '';
      if (this.data.isActiveShop) {
        s = 2;
      } else if (this.data.isOneYuanClick) //1å…ƒè´­
      {
        s = (app.globalData.oneYuanFree > 0) ? 9 : 10;
        wxcx_shop_group_price = this.data.wxcx_shop_group_price;
      }

      var isTM = (shop_type == 2 || shop_type == 3) ? "0" : "0"; //1ç‰¹ä»·å•†å“ 2æ™®é€šå•†å“
      var isTM_Advertisement = shop_type == 3 ? true : false;
      var isTM_shoptype = isTM_Advertisement ? 'page4shop' : '';
      var vip_free = Number(this.data.ordervip_free) > 0 ? '1' : '0';
      wx.setStorageSync('shopData', shopData);
      if (this.data.isOneYuanClick) {//æ‹¼å›¢ç–¯æŠ¢

        if (this.data.roll_code) {//å‚å›¢

          var url = '../../listHome/order/confirmFight/confirmFight?' + 'buyType=' + s + '&wxcx_shop_group_price=' + wxcx_shop_group_price + "&roll_code=" + this.data.roll_code + "&isTM=" + isTM + "&isFirst=" + this.data.isFirst + "&isNew=" + this.data.isNew + "&is_redHongBao=" + this.data.is_redHongBao + '&vip_type=' + this.data.vip_type + '&vip_free=' + vip_free + '&free_page=' + this.data.free_page + '&is_vip=' + this.data.is_vip + '&first_group=' + this.data.first_group;
          wx.navigateTo({
            url: url
          })

        }
        else if (this.data.unvip_roll_code) {

          var url = '../../listHome/order/confirm/confirm?' + 'buyType=' + s + '&wxcx_shop_group_price=' + wxcx_shop_group_price + "&unvip_roll_code=" + this.data.unvip_roll_code + "&isTM=" + isTM + "&isFirst=" + this.data.isFirst + "&isNew=" + this.data.isNew + "&is_redHongBao=" + this.data.is_redHongBao + '&vip_type=' + this.data.vip_type + '&vip_free=' + vip_free + '&free_page=' + this.data.free_page + '&is_vip=' + this.data.is_vip + '&first_group=' + this.data.first_group;
          wx.navigateTo({
            url: url
          })

        }
        else if (this.data.vip_free > 0 || this.data.is_vip > 0)//å…è´¹é¢†
        {
          var url = '../../listHome/order/confirm/confirm?' + 'buyType=' + s + '&wxcx_shop_group_price=' + wxcx_shop_group_price + "&isTM=" + isTM + '&vip_type=' + this.data.vip_type + '&shouYePage=' + this.data.shouYePage + '&vip_free=' + vip_free + '&free_page=' + this.data.free_page + '&is_vip=' + this.data.is_vip + '&first_group=' + this.data.first_group;

          wx.navigateTo({
            url: url
          })
        }
        else {//å¼€å›¢

          var url = '../../listHome/order/confirmFight/confirmFight?' + 'buyType=' + s + '&wxcx_shop_group_price=' + wxcx_shop_group_price + "&isTM=" + isTM + '&vip_type=' + this.data.vip_type + '&shouYePage=' + this.data.shouYePage + '&vip_free=' + vip_free + '&free_page=' + this.data.free_page + '&is_vip=' + this.data.is_vip + '&first_group=' + this.data.first_group;

          wx.navigateTo({
            url: url
          })
        }

      } else {

        if (this.data.is_vip > 0 && this.data.isKT == false && this.data.isShowJoinGroup == false)//å•ç‹¬è´­ä¹°
        {
          wx.redirectTo({
            url: '../../listHome/order/confirm/confirm?' + 'buyType=' + s + '&wxcx_shop_group_price=' + wxcx_shop_group_price + "&isTM=" + isTM + "&isTM_Advertisement=" + isTM_Advertisement + '&shop_type=' + isTM_shoptype + '&is_onlyBuy=1' + '&max_vipType=' + this.data.max_vipType + '&cashOnDelivery=' + this.data.cashOnDelivery + '&shouYePage=' + this.data.shouYePage + '&delivery_time=' + this.data.delivery_time
          })
        } else {//å¼€å›¢ å‚å›¢

          if (this.data.isShowJoinGroup)//å‚å›¢
          {
            var url = '../../listHome/order/confirmFight/confirmFight?' + 'buyType=' + s + '&wxcx_shop_group_price=' + wxcx_shop_group_price + "&roll_code=" + this.data.roll_code + "&isTM=" + isTM + "&isFirst=" + this.data.isFirst + "&isNew=" + this.data.isNew + "&is_redHongBao=" + this.data.is_redHongBao + '&vip_type=' + this.data.vip_type + '&vip_free=' + vip_free + '&free_page=' + this.data.free_page + '&is_vip=' + this.data.is_vip + '&first_group=' + this.data.first_group;
            wx.navigateTo({
              url: url
            })
          }else{//å¼€å›¢
          
            var url = '../../listHome/order/confirmFight/confirmFight?' + 'buyType=' + s + '&wxcx_shop_group_price=' + wxcx_shop_group_price + "&isTM=" + isTM + '&vip_type=' + this.data.vip_type + '&shouYePage=' + this.data.shouYePage + '&vip_free=' + vip_free + '&free_page=' + this.data.free_page + '&is_vip=' + this.data.is_vip + '&first_group=' + this.data.first_group;

            wx.navigateTo({
              url: url
            })
          }
        }

      }

      this.setData({
        showDialog: false,
      })
    } else {
      var that = this;
      that.setData({
        showDialog: false
      })
      that.globalLogin();//é‡æ–°ç™»å½•
    }
  },

  //ç”Ÿæˆåˆ†äº«çš„åˆæˆå›¾ç‰‡
  getCanvasPictiure: function () {
    var that = this;

    var share_pic = '';
    if (that.data.shop.four_pic) {
      var picArray = that.data.shop.four_pic.split(',');
      if (picArray.length > 2) {
        share_pic = picArray[2] + '!450';
      } else if (picArray.length > 0) {
        share_pic = picArray[0] + '!450';
      }
      else {
        share_pic = that.data.shop.def_pic + '!450';
      }
    } else {
      share_pic = that.data.shop.def_pic + '!450';
    }

    share_pic = that.data.picLink + share_pic;
    util.getCanvasPictiure("shareCanvas", share_pic, that.data.wxcx_shop_group_price, 'å•†å“åˆ†äº«',function (tempFilePath) {
      if (tempFilePath != undefined && tempFilePath != null) {
        that.setData({
          tempFilePath: tempFilePath
        })
      } else {
        that.setData({
          tempFilePath: share_pic
        })
      }
    })
  },

  onShareAppMessage: function (res) {
    var user_id = '';

    if (app.globalData.user) {
      user_id = app.globalData.user.user_id
    }

    //å¦‚æœç”¨æˆ·è¾“å…¥äº†ä»–äººçš„é‚€è¯·ç¢¼åˆšåˆ†äº«å‡ºå»çš„å°±æ˜¯ä»–äººçš„é‚€è¯·ç 
    if (this.data.other_userid != undefined && this.isNumber(this.data.other_userid) == true) {
      user_id = this.data.other_userid;
    }

    var that = this;
    if (res.from === 'button') {
      // æ¥è‡ªé¡µé¢å†…è½¬å‘æŒ‰é’®
      console.log(res.target)
    }

    this.data.shareTitle = 'ç‚¹å‡»è´­ä¹°ğŸ‘†' + 'ã€' + this.data.shop_name + 'ã€‘' + "ä»Šæ—¥ç‰¹ä»·" + this.data.wxcx_shop_group_price + "å…ƒï¼";

    if (that.data.tempFilePath == undefined || that.data.tempFilePath == null) {
      var share_pic = '';
      if (that.data.shop.four_pic) {
        var picArray = that.data.shop.four_pic.split(',');
        if (picArray.length > 2) {
          share_pic = picArray[2] + '!450';
        } else if (picArray.length > 0) {
          share_pic = picArray[0] + '!450';
        }
        else {
          share_pic = that.data.shop.def_pic + '!450';
        }
      } else {
        share_pic = that.data.shop.def_pic + '!450';
      }

      share_pic = that.data.picLink + share_pic;
      that.setData({
        tempFilePath: share_pic
      })
    }

    var path = '/pages/shouye/detail/detail?shop_code=' + this.data.shop_code + "&isShareFlag=true" + "&user_id=" + user_id;
    if (this.data.isActiveShop == true)//æ´»åŠ¨å•†å“
    {
      path = '/pages/shouye/detail/detail?shop_code=' + this.data.shop_code + "&isShareFlag=true" + "&user_id=" + user_id + "&isActiveShop=" + this.data.isActiveShop + '&cashOnDelivery=' + this.data.cashOnDelivery;
    }

    if (that.data.isOneShowShare) {
      return {
        title: that.data.shareTitle,
        path: path,
        imageUrl: that.data.tempFilePath,
        success: function (res) {
          that.setData({
            isOneShowShare: false
          })
          that.buyOrder();
        },
        fail: function (res) {
          // è½¬å‘å¤±è´¥
        }
      }
    } else if (that.data.isFreelingShareFlag){
      return {
        title: that.data.freeling_shareTitle,
        path: that.data.freeling_sharePath,
        imageUrl: that.data.freeling_shareImageUrl,
        success: function (res) {
         
        },
        fail: function (res) {
          // è½¬å‘å¤±è´¥
        }
      }
    } else {
        return {
          title: this.data.shareTitle,
          path: path,
          imageUrl: this.data.tempFilePath,
          success: function (res) {
            
          },
          fail: function (res) {
            // è½¬å‘å¤±è´¥
          }
        }
    }
  },

  isNumber: function (val) {
    var regPos = /^\d+(\.\d+)?$/;Â //éè´Ÿæµ®ç‚¹æ•°
    var regNeg = /^(-(([0-9]+\.[0-9]*[1-9][0-9]*)|([0-9]*[1-9][0-9]*\.[0-9]+)|([0-9]*[1-9][0-9]*)))$/;Â //è´Ÿæµ®ç‚¹æ•°
    if (regPos.test(val) || regNeg.test(val)) {
      return true;
    } else {
      return false;
    }
  },

  //æ˜¯å¦æˆæƒ
  shareLoginSetting: function () {
    wx.showLoading({
      title: 'è¯·ç¨å',
      mask: true,
    })
    this.setData({
      showShareMC: true
    })
    var that = this;
    //æŸ¥çœ‹ç”¨æˆ·æ˜¯å¦æˆæƒ æœªæˆæƒå¼¹æˆæƒæç¤ºå¼¹çª—
    wx.getSetting({
      success: res => {
        if (res.authSetting['scope.userInfo']) { //æˆæƒè¿‡


          if (!app.globalData.user) { //æ‹¿ä¸åˆ°ç”¨æˆ·ä¿¡æ¯-å»ç™»å½•
            //ç™»å½•æˆåŠŸå›è°ƒ
            app.New_userlogin(function () {

              app.queryJY(function (noJY) { //noJY:æ²¡æœ‰äº¤æ˜“è®°å½•
                if (noJY) {
                  // wx.navigateTo({
                  //   url: '/pages/shouye/redHongBao?shouYePage=ThreePage',
                  // })
                }
                that.setData({
                  showShareMC: false
                })
                wx.hideLoading()

              })



            });
          } else { //æ‹¿äº†åˆ°ç”¨æˆ·ä¿¡æ¯-å»æŸ¥è¯¢
            app.queryJY(function (noJY) { //noJY:æ²¡æœ‰äº¤æ˜“è®°å½•
              if (noJY) {
                // wx.navigateTo({
                //   url: '/pages/shouye/redHongBao?shouYePage=ThreePage',
                // })
              }
              that.setData({
                showShareMC: false
              })
              wx.hideLoading()

            })
          }

        } else { //æœªæˆæƒ

          // wx.navigateTo({
          //   url: '/pages/shouye/redHongBao?shouYePage=ThreePage',
          // })
          that.setData({
            showShareMC: false
          })
          wx.hideLoading()

        }
      }
    })
  },

  //æŸ¥è¯¢ç”¨æˆ·æ˜¯å¦æœ‰äº¤æ˜“è®°å½•
  jiaoYiJiLu: function () {
    var that = this;
    app.queryJY(function (noJY) { //noJY:æ²¡æœ‰äº¤æ˜“è®°å½•
      var jiaoYiJiLu = !noJY;//true æœ‰äº¤æ˜“è®°å½• falseæ²¡æœ‰äº¤æ˜“è®°å½•
      that.setData({
        jiaoYiJiLu: jiaoYiJiLu
      })
      wx.hideLoading()
    })
  },
  // æäº¤formId
  loginsubmit: function (e) {
    formId = e.detail.formId;
  },
  //åˆ†äº«å¼¹çª—
  shareClick: function (e) {
    formId = e.detail.formId;
    // this.toshareData(false);
    if (app.globalData.user != null) {
      util.httpPushFormId(formId);
    }
  },
  shareDiscriptionClick: function () {
    this.setData({
      shareDiscriptionShow: true,
      oneYuanDiscriptionTitle: 'åˆ†äº«èµšè¯´æ˜'
    })
  },
  //é¢†å–ä¼šå‘˜/è¡¥å……ä¼šå‘˜è´¹
  memberSubmit: function (e) {
    formId = e.detail.formId;
    var type = e.currentTarget.dataset.type;
    if (formId && app.globalData.user != null) {
      util.httpPushFormId(formId);
    }
    this.setData({
      upperMemberYiFuShow: false,
      supplementMemberShow: false
    })

    var url = '';
    if (type == 'å¼€å¡') {
      if (wx.getStorageSync("showVipGuide")) {
        url = '../../mine/addMemberCard/addMemberCard?memberComefrom=' + 'detail'
      } else {
        wx.setStorageSync('showVipGuide', true)
        url = '../../mine/addMemberCard/addMemberCard?memberComefrom=' + 'detail'
      }
    } else {
      url = '../../mine/addMemberCard/addMemberCard?memberComefrom = ' + 'detail'
    }
    wx.navigateTo({
      url: url,
    })
  },
  //æˆæƒå¼¹çª—
  onclick: function (e) {
    var that = this;
    wx.hideLoading();
    wx.getUserInfo({
      //å…è®¸æˆæƒ è·å–ç”¨æˆ·ä¿¡æ¯
      success: function (res) {
        if (!app.globalData.user) {
          // that.loginHttp();
          that.globalLogin();//é‡æ–°ç™»å½•
        }
      },
      fail: function () {

      }
    })
  },

  hongbaoclick: function (e) {
    var that = this;
    wx.getUserInfo({
      //å…è®¸æˆæƒ è·å–ç”¨æˆ·ä¿¡æ¯
      success: function (res) {
        if (!app.globalData.user) {
          wx.showLoading({
            title: 'è¯·ç¨å',
            mask: true,
          })

          //æˆæƒæˆåŠŸå»ç™»å½•
          app.New_userlogin(function () {
            util.httpPushFormId(formId);
            wx.hideLoading();

            if (that.data.firstredHongbaoNewuserShow) {
              that.redHongClick();
              that.setData({
                // ninthHongbaoShow:true,
                firstredHongbaoNewuserShow: false
              })
            }
            if (that.data.shareComeFromRedHongBao)
            {
              var showendofpromotionDialog = app.globalData.user.showSpecialPage != 1 ? true : false;
              that.setData({
                showendofpromotionDialog: showendofpromotionDialog,
                shareComeFromRedHongBao: false
              })
            }
          });
        }
      },
      fail: function () {

      }
    })
  },
  //çº¢åŒ…ç‚¹é¢†
  redHongClick: function () {
    if (app.homePagetoSign == true) {
      wx.navigateTo({
        url: '/pages/sign/sign',
      })
    }
  },
  //90å…ƒçº¢åŒ…å…³é—­
  ninthHongbaoSubmit:function(e){
    formId = e.detail.formId;
    if (app.globalData.user != null) {
      util.httpPushFormId(e.detail.formId);
    }
    this.setData({
      ninthHongbaoShow:false
    })
  },
  //ç™»å½•æˆåŠŸå›è°ƒ
  loginHttp: function () {
    var that = this;
    wx.showLoading({
      title: 'è¯·ç¨å',
      mask: true,
    })
    app.New_userlogin(function () {
      wx.hideLoading();
      //æˆæƒç™»å½•æˆåŠŸ
      that.data.isOreadyToken = true;
      if (buttonClcik == 1) {
        that.toshareData(true);
      } else if (buttonClcik == 2) {
        that.toBuyClick();
      } else if (buttonClcik == 3) {
        that.oneBuyClick();
      } else if (buttonClcik == 4) {
        that.gotabwode();
      }
      // æäº¤formId
      if (formId) {
        util.httpPushFormId(formId);
      }

      that.userInfo_httpData();
    });
  },

  //è‡ªåŠ¨ç™»å½•
  globalLogin: function () {
    var that = this;
    wx.showLoading({
      title: 'è¯·ç¨å',
    })
    util.autoLogin(loginCount, function (loginfailYiFuShow, login_discribution, login_buttontitle, newloginCount) {
      loginCount = newloginCount;
      if (loginCount == 1)//ç™»å½•æˆåŠŸ
      {
        var showendofpromotionDialog = app.globalData.user.showSpecialPage != 1 ? true : false;
        that.setData({
          showendofpromotionDialog: showendofpromotionDialog,
          shareComeFromRedHongBao: false
        })
        //æˆæƒç™»å½•æˆåŠŸ
        that.data.isOreadyToken = true;
        if (buttonClcik == 1) {
          that.toshareData(true);
        } else if (buttonClcik == 2) {
          that.toBuyClick();
        } else if (buttonClcik == 3) {
          that.oneBuyClick();
        } else if (buttonClcik == 4) {
          that.gotabwode();
        }
        // æäº¤formId
        if (formId) {
          util.httpPushFormId(formId);
        }

        // that.userInfo_httpData();
        that.oneYuan_httpData();
      } else {
        that.setData({
          loginfailYiFuShow: loginfailYiFuShow,
          login_discribution: login_discribution,
          login_buttontitle: login_buttontitle,
        })
      }
    })
  },
  //ç™»å½•å¤±è´¥é‡æ–°ç™»å½•
  loginAgainSubmit: function () {
    var that = this;

    that.setData({
      loginfailYiFuShow: false,
    })
    wx.showLoading({
      title: 'è¯·ç¨å',
    })
    that.globalLogin();
  },
  closeLoginPop: function () {
    this.setData({
      loginfailYiFuShow: false
    })
  },

  contactHandle: function (event) {
    console.log("event");
  },

  //************************æ‹¼å•æˆåŠŸæç¤ºç”¨æˆ·å»æç°********************* */
  //è·å–ä¼˜æƒ åˆ¸
  getcoupon_http: function () {
    var that = this;
    var oldurl = config.Host + '/coupon/getRollCoupon?' + config.Version;
    util.http(oldurl, that.coupon_data);
  },
  coupon_data: function (data) {
    var coupon = "6";
    if (data.status == 1) {
      coupon = data.price > 0 ? (data.price * 1).toFixed(0) : coupon;
      this.getFightOrderStatus();
    }
    this.setData({
      coupon: coupon,
    })
  },
  //è·å–ç”¨æˆ·æ˜¯å¦æœ‰æ‹¼å›¢æˆåŠŸçš„è®¢å•
  getFightOrderStatus: function () {
    var that = this;
    var token = "";
    if (app.globalData.user != null) {
      token = app.globalData.user.userToken;
    }
    var oldurl = config.Host + 'order/getOrderStatus?' + config.Version + "&token=" + token;
    util.http(oldurl, that.fightOrder_data);
  },
  fightOrder_data: function (data) {

    var that = this;
    //é¦–æ¬¡æ‹¼å›¢ç–¯æŠ¢æ‰å¼¹æ­¤æ¡†
    if (data.status == 1 && data.rollCount == 1) {
      var time = wx.getStorageSync("FightPopTime");
      var currentTime = util.isToday(time);
      //å½“æ˜¯ç¬¬äºŒå¤©æ¸…é›¶å¼¹å‡ºæ¬¡æ•°
      if (currentTime == 'ä»¥å‰çš„æ—¥æœŸ') {
        wx.setStorageSync("popCount", '');
      }

      var popcount = wx.getStorageSync("popCount");
      if (currentTime != 'å½“å¤©' || popcount < 11) {

        //å¼¹è¿‡åæ¸…é™¤æ¡ä»¶
        wx.setStorageSync('FightSuccess', false);

        that.setData({
          fightSuccess_fail_isShow: false,
        })

        var NowTime = new Date().getTime();
        wx.setStorageSync("FightPopTime", NowTime);
        wx.setStorageSync("popCount", popcount + 1);

      }
    }
  },
  //å»èµšé’±
  goToMoney: function () {
    this.setData({
      fightSuccess_fail_isShow: false
    })
    wx.navigateTo({
      url: '../../sign/sign',
    })
  },
  //ç«‹å³å»æç°
  closeTixianBtn: function () {
    wx.navigateTo({
      url: '/pages/sign/inviteFriends/memberFriendsReward',
    })
    this.setData({
      moneyTixianShowFlag: false,
    })
  },
  closePop: function () {
    this.setData({
      fightSuccess_fail_isShow: false,
      supplementMemberShow: false
    })
  },
  closeNewThirty: function () {
    var that = this;
    that.setData({
      upperMemberYiFuShow: false,
      redHongbaoNewuserShow: false
    })
    if (that.data.firstredHongbaoNewuserShow) {
      that.setData({
        firstredHongbaoNewuserShow: false
      })
      showHongBao.loopShowHongbao(that, showHongBao, function (is_show) {
        if (is_show) {
          that.setData({
            firstredHongbaoNewuserShow: false
          })
        }
      })
    }
  },
  tixianview_close: function () {
    this.setData({
      isShowShare: false
    })
  },
  showYqmTips: function () {
    this.setData({
      showTips: true
    })
  },

  //æ¯ç§’å‡ä¸€æ¬¡
  startReportHeart: function () {
    var that = this;
    var poplastTime = that.data.poplastTime;
    redhongbaoCutdoenTimer = setTimeout(function () {
      poplastTime--;
      that.data.poplastTime = poplastTime;
      wx.setStorageSync('poplastTime', poplastTime);
      that.startReportHeart()
    }, 1000)
  },
  colseTips: function () {
    var that = this;
    that.setData({
      showTips: false,
    })

    if (that.data.contactkefuShow) {

      that.data.poplastTime = that.data.homePage3ElasticFrame;
      that.startReportHeart();

      redhongbaopopTimer = setTimeout(function () {

        if (app.globalData.user != null && app.globalData.user.userToken != undefined) {

        } else {//å½“ç”¨æˆ·æ²¡æœ‰ç™»å½•æˆæƒæ—¶æ‰å¾ªç¯å¼¹å‡ºæ­¤æ¡†
          if (!that.data.redHongbaoNewuserShow && redhongbaonotshow == true) {
            that.setData({
              firstredHongbaoNewuserShow: false,
            })
          }
        }
      }, that.data.homePage3ElasticFrame * 1000)
      that.setData({
        contactkefuShow: false
      })
    }
  },
  contactkefu: function () {
    this.setData({
      contactkefuShow: false
    })
  },
  //å…±ç”¨
  closeVipDialog: function () {
    this.setData({
      showFrirstDayCopleteDialog: false
    })
  },
  xianjinRedsubmit: function (e) {
    redhongbaonotshow = true;
    formId = e.detail.formId;
    if (this.data.redHongbaoNewuserShow) {
      this.setData({
        redHongbaoNewuserShow: false,
      })
      //å¦‚æœå–åˆ°å¹¿å‘Šclick_idå°±å›ä¼ 
      var click_id = wx.getStorageSync('gdt_vid');
      if (click_id) {
        var clickUrl = config.Host + 'wxMarkting/marketing_reservation?' + config.Version +
          '&click_id=' + click_id +
          "&channel=" + wx.getStorageSync("advent_channel");
        util.http(clickUrl, function (data) {
          if (data.status == 1) {
            wx.setStorageSync('gdt_vid', '')
          }
        });
      }
    }

    if (this.data.firstredHongbaoNewuserShow)
    {
      if (app.globalData.channel_type == 1)//æ¸ é“è¿›å…¥
      {
        this.setData({
          firstredHongbaoNewuserShow: false
        })
      } else {
        if (app.globalData.user != null && app.globalData.user.userToken != undefined) {
          this.setData({
            firstredHongbaoNewuserShow: false
          })
        } 
      }
      
      showHongBao.clickHongbao(this, function (is_show) { })
    }
  },
  //å¼•å¯¼ç”¨æˆ·æˆä¸ºä¼šå‘˜
  guidebecomememberTap: function (e) {

    formId = e.detail.formId;
    if (app.globalData.user != null) {
      util.httpPushFormId(e.detail.formId);
    }
    if(this.data.guidebecomeMemberImage == 'å®Œæˆä»»åŠ¡')
    {
      wx.redirectTo({
        url: '/pages/sign/sign',
      })
      
    }else{
      wx.navigateTo({
        url: '../../mine/addMemberCard/addMemberCard?memberComefrom=' + 'detail',
      })
    }
    
    this.setData({
      guidebecomeMemberShow: false
    })
  },

  //é¦–æ—¥å®Œæˆä»»åŠ¡å»è½¬ç›˜
  fistSignComplestTap: function () {
    wx.navigateTo({
      url: '/pages/mine/withdrawLimitTwo/withdrawLimitTwo',
    })
    this.setData({
      showFrirstDayCopleteDialog: false
    })
  },
  closeNewLuckImage: function () {
    this.setData({
      guidebecomeMemberShow: false
    })
  },
  Redhongsubmit: function () {
    redhongbaonotshow = false;
    if (this.data.redHongbaoNewuserShow) {
      //å¦‚æœå–åˆ°å¹¿å‘Šclick_idå°±å›ä¼ 
      var click_id = wx.getStorageSync('gdt_vid');
      if (click_id) {
        var clickUrl = config.Host + 'wxMarkting/marketing_reservation?' + config.Version +
          '&click_id=' + click_id +
          "&channel=" + wx.getStorageSync("advent_channel");
        util.http(clickUrl, function (data) {
          if (data.status == 1) {
            wx.setStorageSync('gdt_vid', '')
          }
        });
      }

      if (app.globalData.user != undefined && app.globalData.user.userToken != undefined) {
        if (app.homePagetoSign == true) {
          wx.navigateTo({
            url: '/pages/sign/sign',
          })
        }
      }
      this.setData({
        redHongbaoNewuserShow: false,
      })
    }
  },

  // æ˜¾ç¤ºé®ç½©å±‚
  showModal: function () {
    var that = this;
    that.setData({
      hideModal: false
    })
    var animation = wx.createAnimation({
      duration: 600,//åŠ¨ç”»çš„æŒç»­æ—¶é—´ é»˜è®¤600ms   æ•°å€¼è¶Šå¤§ï¼ŒåŠ¨ç”»è¶Šæ…¢   æ•°å€¼è¶Šå°ï¼ŒåŠ¨ç”»è¶Šå¿«
      timingFunction: 'ease',//åŠ¨ç”»çš„æ•ˆæœ é»˜è®¤å€¼æ˜¯linear
    })
    this.animation = animation
    setTimeout(function () {
      that.fadeIn();//è°ƒç”¨æ˜¾ç¤ºåŠ¨ç”»
    }, 200)
  },

  // éšè—é®ç½©å±‚
  hideModal: function () {
    var that = this;
    var animation = wx.createAnimation({
      duration: 800,//åŠ¨ç”»çš„æŒç»­æ—¶é—´ é»˜è®¤800ms   æ•°å€¼è¶Šå¤§ï¼ŒåŠ¨ç”»è¶Šæ…¢   æ•°å€¼è¶Šå°ï¼ŒåŠ¨ç”»è¶Šå¿«
      timingFunction: 'ease',//åŠ¨ç”»çš„æ•ˆæœ é»˜è®¤å€¼æ˜¯linear
    })
    this.animation = animation
    that.fadeDown();//è°ƒç”¨éšè—åŠ¨ç”»   
    setTimeout(function () {
      that.setData({
        hideModal: true
      })
    }, 500)//å…ˆæ‰§è¡Œä¸‹æ»‘åŠ¨ç”»ï¼Œå†éšè—æ¨¡å—

  },

  //åŠ¨ç”»é›†
  fadeIn: function () {
    this.animation.translateY(0).step()
    this.setData({
      animationData: this.animation.export()//åŠ¨ç”»å®ä¾‹çš„exportæ–¹æ³•å¯¼å‡ºåŠ¨ç”»æ•°æ®ä¼ é€’ç»™ç»„ä»¶çš„animationå±æ€§
    })
  },
  fadeDown: function () {
    this.animation.translateY(600).step()
    this.setData({
      animationData: this.animation.export(),
    })
  },

  //ç‚¹å‡»åé¦ˆå†…å®¹
  itemtap: function (e) {
    var clciktext = e.currentTarget.dataset.id;
    if (clciktext == "åé¦ˆä¸æŠ•è¯‰") {
      console.log('clciktext=', clciktext);
      this.setData({
        hideModal: true
      })
      wx.navigateTo({
        url: '/pages/mine/Complaint/Complaint?path=/inviteFriends/memberFriendsReward',
      })
    }
  },
  //æŠ•è¯‰åˆ†äº«
  complain_shareTap: function () {
    this.setData({
      hideModal: true
    })
  },
})
