import config from '../../../config.js';
var util = require('../../../utils/util.js');
var WxNotificationCenter = require("../../../utils/WxNotificationCenter.js");
import ToastPannel from '../../../common/toastTest/toastTest.js';
var fightUtil = require('../../../utils/freeFightCutdown.js');

var app = getApp();
var orderItem;

var chouJiangUrl;
var formId;
var fistChoujiangBack = false;

var firstChoujiang = true;
var is_goTiXianDetail = false;
var is_backFresh = false;
//96å°æ—¶-æœºå™¨äººæ‹¼å›¢æˆåŠŸä¸“ç”¨
var ptSuccessOrder_code = "111"
var ptSuccesRoll_code = "111"
var loginCount;

var clickWhether_prize; //å½“å‰ç‚¹å‡»çš„ä¸­å¥–

var clickStatus; //å½“å‰ç‚¹å‡»çš„è®¢å•çŠ¶æ€

var servicewxh //å®¢æœå¾®ä¿¡å·

var zhouJiangMZclick = false; //å¼•å¯¼ç”¨æˆ·æŠ½å»APPæŠ½å¥–çš„è’™å±‚æ˜¯å¦ç‚¹å‡»è¿‡

var isClickVip = 0 //ç‚¹å‡»ç”³è¯·å‘è´§æ—¶æ˜¯å¦æ˜¯Vip

var vipMaxType = 0; //ç”¨æˆ·æœ€é«˜çš„vipç­‰çº§


var nRaffle_status = 0;//æŠ½å¥–å‘ç”Ÿäº†å˜åŒ–ï¼ˆ1æ—¶ï¼‰

var isNewUserFirstOrder = false;

//shop_from å•†å“æ¥æº.0,æ™®é€šå•†å“.1,0å…ƒè´­.2ä¼šå‘˜å•†å“,3æ´»åŠ¨å•†å“4å¤ºå®5æ–°çš„æ´»åŠ¨å•†å“ 6.1åˆ†é’±å¤ºå® 7æ–°æ‹¼å›¢,8é¢åº¦å¤ºå®,9æ‹¼å›¢å¤ºå®,10.å†æ¥ä¸€å•  11.æ‹¼å›¢ä¸€å…ƒè´­ 12.ç‰¹ä»·å¹¿å‘Šå•†å“13.ä¼šå‘˜å…è´¹é¢†
Page({

  /**
  //  * é¡µé¢çš„åˆå§‹æ•°æ®//////////
   */
  data: {
    currentTab: 0,
    currentpage: 1,
    isConfirm: false,
    upyconfig: config.Upyun,
    Upyun: config.Upyun,
    isorderdetail: 'false',
    openYifuDialogShow: false,
    moneyDiscountShowFlag: false,
    openRefundFailShow: false,
    moneyDiscount: 0,
    discountitem: "",
    oneYuanDiscriptionTitle: 'ç–¯æŠ¢é€€æ¬¾è¯´æ˜',
    oneyuanValue: 1,
    shareTitle: "",
    orderList: [],
    titlelist: ["å…¨éƒ¨", "å¾…ä»˜æ¬¾", "å¾…å‘è´§", "å¾…æ”¶è´§", "å¾…è¯„ä»·"],
    fightSuccess_fail_isShow: false,
    openFightSuccessShow: false,
    ptSuccessUserName: '',
    upperMemberYiFuShow: false,
    showFirstChoujiangBackDialog: false,
    guidedeliverCouponShow:false,
    guidedeliverCouponImg: '1',//1ç”³è¯·å‘è´§ 2æœªæŠ½ä¸­
    delivery_time:'',//å‘è´§æ—¶é—´
    opendeliveryCardShow:false,//å®Œæˆä»»åŠ¡èµ é€å‘è´§å¡
  },

  /**
   * ç”Ÿå‘½å‘¨æœŸå‡½æ•°--ç›‘å¬é¡µé¢åŠ è½½
   */
  onLoad: function(options) {
    new app.ToastPannel();
    var index = options.indexid;
    isNewUserFirstOrder = options.isNewUserFirstOrder;
    loginCount = 0;
    this.setData({
      currentTab: index,
      currentpage: 1,
    })

    zhouJiangMZclick = false
    // this.setData({
    //   sqFHshow: true

    // })

    var first_shopdata = wx.getStorageSync("first_shopdata");
    if (first_shopdata && isNewUserFirstOrder) {
      this.setData({
        fromShopData: first_shopdata,
        showLXKF: true
      })

      wx.setStorageSync("first_shopdata", "")
      // isNewUserFirstOrder = false;
    }




    // if (!is_backFresh) //å½“æ˜¯æŠ½å¥–ç•Œé¢è¿”å›æ—¶ä¸éœ€è¦é‡æ–°è¯·æ±‚åˆ—è¡¨
    // {
    //   this.getOrderList();
    // }

    this.setData({
      oneyuanValue: app.globalData.oneYuanValue,
      // oneYuanDiscriptionTitle: app.globalData.oneYuanValue + 'å…ƒè´­è¿”è¿˜è¯´æ˜',
    });

    if (options.FightSuccess) {
      this.setData({
        FightSuccess: options.FightSuccess
      })
    }

    WxNotificationCenter.addNotification("testNotificationAuthorizationName", this.testNotificationFromItem1Fn, this);

  },
  onUnload: function() {
    if (this.data.FightSuccess) {
      //è·å–ç”¨æˆ·æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡ç–¯æŠ¢
      util.getOrderStatus(function(data) {
        if (data.rollCount == 1) {
          wx.navigateTo({
            url: "/pages/shouye/redHongBao?shouYePage=" + "FourPage"
          })
        }
      })

      wx.setStorageSync("FightSuccess", true)
      this.setData({
        FightSuccess: false
      })
    }
  },

  onShow: function() {
    var fightSuccess = wx.getStorageSync('FightSuccess');
    //å½“æ˜¯é€€æ¬¾è¯¦æƒ…å›æ¥çš„å¼¹æ‹¼å•æˆåŠŸæç¤ºç”¨æˆ·å»æç°çš„å¼¹çª—
    if (is_goTiXianDetail == true || fightSuccess == true) {
      this.getcoupon_http();
    }

    if (is_backFresh) //å½“æ˜¯æŠ½å¥–ç•Œé¢è¿”å›æ—¶éœ€è¦åˆ·æ–°åˆ—è¡¨
    {
      if (wx.pageScrollTo) {
        wx.pageScrollTo({
          scrollTop: 0
        })
      }

      this.setData({
        currentTab: 0,
        currentpage: 1,
      })

      this.getOrderList();
      is_backFresh = false;

      var that = this;
      //ç¬¬äºŒæ¬¡æŠ½å®Œå¥–é€€å‡ºæ¥å¼¹ä¼šå‘˜æ¡†
      // util.get_LuckDraw(function(luckDraw) {
      //   if (luckDraw == true && !this.data.fightSuccess_fail_isShow && !this.data.showFirstChoujiangBackDialog) {
      //     that.setData({
      //       upperMemberYiFuShow: true
      //     })
      //   }
      // })
    }else{
      this.setData({
        currentpage: 1,
      })
      this.getOrderList();
    }
    
    if (this.data.isgotoMemberFromdeliver)
    {
      this.setData({
        opendeliveryCardShow:true,
        isgotoMemberFromdeliver:false
      })
    }
    this.loginSetting();
  },

  testNotificationFromItem1Fn: function(info) {
    var that = this;
    // that.setData({
    //   currentTab: 0,
    //   currentpage: 1
    // })
    // that.getOrderList();
    that.globalLogin();
  },

  //è·å–ä¼˜æƒ åˆ¸
  getcoupon_http: function() {
    var that = this;
    var oldurl = config.Host + '/coupon/getRollCoupon?' + config.Version;
    util.http(oldurl, that.coupon_data);
  },
  coupon_data: function(data) {
    var coupon = "6";
    if (data.status == 1) {
      coupon = data.price > 0 ? (data.price * 1).toFixed(0) : coupon;
      this.getFightOrderStatus();
    }
    this.setData({
      coupon: coupon,
    })
  },
  //è·å–ç”¨æˆ·æ˜¯å¦æœ‰æ‹¼å›¢æˆåŠŸçš„è®¢å•
  getFightOrderStatus: function() {
    var that = this;
    var token = "";
    if (app.globalData.user != null) {
      token = app.globalData.user.userToken;
    }
    var oldurl = config.Host + 'order/getOrderStatus?' + config.Version + "&token=" + token;
    util.http(oldurl, that.fightOrder_data);
  },
  fightOrder_data: function(data) {

    var that = this;
    //é¦–æ¬¡æ‹¼å›¢ç–¯æŠ¢æ‰å¼¹æ­¤æ¡†
    if (data.status == 1 && data.rollCount == 1) {
      var time = wx.getStorageSync("FightPopTime");
      var currentTime = util.isToday(time);
      //å½“æ˜¯ç¬¬äºŒå¤©æ¸…é›¶å¼¹å‡ºæ¬¡æ•°
      if (currentTime == 'ä»¥å‰çš„æ—¥æœŸ') {
        wx.setStorageSync("popCount", '');
      }

      var popcount = wx.getStorageSync("popCount");
      if (currentTime != 'å½“å¤©' || popcount < 11) {

        that.setData({
          fightSuccess_fail_isShow: false,
        })

        //å¼¹è¿‡åæ¸…é™¤æ¡ä»¶
        is_goTiXianDetail = false;
        wx.setStorageSync('FightSuccess', false);

        var NowTime = new Date().getTime();
        wx.setStorageSync("FightPopTime", NowTime);
        wx.setStorageSync("popCount", popcount + 1);

      }
    }
  },

  getOrderListData: function() {

    var token = "";
    if (app.globalData.user != null) {
      token = app.globalData.user.userToken;
    }
    var url = config.Host + 'order/getBuyOrder?token=' + token + config.Version + '&status=' + this.data.currentTab + '&page=' + this.data.currentpage + '&order=desc';

    console.log(url);

    wx.showLoading({
      title: 'è¯·ç¨å',
      mask: true,
    })
    util.http(url, this.httpOrderdata);
  },



  //è®¢å•åˆ—è¡¨æ•°æ®
  getOrderList: function() {
    var that = this;
    // //å…ˆæŸ¥ç”¨æˆ·vipæƒ…å†µ
    // util.get_vip(function(data) {
    //   vipMaxType = data.maxType;
      that.getOrderListData()

    // })





  },
  httpOrderdata: function(data) {
    wx.hideLoading()
    wx.stopPullDownRefresh();
    if (this.data.currentpage == 1) {
      this.data.orderList = [];
      vipMaxType = data.maxType;
      nRaffle_status = data.nRaffle_status;
      if (!nRaffle_status){
        nRaffle_status = 0;
      }
      // nRaffle_status = 1;//æµ‹è¯•
      this.setData({
        clockIn: data.clockIn,
        isVip:data.isVip,
        vipMaxType: data.maxType
      });

    }
    if (data.status == 1) {
      var page = this.data.currentpage + 1;
      var send_num = data.send_num;
      var datalist = data.orders;

      if (data.dayEndTime >0)
      {
        this.setData({
          dayEndTime: data.dayEndTime//å…è´¹é¢†è®¢å•åˆ·æ–°æ—¶é—´
        })
      }
      this.setData({
        current_date: data.current_date,//ä»»åŠ¡æ—¥æœŸ
        now: data.now//å½“å‰æ—¶é—´
      })

      var pageData = this.data.orderList;
      for (var j = 0; j < datalist.length; j++) {
        pageData.push(datalist[j]);
      }
      var orderlist = [];
      for (var i = 0; i < pageData.length; i++) {
        //è®¢å•çŠ¶æ€
        var shop_from = pageData[i].shop_from;
        var last_time = pageData[i].last_time;
        var issue_status = pageData[i].issue_status;
        var orderstaus = pageData[i].status;
        var whether_prize = pageData[i].whether_prize;

        var change = pageData[i].change;
        var item = pageData[i];
        var orderstatus = "";
        var ordershopstatus = "";
        var shop_pic = "";
        var shopcode = "";
        var newshopname = "";
        var pay_money = "";
        var shop_price = "";
        // var shop_from = "";
        var orderButtonStatus = [];
        if (pageData[i].orderShops.length > 0) {
          ordershopstatus = pageData[i].orderShops[0].status;
        }
        if (shop_from == 4 || shop_from == 6) { //å¤ºå®è®¢å•
          orderstatus = this.getIndianaStatus(last_time, issue_status);
          orderButtonStatus = this.getButtonStatusFromOrderStatus(orderstaus, item);
          shop_pic = pageData[i].order_pic;
          shopcode = pageData[i].bak;
          newshopname = pageData[i].order_name;

          if (shop_pic != null) {
            //å•†å“å›¾ç‰‡
            var newcode = shopcode.substr(1, 3);
            var new_pic = newcode + '/' + shopcode + '/' + shop_pic;

            //å•†å“åç§°
            if (newshopname.length > 9) {
              newshopname = newshopname.substr(0, 9) + '... ';
            }
            pageData[i]["new_shop_pic"] = new_pic;
            pageData[i]["new_shopname"] = newshopname;
          }

        } else { //å…¶ä»–å•†å“è®¢å•
          orderstatus = this.getOrderStatus(item,orderstaus, ordershopstatus, change, shop_from, whether_prize, pageData[i].new_free);
          orderButtonStatus = this.getButtonStatusFromOrderStatus(orderstaus, item, shop_from);
          var orderShops = pageData[i].orderShops;
          for (var j = 0; j < orderShops.length; j++) {
            shop_pic = pageData[i].orderShops[j].shop_pic;
            shopcode = pageData[i].orderShops[j].shop_code;
            shop_price = pageData[i].orderShops[j].shop_price;
            newshopname = pageData[i].orderShops[j].shop_name;
            pay_money = pageData[i].pay_money;
            shop_from = pageData[i].shop_from;

            // if (pageData[i].orderShops[j].original_price){
            //   shop_price = pageData[i].orderShops[j].original_price

            // }


            pageData[i].orderShops[j].shop_price = (shop_price * 1).toFixed(1);
            if (shop_pic != null) {
              //å•†å“å›¾ç‰‡
              var newcode = shopcode.substr(1, 3);
              var new_pic = newcode + '/' + shopcode + '/' + shop_pic;

              //å•†å“åç§°
              if (newshopname.length > 9) {
                newshopname = newshopname.substr(0, 9) + '... ';
              }
              pageData[i].orderShops[j]["new_shop_pic"] = new_pic;
              pageData[i].orderShops[j]["new_shopname"] = newshopname;
            }
          }
        }
        pageData[i]["orderstatus"] = orderstatus;
        pageData[i]["orderButtonStatus"] = orderButtonStatus;
        pageData[i]["send_num"] = send_num;
        orderlist.push(pageData[i]);
      }
      var vipMaxVipName = "é’»çŸ³ä¼šå‘˜"
      if (vipMaxType == 4) {
        vipMaxVipName = "é’»çŸ³ä¼šå‘˜"
      } else if (vipMaxType == 5) {
        vipMaxVipName = "çš‡å† ä¼šå‘˜"
      }

      this.setData({
        vipMaxVipName: vipMaxVipName,
        orderList: orderlist,
        currentpage: page,
        orderstatus: orderstatus != undefined ? orderstatus : '',
      })

      var FightSuccess = wx.getStorageSync('FightSuccess');
      //å¦‚æœæ‹¼å•æˆåŠŸæç¤ºç”¨æˆ·å»æç°å¼¹çª—å‡ºç° æ­¤å¼¹çª—ä¸å¼¹
      if (this.fistChoujiangBack && FightSuccess != true) {
        this.setData({
          showFirstChoujiangBackDialog: true
        })

        this.fistChoujiangBack = false
      }

      //å¦‚æœæ˜¯å…è´¹é¢†è®¢å•è¿‡æ¥çš„ ä¸”ä¸æ˜¯æ–°æ‰‹ä»»åŠ¡ç¬¬ä¸€å¤©å¼¹æ­¤æ¡†
      // if (isNewUserFirstOrder && this.data.current_date != 'newbie01')
      //å…è´¹é¢†æœªæŠ½ä¸­ä»è½¬ç›˜è¿‡æ¥çš„
      if (isNewUserFirstOrder)
      {
        this.setData({
          guidedeliverCouponImg: 2,
          guidedeliverCouponShow:true
        })
        isNewUserFirstOrder = false;
      }

      var that = this;
      var cuttime = that.data.dayEndTime - that.data.now;
      clearTimeout(fightUtil.countDownTimer);
      fightUtil.countdown(that, fightUtil, cuttime, function (data) {
        that.setData({
          is_fresh:true,
          cutdowntime: data
        })
      })
    }
  },
  //å¤ºå®è®¢å•çŠ¶æ€
  getIndianaStatus: function(last_time, issue_status) {
    var statusstr = "";
    var NowTime = new Date().getTime();
    var total_micro_second = last_time - NowTime || [];
    if (total_micro_second <= 0) {
      statusstr = "å·²è¿‡æœŸ";
    } else {
      switch (issue_status) {
        case 0:
          statusstr = "å‚ä¸ä¸­";
          break;
        case 1:
          statusstr = "é€€æ¬¾";
          break;
        case 2:
          statusstr = "é€€æ¬¾";
          break;
        case 3:
          statusstr = "ä¸­å¥–";
          break;
        case 4:
          statusstr = "æœªä¸­å¥–";
          break;
      }
    }
    return statusstr;
  },
  //è®¢å•çŠ¶æ€
  getOrderStatus: function (itemm,status, ordershopstatus, change, shop_from, whether_prize, new_free) {
    var statusstr = "";
    if (ordershopstatus == "0") {
      switch (status) {
        case 1:
          statusstr = "å¾…ä»˜æ¬¾";
          if (shop_from == 11) { //æ‹¼å›¢äººå·²æ»¡ï¼Œæœªä»˜æ¬¾
            statusstr = "æ‹¼å›¢ä¸­";
          }
          break;
        case 2:
          statusstr = "å¾…å‘è´§";
          if (whether_prize == 2) { //ä¸­å¥–è®¢å•.é¢„ä¸­å¥–æ˜¾ç¤º'ç”³è¯·å‘è´§ä¸­'
            statusstr = "ç”³è¯·å‘è´§ä¸­";
          }

          if (new_free == 1) {
            statusstr = "ç”³è¯·å‘è´§ä¸­";
          }

          if (whether_prize == 3) {
            statusstr = "å¾…å‘è´§";
          }

          if (shop_from == 11 && itemm.is_roll !=3) { //æ‹¼å›¢äººå·²æ»¡ï¼Œå·²ä»˜æ¬¾
            statusstr = "æ‹¼å›¢ä¸­";
          }

          if (shop_from == 0 && whether_prize == 9)//å…æ‹¼å¡ å‘è´§å¡
          {
            statusstr = "å¾…å‘è´§";
          }
          break;
        case 3:
          statusstr = "å¾…æ”¶è´§";
          break;
        case 4:
          statusstr = "å¾…è¯„ä»·";
          break;
        case 5:
          statusstr = "å·²è¯„ä»·";
          break;
        case 6:
          if (shop_from == 10) {
            statusstr = "å…è´¹é¢†æœªç‚¹ä¸­";
          } else
            statusstr = "äº¤æ˜“æˆåŠŸ";
          break;
        case 7:
          statusstr = "å»¶é•¿æ”¶è´§";
          break;
        case 8:
          statusstr = "é€€æ¬¾æˆåŠŸ";
          break;
        case 9:
          if (shop_from == 13) {
            statusstr = "è®¢å•å…³é—­";
          } else {
            statusstr = "å–æ¶ˆè®¢å•";
          }
          break;
        case 10:
          statusstr = "è®¢å•å·²è¿‡æœŸ";
          break;
        case 11: //æ‹¼å›¢äººæœªæ»¡
          statusstr = "æ‹¼å›¢ä¸­";
          break;
        case 12:
          // statusstr = "å¾…ç–¯æŠ¢";  
          statusstr = "å…è´¹é¢†"; //å¾…ç–¯æŠ¢-åç§°æ”¹ä¸ºå…è´¹é¢†

          break;
        case 13:
          statusstr = "æ‹¼å›¢å¤±è´¥";
          break;
        case 14:
          statusstr = "å…è´¹é¢†æœªç‚¹ä¸­";
          break;
        case 15: //ç”³è¯·å…³é—­æ‹¼å›¢-å·²è¿‡96å°æ—¶
          statusstr = "æ‹¼å›¢ä¸­";
          break;
        case 16: //å®¢æœå…³é—­æ‹¼å›¢
          statusstr = "æ‹¼å›¢å…³é—­";
          break;
        case 17:
          statusstr = "å¾…å‘è´§";
          if (whether_prize == 2) { //ä¸­å¥–è®¢å•.é¢„ä¸­å¥–æ˜¾ç¤º'ç”³è¯·å‘è´§ä¸­'
            statusstr = "ç”³è¯·å‘è´§ä¸­";

          }
          if (new_free == 1) {
            statusstr = "ç”³è¯·å‘è´§ä¸­";
          }
          break;
        case 21:
          statusstr = "åˆ†äº«ä¸­";

          break;
      }
    } else if (ordershopstatus == "4") {
      if (shop_from == 10) {
        statusstr = "ç–¯æŠ¢æœªæŠ¢åˆ°";
      } else
        statusstr = "äº¤æ˜“æˆåŠŸ";
    } else {
      var str1 = "";
      var str2 = "";
      switch (change) {
        case 1:
          str1 = "æ¢è´§";
          break;
        case 2:
          str1 = "é€€è´§";
          break;
        case 3:
          str1 = "é€€æ¬¾";
          break;
      }

      switch (ordershopstatus) {
        case "1":
          str2 = "å¤„ç†ä¸­";
          break;
        case "2":
          str2 = "è¢«æ‹’ç»";
          break;
        case "3":
          str2 = "å·²æˆåŠŸ";
          break;
        case "4":
          str2 = "å·²å–æ¶ˆ";
          break;
      }
      statusstr = str1 + str2;
    }

    return statusstr;
  },
  //è®¢å•å¤„ç†æŒ‰é’®
  getButtonStatusFromOrderStatus: function(status, item, shop_from) {
    var buttonLisr = [];
    var timestamp = Date.parse(new Date());
    if (item.last_time <= timestamp) {
      buttonLisr = ["åˆ é™¤è®¢å•"];
    }
    //æµ‹è¯•æ•°æ®
    // status = 17;
    // item.whether_prize = 2;
    switch (status) {
      case 1:
        if (item.lasttime <= item.requestNow_time) {
          buttonLisr = ["åˆ é™¤è®¢å•"];
        } else {
          buttonLisr = ["è”ç³»å–å®¶", "å–æ¶ˆè®¢å•", "ä»˜æ¬¾"];
        }
        //æ‹¼å›¢ä¸­-äººå·²æ»¡æœªä»˜æ¬¾
        if (shop_from == 11) {
          buttonLisr = ["å»ä»˜æ¬¾"];

        }

        break;
      case 2:
        buttonLisr = ["æé†’å‘è´§"];

        if (item.pay_status == 1 && item.orderShopStatus == 0 && item.orderShopStatus != nil && item.status == 1) {
          buttonLisr = ["è”ç³»å–å®¶", "åˆ é™¤è®¢å•", "ä»˜æ¬¾"];
        } else if (item.issue_status == 4) {
          buttonLisr = ["åˆ é™¤è®¢å•"];
        }

        //ä¸­å¥–å¤„ç†
        //whether_prize ç›´æ¥ä¸­å¥–ï¼š0ï¼Œ æ™®é€šè®¢å•1ï¼Œ é¢„å…ˆä¸­å¥–2
        if (item.shop_from == 10 || item.shop_from == 11 || shop_from == 13) {


          if (item.whether_prize == 0) { //ç›´æ¥ä¸­å¥–è®¢å•
            buttonLisr = ["ç”³è¯·å‘è´§"];
            if (item.is_roll == 3) {
              buttonLisr = ["æé†’å‘è´§"];
            }
          }


          if (item.whether_prize == 2) { //é¢„å…ˆä¸­å¥–

            if (item.new_free == 1) { //æ–°ç”¨æˆ·é¦–å•

              // if (nRaffle_status == 1){
              //   buttonLisr = ["ç”³è¯·å‘è´§"];

              // }else{
              //   buttonLisr = ["å»èµšé’±ä»»åŠ¡"];
              // }
              
              // 2019-12-24 ä½•æ³¢ä¿®æ”¹
              if (this.data.isVip > 0 && this.data.isVip !=3)//æ˜¯ä¼šå‘˜
              {
                buttonLisr = (this.data.clockIn == 1) ? ["ç”³è¯·å‘è´§"] : ["å»èµšé’±ä»»åŠ¡"];
              }else{
                buttonLisr = ["ç”³è¯·å‘è´§"];
              }
            } else {
              buttonLisr = ["ç”³è¯·å‘è´§"];
            }

          }

        }


        //æ‹¼å›¢ä¸­-äººå·²æ»¡å·²ä»˜æ¬¾
        if (shop_from == 11 && item.is_roll != 3) {
          buttonLisr = ["å·²ä»˜æ¬¾"];
        }

        if(item.is_freeDelivery == 1){
          buttonLisr = ["ç‚¹å‡»å…è´¹å‘è´§"];
        }
        
        break;
      case 3:
        buttonLisr = ["æŸ¥çœ‹ç‰©æµ", "ç¡®è®¤æ”¶è´§"];
        break;
      case 4:
        buttonLisr = ["åˆ é™¤è®¢å•", "è¯„ä»·è®¢å•"];
        break;
      case 5:
        buttonLisr = ["åˆ é™¤è®¢å•", "è¿½åŠ è¯„ä»·"];
        if (item.shop_from == 4 || item.shop_from == 6) {
          buttonLisr = ["åˆ é™¤è®¢å•"];
        } else {
          buttonLisr = ["åˆ é™¤è®¢å•", "è¿½åŠ è¯„ä»·"];
        }
        break;
      case 6:
        buttonLisr = ["åˆ é™¤è®¢å•"];
        break;
      case 7:
        buttonLisr = ["æŸ¥çœ‹ç‰©æµ", "ç¡®è®¤æ”¶è´§"];
        break;
      case 8:
        buttonLisr = ["é’±æ¬¾å»å‘"];
        break;
      case 9:
        buttonLisr = ["åˆ é™¤è®¢å•"];
        break;
      case 11:
        buttonLisr = ["é‚€è¯·å¥½å‹æ‹¼å›¢"];
        break;

      case 12:
        buttonLisr = ["ä¼šå‘˜å…è´¹é¢†"];
        break;

        // check: 0 1 2 3 4
        // 1. é€€æ¬¾å…³é—­        0
        // 2. éƒ¨åˆ†é€€æ¬¾æˆåŠŸ      1
        // 3.å…¨éƒ¨é€€æ¬¾æˆåŠŸ    2
        // 4.é€€æ¬¾ä¸­  3
        // 5.é€€æ¬¾å¤±è´¥ 4

      case 13:
        // if (item.check == 3) {
        //   buttonLisr = ["åˆ é™¤è®¢å•", "é€€æ¬¾æˆåŠŸ"];
        // } else if (item.check == 11 || item.check == 2) {
        //   buttonLisr = ["é€€æ¬¾å¤±è´¥"];
        // } else if (item.check >= 0) {
        //   buttonLisr = ["é€€æ¬¾ä¸­"];
        // } else {
        //   buttonLisr = ["åˆ é™¤è®¢å•"];
        // }


        if (item.is_free == 4) {
          buttonLisr = ["åˆ é™¤è®¢å•"];
        } else {
          if (item.check == 0) {
            buttonLisr = ["åˆ é™¤è®¢å•", "é€€æ¬¾å…³é—­"];
          } else if (item.check == 1) {
            buttonLisr = ["é€€æ¬¾æˆåŠŸ"];
          } else if (item.check == 2) {
            buttonLisr = ["é€€æ¬¾æˆåŠŸ"];
          } else if (item.check == 3) {
            buttonLisr = ["é€€æ¬¾ä¸­"];
          } else if (item.check == 4) {
            buttonLisr = ["é€€æ¬¾å¤±è´¥"];
          } else {
            if (item.is_FightShow==1)
            {
              buttonLisr = ["åˆ é™¤è®¢å•", "ä½¿ç”¨å…æ‹¼å¡ç›´æ¥å‘è´§"];
            }else{
              buttonLisr = ["åˆ é™¤è®¢å•"];
            }
          }
        }
        break;
      case 14:
        // if (item.check == 3) {
        //   buttonLisr = ["åˆ é™¤è®¢å•", "é€€æ¬¾æˆåŠŸ"];
        // } else if (item.check == 11 || item.check == 2) {
        //   buttonLisr = ["é€€æ¬¾å¤±è´¥"];
        // } else if (item.check >= 0) {
        //   buttonLisr = ["é€€æ¬¾ä¸­"];
        // } else {
        //   buttonLisr = ["åˆ é™¤è®¢å•"];
        // }

        if (item.is_free == 4) {
          buttonLisr = ["åˆ é™¤è®¢å•"];
        } else {
          if (item.check == 0) {
            buttonLisr = ["åˆ é™¤è®¢å•", "é€€æ¬¾å…³é—­"];
          } else if (item.check == 1) {
            buttonLisr = ["é€€æ¬¾æˆåŠŸ"];
          } else if (item.check == 2) {
            buttonLisr = ["é€€æ¬¾æˆåŠŸ"];
          } else if (item.check == 3) {
            buttonLisr = ["é€€æ¬¾ä¸­"];
          } else if (item.check == 4) {
            buttonLisr = ["é€€æ¬¾å¤±è´¥"];
          } else {
            buttonLisr = ["åˆ é™¤è®¢å•"];
          }
        }
        break;

      case 15: //96å°æ—¶å·²è¿‡
        buttonLisr = ["ç”³è¯·å…³é—­æ‹¼å›¢"];
        break
      case 16: //å®¢æœå…³é—­æ‹¼å›¢

        if (item.is_free == 4) {
          buttonLisr = ["åˆ é™¤è®¢å•"];
        } else {
          if (item.check == 0) {
            buttonLisr = ["åˆ é™¤è®¢å•", "é€€æ¬¾å…³é—­"];
          } else if (item.check == 1) {
            buttonLisr = ["é€€æ¬¾æˆåŠŸ"];
          } else if (item.check == 2) {
            buttonLisr = ["é€€æ¬¾æˆåŠŸ"];
          } else if (item.check == 3) {
            buttonLisr = ["é€€æ¬¾ä¸­"];
          } else if (item.check == 4) {
            buttonLisr = ["é€€æ¬¾å¤±è´¥"];
          } else {
            buttonLisr = ["åˆ é™¤è®¢å•"];
          }
        }

        break

      case 17: //ä¸­å¥–è®¢å•-ç”³è¯·é€€æ¬¾


        if (item.whether_prize == 2) {

          if (item.new_free == 1) { //æ–°ç”¨æˆ·é¦–å•
            // buttonLisr = ["å…³é—­è®¢å•","æˆä¸ºä¼šå‘˜", "è”ç³»å®¢æœå‘è´§"];

            buttonLisr = ["å…³é—­è®¢å•", "æˆä¸ºä¼šå‘˜", "æ¥é€šå¾®ä¿¡å®¢æœ"];



          } else {
            buttonLisr = ["å…³é—­è®¢å•", "ç”³è¯·å‘è´§"];

          }
        } else {
          buttonLisr = ["å…³é—­è®¢å•"];
        }
        break

      case 21:
        buttonLisr = ["åˆ†äº«å¥½å‹å…è´¹é¢†"];
        break
    }

    return buttonLisr;
  },
  //åˆ—è¡¨åŠ è½½æ›´å¤š
  onReachBottom: function() {
    this.getOrderList();
  },
  //ä¸‹æ‹‰åˆ·æ–°
  onPullDownRefresh: function() {
    this.setData({
      currentpage: 1,
    })
    this.getOrderList();
  },

  //åˆ‡æ¢èœå•
  switchNav: function(e) {
    var page = this;
    var currenttab = e.currentTarget.dataset.current;
    if (this.data.currentTab == currenttab) {
      return false;
    } else {
      var current = app.globalData.user ? e.currentTarget.dataset.current : 0;
      page.setData({
        currentTab: current,
        currentpage: 1,
      });

      if (app.globalData.user) {
        this.getOrderList();
      }
    }
  },

  //éšä¾¿é€›é€›
  gobuytap: function(event) {
    wx.switchTab({
      url: '../../../pages/shouye/shouye',
    })
  },
  //è®¢å•è¯¦æƒ…
  orderdetailTap: function(event) {
    var item = event.currentTarget.dataset.item;
    wx.setStorageSync("orderitem", item);
    wx.setStorageSync("oneYuan_order_code", item.order_code);
    wx.setStorageSync("wxcx_shop_group_price", item.order_price);

    if (item.shop_from == 11 && item.is_roll !=3 ){
      url = '../../../pages/shouye/fightDetail/fightDetail?item=' + item + '&code=' + item.roll_code + "&isTM=" + item.isTM + "&status=" + item.status + '&is_FightShow=' + item.is_FightShow;
      wx.navigateTo({
        url: url,
      })
      return;
    }


    if (item.shop_from == '11' || item.shop_from == '10') {
      var url = 'orderDetail/orderDetail?item=' + item;

      if (item.status == 12) { //å¾…ç–¯æŠ¢

        chouJiangUrl = '../../../pages/listHome/order/oneBuyLuckPan/oneBuyLuckPanIOS?' + "order_code=" + item.order_code + "&FightSuccess=true" + "&comeFromOrder=true";
        if (wx.getStorageSync("NOT_FIRST-GO-ZHUANPAN")) { //éç¬¬ä¸€æ¬¡

          if (zhouJiangMZclick) {

            wx.navigateTo({
              url: chouJiangUrl,
            })

          } else {
            this.setData({
              openYifuDialogShowFQ: true,
            })

          }


        } else { //ç¬¬ä¸€æ¬¡
          is_backFresh = true;
          wx.navigateTo({
            url: chouJiangUrl,
          })
          wx.setStorageSync("NOT_FIRST-GO-ZHUANPAN", true);
          this.fistChoujiangBack = true;
        }

        return

      } else if (item.status == 11 || item.status == 13 || item.status == 15) { //æ‹¼å›¢ä¸æˆåŠŸ
        url = '../../../pages/shouye/fightDetail/fightDetail?item=' + item + '&code=' + item.roll_code + "&isTM=" + item.isTM + "&status=" + item.status;
        wx.navigateTo({
          url: url,
        })
      } else if (item.status == 14) { //ç–¯æŠ¢æœªæŠ¢ä¸­
        url = 'orderDetail/orderDetail?item=' + item;
        wx.navigateTo({
          url: url,
        })
      } else {
        wx.navigateTo({
          url: 'orderDetail/orderDetail?item=' + item,
        })
      }

    } else {
      wx.navigateTo({
        url: 'orderDetail/orderDetail?item=' + item,
      })
    }
  },

  //å¤„ç†æŒ‰é’®æ·»åŠ formid
  fightsubmit: function(e) {
    var formId = e.detail.formId;
    if (formId && app.globalData.user != null) {
      util.httpPushFormId(formId);
    }
  },
  //å¾…ä»˜æ¬¾
  foothandleviewtap: function(event) {
    var that = this
    var item = event.currentTarget.dataset.item;
    orderItem = item;
    var title = event.currentTarget.dataset.title;
    if (title == "ä»˜æ¬¾") {
      this.payOrder(item);
    } else if (title == "å–æ¶ˆè®¢å•") {
      this.cancleOrder(item);
    } else if (title == "åˆ é™¤è®¢å•") {
      this.deleateOrder(item);
    } else if (title == "è”ç³»å–å®¶") {

    } else if (title == "é‚€è¯·å¥½å‹æ‹¼å›¢") {
      wx.navigateTo({
        url: '../../../pages/shouye/fightDetail/fightDetail?item=' + item + '&code=' + item.roll_code + "&isTM=" + item.isTM + "&status=" + item.status,
      })
    } else if (title == "ä¼šå‘˜å…è´¹é¢†") {

      wx.setStorageSync("oneYuan_order_code", item.order_code);
      wx.setStorageSync("wxcx_shop_group_price", item.order_price);
      var urlstr = app.globalData.systemInfo == "ios" ? "../../../oneBuyLuckPan/oneBuyLuckPanLast?" : "../../../oneBuyLuckPan/oneBuyLuckPanAndroid?"

      chouJiangUrl = '../../../pages/listHome/order/oneBuyLuckPan/oneBuyLuckPanIOS?' + "order_code=" + item.order_code + "&FightSuccess=true" + "&comeFromOrder=true";
      if (wx.getStorageSync("NOT_FIRST-GO-ZHUANPAN")) { //éç¬¬ä¸€æ¬¡


        if (zhouJiangMZclick) {

          wx.navigateTo({
            url: chouJiangUrl,
          })

        } else {
          this.setData({
            openYifuDialogShowFQ: true,
          })

        }




      } else { //ç¬¬ä¸€æ¬¡
        is_backFresh = true;
        wx.navigateTo({
          url: chouJiangUrl,
        })
        wx.setStorageSync("NOT_FIRST-GO-ZHUANPAN", true);
        this.fistChoujiangBack = true;
      }
    } else if (title == "ç”³è¯·å…³é—­æ‹¼å›¢") {
      this.ptSuccessOrder_code = item.order_code
      this.ptSuccesRoll_code = item.roll_code
      wx.setStorageSync("oneYuan_order_code", item.order_code);

      that.setData({
        openGetJiqiDialog: true
      })

      // wx.showLoading({
      //   title: 'è¯·ç¨å',
      //   mask: true,
      // })
      // setTimeout(function() {
      //   wx.hideLoading()
      //   //å¬å”¤æœºå™¨äººå‚å›¢
      //   that.callRobot()
      // }, 2000)



    } else if (title == "é€€æ¬¾ä¸­" || title == "é€€æ¬¾æˆåŠŸ" || title == "é€€æ¬¾å…³é—­") {
      is_goTiXianDetail = true;

      if (item.check == 3 && !item.business_code) { //48å°æ—¶æç°æœªåˆ°ï¼Œæ¨¡æ‹Ÿæç°ä¸­
        wx.navigateTo({
          url: '../../../pages/mine/wallet/accountDetail/ForwardDetail?' +
            "business_code=" + item.business_code +
            "&check=" + item.check +
            "&t_type=" + "-1" +
            "&isVirtualTKZ=" + true +
            "&order_price=" + item.order_price +
            "&draw_time=" + item.draw_time


            ,
        })
      } else {
        wx.navigateTo({
          url: '../../../pages/mine/wallet/accountDetail/ForwardDetail?' +
            "business_code=" + item.business_code +
            "&check=" + item.check +
            "&t_type=" + "-1",
        })
      }



    } else if (title == "é€€æ¬¾å¤±è´¥") {
      this.setData({
        openRefundFailShow: true
      })
    } else if (title == "ç”³è¯·å‘è´§") {
      // that.showToast('ç”³è¯·å‘è´§', 2000);


      if (item.whether_prize == 2) { //é¢„å…ˆä¸­å¥–

        // if (item.new_free == 1) { //æ–°ç”¨æˆ·é¦–å•
        //   if (nRaffle_status == 1) {
        //     wx.navigateTo({
        //       url: '../addMemberCard/addMemberCard?vip_type=-5',
        //     })
        //   }
         
        // } else {
        //   // buttonLisr = ["ç”³è¯·å‘è´§"];
        //   this.sqfh(item);

        // }

        //2020-2-27 ä½•æ³¢ä¿®æ”¹
        if(that.data.isVip <= 0 || that.data.isVip ==3){//ä¸æ˜¯ä¼šå‘˜ 
          this.setData({
            guidedeliverCouponImg: 1,
            guidedeliverCouponShow: true
          })
        }else{
          this.sqfh(item);
        }

      }else{
        this.sqfh(item);

      }



    } else if (title == "ç”³è¯·é€€æ¬¾") {
      // that.showToast('ç”³è¯·é€€æ¬¾', 2000);

      that.reFundOrder(item);



    } else if (title == "å…³é—­è®¢å•") {

      that.colseOrder(item);
    } else if (title == "äº†è§£ä¼šå‘˜") {

      if (wx.getStorageSync("showVipGuide")) {
        wx.navigateTo({
          url: '../addMemberCard/addMemberCard',
        })
      } else {
        wx.setStorageSync('showVipGuide', true)
        wx.navigateTo({
          // url: '../member/member?memberComefrom=' + "mine",
          url: '../addMemberCard/addMemberCard?memberComefrom=mine',
        })
      }




    } else if (title == "æˆä¸ºä¼šå‘˜") {

      // wx.navigateTo({
      //   url: '../member/member?memberComefrom=' + "order",
      // })


      if (wx.getStorageSync("showVipGuide")) {
        wx.navigateTo({
          url: '../addMemberCard/addMemberCard?memberComefrom=' + "order",
        })
      } else {
        wx.setStorageSync('showVipGuide', true)
        wx.navigateTo({
          // url: '../member/member?memberComefrom=' + "order",
          url: '../addMemberCard/addMemberCard?memberComefrom=' + "order",
        })
      }



    } else if (title == "å»ºç¾¤åˆ†äº«å¥½å‹") {
      wx.setStorageSync("first_shopdata", item.orderShops);


      wx.navigateTo({
        url: "/pages/shouye/shareFightDetail/shareFightDetail?" +
          "&isTM=" + item.isTM
      })


    } else if (title == "åˆ†äº«ç¾¤èŠ") {
      wx.setStorageSync("first_shopdata", item.orderShops);


      wx.navigateTo({
        url: "/pages/shouye/shareGroupChat/shareGroupChat?" +
          "&isTM=" + item.isTM
      })


    } else if (title == "åˆ†äº«å¥½å‹å…è´¹é¢†") {
      wx.setStorageSync("second_shopdata", item.orderShops);


      wx.navigateTo({
        url: "/pages/mine/order/freeLingShare/freeLingShare?" +
          "isTM=" + item.isTM +
          "&order_code=" + item.order_code +
          "&FightSuccess=true" +
          "&comeFromOrder=true"

      })


    } else if (title == "å»èµšé’±ä»»åŠ¡") {
      wx.navigateTo({
        url: '../../../pages/sign/sign',
      })
    } else if (title == "ç‚¹å‡»å…è´¹å‘è´§") {

      var token = app.globalData.user.userToken;
      var order_code = item.order_code;
      var url = config.Host + "order/uptOrderFreeDelivery?token=" + token + config.Version + "&order_code=" + order_code;
      util.http(url, function(data){
        if(data.status == 1){
          that.setData({
            currentpage: 1,
          })
          that.getOrderList();

        }else{
          that.showToast(data.message, 2000);

        }
      });

 

    }else if (title == "å»ä»˜æ¬¾") {
      wx.navigateTo({
        url: '../../../pages/shouye/fightDetail/fightDetail?code=' + item.roll_code + "&isTM=" + item.isTM + "&status=" + item.status,
      })

    } else if (title == "å·²ä»˜æ¬¾") {
      wx.navigateTo({
        url: '../../../pages/shouye/fightDetail/fightDetail?code=' + item.roll_code + "&isTM=" + item.isTM + "&status=" + item.status,
      })
    } else if (title == "ä½¿ç”¨å…æ‹¼å¡ç›´æ¥å‘è´§") {
      wx.navigateTo({
        url: '/pages/mine/addMemberCard/addMemberCard?memberComefrom=freeFight'
      })
    }
    else {
      this.setData({
        openYifuDialogShow: true
      })
    }
  },
  dialogGoChoujiang: function() { //æŠ½å¥–å¼¹çª—æŒ‰é’®ç‚¹å‡»


    this.setData({
      openYifuDialogShow: false,
      openYifuDialogShowFQ: false,

      showIOSdownload: true,
    })



  },
  // æ”¯ä»˜å›è°ƒ
  // appId: "wxeb7839c8cbeef680"
  // nonceStr: "zr73uq589vbk59tlntcri8a1dgxkk44w"
  // package: "prepay_id=wx2017112416500900940db3290184964231"
  // paySign: "2DADDBA31784C2D2271FA0343A1B10AD"
  // signType: "MD5"
  // timeStamp: 1511858924066
  orderPayResult: function(data) {
    var that = this;
    if (data.status == 1) {
      var xml = data.xml;
      wx.requestPayment({
        'timeStamp': xml.timeStamp + "",
        'nonceStr': xml.nonceStr,
        'package': xml.package,
        'signType': xml.signType,
        'paySign': xml.paySign,
        'success': function(res) {
          that.setData({ //åˆ·æ–°åˆ—è¡¨
            currentpage: 1,
          })
          var shop = orderItem.orderShops[0];
          if (shop.shop_from != 10 && shop.shop_from != 11 && shop.shop_from != 4 && shop.shop_from != 6) {
            //æ™®é€šè®¢å•åˆ°è®¢å•è¯¦æƒ…ç•Œé¢
            wx.redirectTo({
              url: 'orderDetail/orderDetail?isNormalBuy=' + 'true',
            })
          } else {
            that.getOrderList();
          }

          // if (that.data.buyType == 1) {
          //   var fdStart = that.data.order_code.indexOf("G");
          //   var dataUrl = '';
          //   if (fdStart == 0) {//è¡¨ç¤ºstrCodeæ˜¯ä»¥sssså¼€å¤´ï¼›
          //     dataUrl = config.PayHost + 'treasures/getPayCodeList?' + config.Version + "&token=" + app.globalData.user.userToken + '&g_code=' + that.data.order_code + '&pay_type=2';
          //   } else {//è¡¨ç¤ºstrCodeä¸æ˜¯ä»¥sssså¼€å¤´
          //     dataUrl = config.PayHost + 'treasures/getPayCode?' + config.Version + "&token=" + app.globalData.user.userToken + '&order_code=' + that.data.order_code + '&pay_type=2';
          //   }
          //   util.http(dataUrl, that.getInCode)
          // }
          // else
          //   wx.redirectTo({
          //     url: '../../../sign/withdrawLimit/withdrawLimit?isFromPaySuccess=true&totalAccount=' + that.data.totalAccount,
          //   })

          // wx.setStorage({
          //   key: 'payPrice',
          //   data: that.data.totalAccount,
          // })
        },
        'fail': function(res) {
          that.showToast('æ”¯ä»˜å¤±è´¥', 2000);
        }
      })
      that.data.isConfirm = false;
    } else {
      that.showToast(data.message, 2000);
      that.data.isConfirm = false;
    }
  },
  //ä»˜æ¬¾
  payOrder: function(item) {
    var that = this;
    wx.setStorageSync("orderitem", item);

    var order_code = item.order_code;
    console.log("order_code=", order_code);

    var fdStart = order_code.indexOf("G");
    var payUrl = 'wxpaycx/wapUinifiedOrder?';
    if (fdStart == 0) {
      payUrl = 'wxpaycx/wapUinifiedOrderList?';
    }

    wx.login({
      success: res => {
        // å‘é€ res.code åˆ°åå°æ¢å– openId, sessionKey, unionId, 3rd_session
        if (res.code) {
          var dataUrl = config.PayHost + payUrl + config.Version + "&token=" + app.globalData.user.userToken + '&order_code=' + order_code + '&order_name=æˆ‘çš„' + '&code=' + res.code;
          util.http(dataUrl, that.orderPayResult)
        } else {
          console.log('è·å–ç”¨æˆ·ç™»å½•æ€å¤±è´¥ï¼' + res.errMsg)
          that.showToast('è·å–ç”¨æˆ·ç™»å½•æ€å¤±è´¥ï¼' + res.errMsg, 2000);
          that.data.isConfirm = false;
        }
      }
    })
  },
  //å–æ¶ˆè®¢å•
  cancleOrder: function(item) {
    var token = app.globalData.user.userToken;
    var order_code = item.order_code;
    var url = config.Host + "order/escOrder?token=" + token + config.Version + "&order_code=" + order_code;
    util.http(url, this.cancleOrderdata);
  },
  cancleOrderdata: function(data) {
    if (data.status == 1) {
      this.setData({
        currentpage: 1,
      })
      this.getOrderList();
      this.showToast("å–æ¶ˆæˆåŠŸ", 2000);
    } else {
      this.showToast("å–æ¶ˆå¤±è´¥", 2000);
    }
  },

  //åˆ é™¤è®¢å•
  deleateOrder: function(item) {
    var token = app.globalData.user.userToken;
    var order_code = item.order_code;
    var url = config.Host + "order/delOrder?token=" + token + config.Version + "&order_code=" + order_code;
    util.http(url, this.deleateOrderdata);
  },
  deleateOrderdata: function(data) {
    if (data.status == 1) {
      this.setData({
        currentpage: 1,
      })
      this.getOrderList();
      this.showToast("åˆ é™¤æˆåŠŸ", 2000);
    } else {
      this.showToast("åˆ é™¤å¤±è´¥", 2000);
    }
  },
  //ç”³è¯·å‘è´§
  sqfh: function(item) {

    var that = this
    clickWhether_prize = item.whether_prize;
    clickStatus = item.status;

    wx.setStorageSync("SQFH_SHOP_ITEM", item)

    //æŸ¥è¯¢æ˜¯å¦æ˜¯ä¼šå‘˜
    //è·å–ä¼šå‘˜ä¿¡æ¯
    util.get_vip(function(data) {
      var isVip = data.isVip != undefined ? data.isVip : 0; //0ä¸æ˜¯ 1æ˜¯

      isClickVip = isVip
      //æµ‹è¯•
      // clickWhether_prize = 2
      // clickStatus = 2

      wx.setStorageSync("orderitem", data);
      var token = app.globalData.user.userToken;
      var order_code = item.order_code;
      var url = config.Host + "order/applySendOrderTips?token=" + token + config.Version

        +
        "&order_code=" + order_code +
        "&bak=" + item.bak;



      util.http(url, that.sqfhData);


    })





  },
  sqfhData: function(data) {
    //æµ‹è¯•ç”¨
    // clickStatus = 2 
    // clickWhether_prize = 2
    if (data.status == 1) {




      //
      // var url =  '../sqfh/sqfh?memberComefrom=' + "mine";
      // wx.navigateTo({
      //   url: url,
      // })




      var supName = wx.getStorageSync("SQFH_SHOP_ITEM").order_name;
      //æŸ¥è¯¢å“ç‰Œ
      var basesData = wx.getStorageSync("shop_tag_basedata");

      var supperlabList = basesData.data.supp_label;
      for (var i = 0; i < supperlabList.length; i++) {
        var supperid = supperlabList[i]["id"];
        if (data.label == supperid) {
          var supp_label = supperlabList[i]["name"];
          if (supp_label != undefined) {
            supName = supp_label + data.type2
          }
          break;
        }
      }

      servicewxh = data.wxh


      if (clickStatus == 17 && clickWhether_prize == 2) { //æ— éœ€å®¢æœå‘è´§çš„å•ç‹¬å¤„ç†
        this.setData({
          supName: supName,
          clickWhether_prize: clickWhether_prize,
          sqfhData: data,
          sqFHshow: true,
          clickStatus: clickStatus,
          isClickVip: isClickVip
        })

      } else {

        var item = JSON.stringify(data);


        var url = '../sqfh/sqfh?clickWhether_prize=' + clickWhether_prize +
          "&clickStatus=" + clickStatus +
          "&supName=" + supName +
          "&item=" + item

        wx.navigateTo({
          url: url,
        })
      }








    } else {
      this.showToast("ç”³è¯·å¤±è´¥", 2000);
    }
  },


  //å…³é—­è®¢å•
  colseOrder: function(item) {
    var that = this;
    var token = app.globalData.user.userToken;
    var order_code = item.order_code;
    var url = config.Host + "order/closeTemporaryRollOrder?token=" + token + config.Version + "&order_code=" + item.order_code;
    util.http(url, function(data) {

      if (data.status == 1) {
        that.setData({
          currentpage: 1,
        })
        that.getOrderList();
        that.showToast("å…³é—­è®¢å•æˆåŠŸ", 2000);

      } else {
        that.showToast("å…³é—­è®¢å•å¤±è´¥", 2000);
      }

    });
  },

  //ç”³è¯·é€€æ¬¾
  reFundOrder: function(item) {
    var token = app.globalData.user.userToken;
    var order_code = item.order_code;
    var url = config.Host + "order/refundTemporaryRollOrder?token=" + token + config.Version + "&order_code=" + item.order_code;
    util.http(url, this.reFundOrderrdata);
  },
  reFundOrderrdata: function(data) {
    if (data.status == 1) {
      this.setData({
        currentpage: 1,
      })
      this.getOrderList();
      this.showToast("ç”³è¯·æˆåŠŸ", 2000);





    } else {
      this.showToast("ç”³è¯·å¤±è´¥", 2000);
    }
  },

  //åˆ†äº«å¥½å‹æ‹¼å›¢
  shareOrder: function(item) {
    console.log("åˆ†äº«å¥½å‹æ‹¼å›¢");
  },
  //å…³é—­ä¸‹è½½å¼¹æ¡†
  open_yifu_iknow: function() {
    this.setData({
      openYifuDialogShow: false,
      openYifuDialogShowFQ: false

    });
  },


  //è·å–å¯æŠµæ‰£ä½™é¢
  top_shopHttp: function(item) {
    var that = this;
    that.setData({
      discount_clickItem: item
    })
    var token = "";
    if (app.globalData.user != null) {
      token = app.globalData.user.userToken;
    }
    var oldurl = config.Host + 'order/getZeroOrderDeductible?' + config.Version + '&token=' + token;
    util.http(oldurl, that.discount_data);
  },
  discount_data: function(data) {
    if (data.status == 1) {
      var one_deductible = Number(this.data.discountitem.one_deductible);
      var title = one_deductible > 0 ? "ä½™é¢æŠµæ‰£è¯´æ˜" : "ç–¯æŠ¢é€€æ¬¾è¯´æ˜";

      this.setData({
        oneYuanDiscriptionTitle: title,
        moneyDiscountShowFlag: true,
        // moneyDiscount: (data.order_price * 1).toFixed(1), 
        moneyDiscount: (data.one_not_use_price * 1).toFixed(1),
      })
    }
  },

  //æŠµæ‰£å¼¹æ¡†
  discountClick: function(event) {
    var item = event.currentTarget.dataset.item;
    wx.setStorageSync("orderitem", item);
    if (item.is_free == 4) {
      wx.navigateTo({
        url: 'orderDetail/orderDetail?item=' + item,
      })
      return
    }


    this.data.discountitem = item;
    if ((item.orderstatus == 'å…è´¹é¢†æœªç‚¹ä¸­' || item.orderstatus == 'æ‹¼å›¢å¤±è´¥') && item.orderstatus != 'å¾…å‘è´§') {
      this.top_shopHttp(item);
    } else if (item.one_deductible > 0) {
      this.top_shopHttp(item);
    } else {
      wx.setStorageSync("orderitem", item);
      wx.setStorageSync("oneYuan_order_code", item.order_code);
      wx.setStorageSync("wxcx_shop_group_price", item.order_price);
      if (item.shop_from == '11' || item.shop_from == '10') {

        var url = 'orderDetail/orderDetail?item=' + item;

        if (item.status == 12) {

          chouJiangUrl = '../../../pages/listHome/order/oneBuyLuckPan/oneBuyLuckPanIOS?' + "order_code=" + item.order_code + "&FightSuccess=true" + "&comeFromOrder=true";
          if (wx.getStorageSync("NOT_FIRST-GO-ZHUANPAN")) { //éç¬¬ä¸€æ¬¡
            this.setData({
              openYifuDialogShowFQ: true,
            })
          } else { //ç¬¬ä¸€æ¬¡
            is_backFresh = true;
            wx.navigateTo({
              url: chouJiangUrl,
            })
            wx.setStorageSync("NOT_FIRST-GO-ZHUANPAN", true);
            this.fistChoujiangBack = true;
          }

          return;

        } else if (item.status == 11 || item.status == 13 || item.status == 15) {
          url = '../../../pages/shouye/fightDetail/fightDetail?item=' + item + '&code=' + item.roll_code + "&isTM=" + item.isTM + "&status=" + item.status;
        } else if (item.status == 14) {
          url = 'orderDetail/orderDetail?item=' + item;
        }

        wx.navigateTo({
          url: url,
        })

      } else {
        wx.navigateTo({
          url: 'orderDetail/orderDetail?item=' + item,
        })
      }
    }
  },
  //ä½™é¢æŠµæ‰£å¼¹çª—ç‚¹å‡»å»èµšä½™é¢ å…³é—­
  getMoneyBtn: function() {
    this.setData({
      moneyDiscountShowFlag: false
    })
    wx.navigateTo({
      url: "../../sign/sign",
    })
  },
  //ä½™é¢æŠµæ‰£å¼¹çª—ç‚¹å‡»çŸ¥é“äº† å…³é—­
  getYiDouBtn: function() {
    this.setData({
      moneyDiscountShowFlag: false
    })
  },

  //ä½™é¢æŠµæ‰£å¼¹çª—ç‚¹å‡»æŸ¥çœ‹ä½™é¢ å…³é—­
  getYueBtn: function() {
    wx.navigateTo({
      url: '../../mine/wallet/wallet',
    })
    this.setData({
      moneyDiscountShowFlag: false
    })
  },

  //ä½™é¢æŠµæ‰£å¼¹çª—ç‚¹å‡»é€€æ¬¾è¿›åº¦ å…³é—­
  getRefundSchedule: function(event) {
    if (this.data.discount_clickItem.check >= 0) //è¿›åº¦
    {
      is_goTiXianDetail = true;
      wx.navigateTo({
        url: '../../../pages/mine/wallet/accountDetail/ForwardDetail?' + "business_code=" + this.data.discount_clickItem.business_code,
      })
    } else { //è€çš„è®¢å• æŸ¥çœ‹ä½™é¢
      wx.navigateTo({
        url: '../../mine/wallet/wallet',
      })
    }

    this.setData({
      moneyDiscountShowFlag: false
    })
  },
  closeYiDouBtn: function() {
    this.setData({
      moneyDiscountShowFlag: false
    })
  },







  //è·å–äºŒçº§ç±»ç›®
  top_shopTypeHttp: function(shop) {
    var that = this;
    var token = "";
    if (app.globalData.user != null) {
      token = app.globalData.user.userToken;
    }
    var oldurl = config.Host + 'shop/queryShopType2?' + config.Version + '&token=' + token + '&shop_code=' + shop.shop_code;
    util.http(oldurl, that.type_data);
  },
  type_data: function(data) {
    if (data.status == 1) {
      var shop = orderItem.orderShops[0];
      var supp_label = 'è¡£è ';
      if (shop.supp_label) {
        supp_label = shop.supp_label;
      }

      var sharemoney = app.globalData.oneYuanFree > 0 ? '0' : this.data.wxcx_shop_group_price;

      // var shareJson = 'å¿«æ¥' + this.data.wxcx_shop_group_price + 'å…ƒæ‹¼' + 'ã€' + supp_label + 'æ­£å“' + data.type2 + 'ã€‘,' + 'ä¸“æŸœä»·' + shop.shop_price + 'å…ƒ!';
      // if (shop_type == 2) {
      //   shareJson = 'å¿«æ¥' + this.data.wxcx_shop_group_price + 'å…ƒæ‹¼' + 'ã€' + this.data.shop.shop_name + 'ã€‘,' + 'åŸä»·' + shop.shop_price + 'å…ƒ!';
      // }
      this.data.shareTitle = "";
    }
  },

  onShareAppMessage: function(res) {
    var shop = orderItem ? orderItem.orderShops[0] : this.data.orderList[0].orderShops[0];
    var shop_code = shop.shop_code;
    var share_pic = shop.new_shop_pic + '!450';
    var shop_name = shop.shop_name;
    var supp_label = shop.supp_label ? shop.supp_label : "è¡£è ";
    var user_id = '';

    if (app.globalData.user) {
      user_id = app.globalData.user.user_id
    }

    var shareTitle = 'ç‚¹å‡»è´­ä¹°ğŸ‘†' + 'ã€' + shop.shop_name + 'ã€‘' + "ä»Šæ—¥ç‰¹ä»·" + shop.shop_price + "å…ƒï¼";

    var that = this;
    if (res.from === 'button') {
      // æ¥è‡ªé¡µé¢å†…è½¬å‘æŒ‰é’®
      console.log(res.target)
    }

    return {
      title: shareTitle,
      path: '/pages/shouye/detail/detail?shop_code=' + this.data.shop_code + "&isShareFlag=true" + "&user_id=" + user_id,
      imageUrl: that.data.Upyun + share_pic,
      success: function(res) {
        // that.setData({ isOneShowShare: false })
      },
      fail: function(res) {
        // è½¬å‘å¤±è´¥
      }
    }
  },

  closeToTX: function() {
    this.setData({
      openYifuDialogShow: false
    })
  },

  closeToTXFQ: function() {

    this.setData({
      openYifuDialogShowFQ: false
    })

    is_backFresh = true;
    wx.navigateTo({
      url: chouJiangUrl,
    })
    wx.setStorageSync("NOT_FIRST-GO-ZHUANPAN", true);
  },
  closeIOSdownload: function() {
    zhouJiangMZclick = true
    this.setData({
      showIOSdownload: false
    })
  },

  colseFirstChouJiangBackDialog: function() {
    this.setData({
      showFirstChoujiangBackDialog: false,
      showIOSdownload: true,

    })
  },

  downloadsubmit: function(e) {
    var formId = e.detail.formId;
    if (formId && app.globalData.user != null) {
      util.httpPushFormId(formId);
    }
  },
  goAPPtx: function() { //å¼•å¯¼ä¸‹è½½APP

    // if (app.globalData.systemInfo == "ios") {

    //   console.log("iosæ‰‹æœº")

    this.setData({
      openYifuDialogShow: false,
      openYifuDialogShowFQ: false,

      showIOSdownload: true,
    })


    // } else {
    //   console.log("androidæ‰‹æœº")

    //   wx.navigateTo({
    //     url: "downloadapp/downloadapp"

    //   });

    // }

  },
  //å»èµšé’±
  goToMoney: function() {
    this.setData({
      fightSuccess_fail_isShow: false,
      opendeliveryCardShow:false
    })
    wx.navigateTo({
      url: '../../../pages/sign/sign',
    })
  },
  goTiXian: function() {
    this.setData({
      openRefundFailShow: false,
      fightSuccess_fail_isShow: false
    })

    wx.navigateTo({
      url: '../../../pages/mine/wallet/Withdrawals/Withdrawals',
    })
  },
  closePop: function() {
    this.setData({
      openRefundFailShow: false,
      opendeliveryCardShow:false,
      fightSuccess_fail_isShow: false
    })
  },
  //æ˜¯å¦æˆæƒ
  loginSetting: function() {
    var that = this;
    //æŸ¥çœ‹ç”¨æˆ·æ˜¯å¦æˆæƒ æœªæˆæƒå¼¹æˆæƒæç¤ºå¼¹çª—
    wx.getSetting({
      success: res => {
        var authSetting = false;
        if (res.authSetting['scope.userInfo'] || app.globalData.user) {
          // å·²ç»æˆæƒï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨ getUserInfo è·å–å¤´åƒæ˜µç§°ï¼Œä¸ä¼šå¼¹æ¡†
          authSetting = true;
        } else {
          authSetting = false;
        }

        that.setData({
          authSetting: authSetting,
        })
      }
    })
  },
  // æäº¤formId
  loginsubmit: function(e) {
    formId = e.detail.formId;
  },
  //æˆæƒå¼¹çª—
  onclick: function(e) {
    var that = this;
    wx.getUserInfo({
      //å…è®¸æˆæƒ è·å–ç”¨æˆ·ä¿¡æ¯
      success: function(res) {
        that.orderHttp();
        that.setData({
          authSetting: true,
        })
      },
      fail: function() {

      }
    })
  },

  //ç™»å½•æˆåŠŸå›è°ƒ
  orderHttp: function() {
    var that = this;
    app.New_userlogin(function() {
      //æˆæƒç™»å½•æˆåŠŸ
      that.getOrderList();

      // æäº¤formId
      if (formId) {
        util.httpPushFormId(formId);
      }
    });
  },
  onHide: function() {
    if (this.data.FightSuccess) {
      wx.setStorageSync("FightSuccess", true)
      this.setData({
        FightSuccess: false
      })
    }
  },
  //å¬å”¤æœºå™¨äººå‚å›¢
  callRobot: function() {
    var that = this;

    that.setData({
      openGetJiqiDialog: false

    })
    wx.showLoading({
      title: 'è¯·ç¨å',
      mask: true,
    })
    setTimeout(function() {
      wx.hideLoading()
      //å¬å”¤æœºå™¨äººå‚å›¢
      var oldurl = config.Host + 'order/addOrderFake?' + config.Version + "&token=" + app.globalData.user.userToken + "&roll_code=" + that.ptSuccesRoll_code + "&order_code=" + that.ptSuccessOrder_code;
      util.http(oldurl, function(data) {
        if (data.status == 1) { //å‚å›¢æˆåŠŸ
          //åˆ·æ–°åˆ—è¡¨
          that.setData({
            currentpage: 1,
          })
          that.getOrderList();


          var machineText = data.userName + "å·²å‚å›¢ï¼Œæ‹¼å›¢æˆåŠŸï¼Œç°åœ¨å¯ä»¥ç«‹å³ç–¯æŠ¢ï¼Œ1æŠ˜å¸¦èµ°å•†å“ï¼"

          is_backFresh = true;
          var zhuanPanUrl = '../../../pages/listHome/order/oneBuyLuckPan/oneBuyLuckPanIOS?' + "order_code=" + that.ptSuccessOrder_code + "&FightSuccess=true" + "&machineText=" + machineText + "&comeFromOrder=true";
          wx.navigateTo({
            url: zhuanPanUrl
          })
          //å¼¹å‡ºæ‹¼å›¢æˆåŠŸæç¤º
          // that.setData({
          //   ptSuccessUserName: data.userName,
          //   // ptSuccessUserName: "å°ç™½",

          //   openFightSuccessShow: true
          // })


        }
      });


    }, 2000)





  },
  closeFight: function() {
    this.setData({
      openFightSuccessShow: false,
      openGetJiqiDialog: false,
      sqFHshow: false

    })
  },

  getFight: function() {
    this.setData({
      openGetJiqiDialog: false,
      openFightSuccessShow: false
    })
    is_backFresh = true;
    var zhuanPanUrl = '../../../pages/listHome/order/oneBuyLuckPan/oneBuyLuckPanIOS?' + "order_code=" + this.ptSuccessOrder_code + "&FightSuccess=true" + "&comeFromOrder=true";
    wx.navigateTo({
      url: zhuanPanUrl
    })
  },
  //é¢†å–ä¼šå‘˜
  memberSubmit: function(e) {
    formId = e.detail.formId;
    if (formId && app.globalData.user != null) {
      util.httpPushFormId(formId);
    }
    this.setData({
      upperMemberYiFuShow: false,
    })



    if (wx.getStorageSync("showVipGuide")) {
      wx.navigateTo({
        url: '../addMemberCard/addMemberCard',
      })
    } else {
      wx.setStorageSync('showVipGuide', true)
      wx.navigateTo({
        // url: '../member/member?memberComefrom=' + "mine",
        url: '../addMemberCard/addMemberCard?memberComefrom=mine',
      })
    }


  },
  closeNewThirty: function() {
    this.setData({
      upperMemberYiFuShow: false,
    })
  },

  //è‡ªåŠ¨ç™»å½•
  globalLogin: function() {
    var that = this;
    wx.showLoading({
      title: 'è¯·ç¨å',
    })
    util.autoLogin(loginCount, function(loginfailYiFuShow, login_discribution, login_buttontitle, newloginCount) {
      loginCount = newloginCount;
      if (loginCount == 1) //ç™»å½•æˆåŠŸ
      {
        that.setData({
          currentTab: 0,
          currentpage: 1
        })
        that.getOrderList();
      } else {
        that.setData({
          loginfailYiFuShow: loginfailYiFuShow,
          login_discribution: login_discribution,
          login_buttontitle: login_buttontitle,
        })
      }
    })
  },
  //ç™»å½•å¤±è´¥é‡æ–°ç™»å½•
  loginAgainSubmit: function() {
    var that = this;

    that.setData({
      loginfailYiFuShow: false,
    })
    wx.showLoading({
      title: 'è¯·ç¨å',
    })
    that.globalLogin();
  },
  closeLoginPop: function() {
    this.setData({
      loginfailYiFuShow: false
    })
  },

  goToVip: function() {


    wx.navigateTo({
      url: '../addMemberCard/addMemberCard?&vip_type=' + (isClickVip == 0 ? -1005 : -1001),
    })

    this.setData({
      sqFHshow: false

    })

  },

  //æˆä¸ºä¼šå‘˜
  membercouponTap:function(){
    this.setData({
      guidedeliverCouponShow:false
    })
    wx.navigateTo({
      url: '../addMemberCard/addMemberCard?memberComefrom=freelingOrder',
    })
  },
  //å‘è´§å¡å‘è´§
  delivercouponTap:function(){
    this.setData({
      isgotoMemberFromdeliver: true,
      guidedeliverCouponShow: false
    })
    wx.navigateTo({
      url: '/pages/mine/addMemberCard/addMemberCard?memberComefrom=deliver'
    })
  },
  //å…³é—­å‘è´§å¼¹æ¡†
  closeTixianCoupon:function(){
    this.setData({
      guidedeliverCouponShow: false,
      opendeliveryCardShow:true
    })
  },
  closeShowLXKF: function() {
    this.setData({
      showLXKF: false
    })
  },
  //å¤åˆ¶å¾®ä¿¡å·
  copyWXH: function() {

    var self = this;
    wx.setClipboardData({
      data: servicewxh,
      success: function(res) {
        // self.setData({copyTip:true}),
        // wx.showModal({
        //   title: 'æç¤º',
        //   content: 'å¤åˆ¶æˆåŠŸ',
        //   success: function (res) {
        //     if (res.confirm) {
        //       console.log('ç¡®å®š')
        //     } else if (res.cancel) {
        //       console.log('å–æ¶ˆ')
        //     }
        //   }
        // })
      }
    });

  }
})