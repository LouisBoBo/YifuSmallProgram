// pages/sign/inviteFriends/memberFriendsReward.js
import config from '../../../config';
var util = require('../../../utils/util.js');
import ToastPannel from '../../../common/toastTest/toastTest.js';
var app = getApp();

Page({

  /**
   * é¡µé¢çš„åˆå§‹æ•°æ®
   */
  data: {

    Upyun: config.Upyun,
    datalist: {},
    currentpage:1,
    ext_num: 0,
    ext_now: 0,
    ext_yet: 0,
    ext_reward: 0.0
  },

  /**
   * ç”Ÿå‘½å‘¨æœŸå‡½æ•°--ç›‘å¬é¡µé¢åŠ è½½
   */
  onLoad: function (options) {

    if (!app.parent_id && options.user_id) {
      app.parent_id = options.user_id
    }
    
    //å¤§ä¿ƒé”€å·²ç»“æŸ
    var showendofpromotionDialog;
    if (app.globalData.user != null) {
      showendofpromotionDialog = app.globalData.user.showSpecialPage != 1 ? true : false;
    } else {
      showendofpromotionDialog = true;
    }
    if(showendofpromotionDialog)
    {
      wx.setNavigationBarTitle({
        title: 'æˆ‘çš„å¡åˆ¸',
      })
      this.setData({
        showendofpromotionDialog: showendofpromotionDialog
      })
      wx.redirectTo({
        url: '/pages/mine/Coupon/Coupon',
      })
    }else{
      wx.setNavigationBarTitle({
        title: 'å¥½å‹å¥–åŠ±',
      })
    }
    
    new app.ToastPannel();
    this.getDayReward();
    this.getRewardList();
    this.checkLoginSetting();
    util.httpUpyunJson(this.shareData);

    // var that = this;
    // //è·å–æ˜¯å¦æ˜¯ä¼šå‘˜
    // util.get_vip(function (data) {
    //   var isVip = data.isVip != undefined ? data.isVip : 0; //0ä¸æ˜¯ 1æ˜¯
    //   that.setData({
    //     is_vip: isVip
    //   })
    // })

    wx.onUserCaptureScreen(function (res) {
      console.log('â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦ç”¨æˆ·æˆªå±äº†')
      
    })
  },

  //åˆ—è¡¨åŠ è½½æ›´å¤š
  onReachBottom: function () {
    this.getRewardList();
  },
  //ä¸‹æ‹‰åˆ·æ–°
  onPullDownRefresh: function () {
    this.setData({
      currentpage: 1,
    })
    
    this.getDayReward();
    this.getRewardList();
  },
  // ä»Šæ—¥å¥–åŠ± æ•°æ®
  getDayReward: function () {
    if (app.globalData.user == undefined || app.globalData.user == '') {
      wx.stopPullDownRefresh();
      return;
    }
    var dataUrl = config.Host + "wallet/getExtremeToDayCount?" + config.Version + "&token=" + app.globalData.user.userToken;
    util.http(dataUrl, this.dayReward)
  },

  // å¥½å‹å¥–åŠ±æ˜ç»†
  getRewardList: function () {
    if (app.globalData.user == undefined || app.globalData.user == '') {
      wx.stopPullDownRefresh();

      return;
    }
    var dataUrl = config.Host + "wallet/getExtremeTiChengInfo?" + config.Version + "&token=" + app.globalData.user.userToken + "&page=" + this.data.currentpage;
    util.http(dataUrl, this.dayRewardList)
  },
  dayReward: function (data) {
    wx.stopPullDownRefresh();
    var token = (app.globalData.user.userToken != undefined && app.globalData.user.userToken != null) ? app.globalData.user.userToken : '';
    if (data.status == 1) {
      var ext_num = data.data.ext_num ? data.data.ext_num : "0";
      var ext_now = data.data.ext_now ? (1 * data.data.ext_now ).toFixed(0) : "0";
      var ext_yet = data.data.ext_yet ? (1 * data.data.ext_yet).toFixed(0) : "0";
      var ext_money = data.data.ext_money ? (1 * data.data.ext_money).toFixed(1) : "0.0";
      var ext_time = data.data.time ? data.data.time : "0";
      
      this.setData({
        ext_num: ext_num,
        ext_now: ext_now,
        ext_yet: ext_yet,
        ext_time: ext_time,
        ext_reward: ext_money,
        token:token
      })

      var that = this;
      //è·å–æ˜¯å¦æ˜¯ä¼šå‘˜
      util.get_vip(function (data) {
        var isVip = data.isVip != undefined ? data.isVip : 0; //0ä¸æ˜¯ 1æ˜¯
        that.setData({
          is_vip: isVip
        })
      })
    } else {
      this.showToast(data.message, 2000);
    }

  },
  dayRewardList: function (data) {

    if (this.data.currentpage == 1) {
      this.data.datalist = [];
    }

    if (data.status == 1) {
      
      var movies = this.data.datalist;
      var cutJson = {};
      var page = this.data.currentpage + 1;

      for (var idx in data.data) {
        var subject = data.data[idx];
        cutJson = subject;
        var pic = subject.pic;
        if (pic) {
          var fdStart = subject.pic.indexOf("http");
          if (fdStart == 0)
            cutJson['pic'] = pic;
          else
            cutJson['pic'] = config.Upyun + pic;
        }
        var nickname = subject.nickName;
        if (nickname.length > 7) {
          nickname = nickname.substr(0, 7) + '...';
          cutJson['nickName'] = nickname;
        }
        movies.push(cutJson)
      }

      this.setData({
        datalist: movies,
        currentpage: page
      });
    }else{
      this.showToast(data.message, 2000);
    }
  },

  gotoTixian:function(){
    //ä¼šå‘˜æ‰èƒ½æç°
    if (this.data.is_vip == false) {
      return;
    }
    var token = app.globalData.user.userToken;
    if(token != undefined && token != null && token != '')
    {
      wx.navigateTo({
        url: '../../mine/wallet/Withdrawals/Withdrawals',
      })
    }
  },

  //æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æˆæƒç™»å½•
  checkLoginSetting: function () {

    var that = this;
    //æŸ¥çœ‹ç”¨æˆ·æ˜¯å¦æˆæƒ æœªæˆæƒå¼¹æˆæƒæç¤ºå¼¹çª—
    wx.getSetting({
      success: res => {
        if (res.authSetting['scope.userInfo']) { //æˆæƒè¿‡

          if (!app.globalData.user) { //æ‹¿ä¸åˆ°ç”¨æˆ·ä¿¡æ¯-å»ç™»å½•
            app.New_userlogin(function () {
              that.getDayReward();
              that.getRewardList();
              util.httpUpyunJson(that.shareData);
            });
          } 
        } else { //æœªæˆæƒ å¼¹æˆæƒæç¤ºå¼¹çª—
          that.setData({ showTips: true })
        }
      }
    })
  },
  // æˆæƒå¼¹çª—
  onclick: function (e) {
    var that = this;
    wx.getUserInfo({
      //å…è®¸æˆæƒ è·å–ç”¨æˆ·ä¿¡æ¯
      success: function (res) {
        if (!app.globalData.user) {
          wx.showLoading({
            title: 'è¯·ç¨å',
            mask: true,
          })
          //æˆæƒæˆåŠŸå»ç™»å½•
          app.New_userlogin(function () {
            that.getDayReward();
            that.getRewardList();
            util.httpUpyunJson(that.shareData);

            that.setData({ showTips: false })
          });
        }
      },
      fail: function () {

      }
    })
   
  },
  
  /**
   * åˆ†äº«æ•°æ®
   */
  shareData: function (data) {
    var vip_share_links = data.vip_share_links.text;
    var memberData = vip_share_links.split(",");

    var shareTitle = data.wxcx_share_links.title ? data.wxcx_share_links.title : "æˆ‘åˆšé¢†çš„çº¢åŒ…ä¹Ÿåˆ†ä½ ä¸€ä¸ªï¼Œå¸®æˆ‘æç°å°±èƒ½æ‹¿é’±å“¦~";
    var share_pic = config.Upyun + (data.wxcx_share_links.icon ? (data.wxcx_share_links.icon + '?' + Math.random()): "/small-iconImages/heboImg/shareBigImage_new.jpg");

    //è®¾ç½®åˆ†äº«çš„æ–‡æ¡ˆ
    this.setData({
      memberData: memberData,
      shareTitle: shareTitle,
      shareImageUrl: share_pic
    });
  },
  /**
   * ç”¨æˆ·ç‚¹å‡»å³ä¸Šè§’åˆ†äº«
   */
  onShareAppMessage: function (res) {

    var that = this;
    if (res.from === 'menu') {
      // æ¥è‡ªé¡µé¢å†…è½¬å‘æŒ‰é’®
    }else{
      // return {

      //   title: that.data.shareTitle,
      //   path: '/pages/shouye/shouye?' + "isShareFlag=true" + "&user_id=" + app.globalData.user.user_id,
      //   imageUrl: that.data.shareImageUrl,
      //   success: function (res) {
      //     // è½¬å‘æˆåŠŸ
      //     that.showToast('åˆ†äº«æˆåŠŸ', 2000);
      //   },
      //   fail: function (res) {
      //     // è½¬å‘å¤±è´¥
      //     that.showToast('åˆ†äº«å¤±è´¥', 2000);
      //   }
        
      // }



      var user_id = app.globalData.user.user_id;
      var page = 'pages/shouye/redHongBao';
      var str = user_id + ',' + 'ThreePage' + ',' + 'QRcode';

      //æ™®é€šå°ç¨‹åºäºŒç»´ç 
      var path = 'pages/shouye/redHongBao?scene=' + str;
      return {
        title: '199å…ƒè´­ç‰©çº¢åŒ…å…è´¹æŠ¢ï¼Œå¤šå¹³å°å¯ç”¨ï¼Œå¿«æ¥è¯•è¯•äººå“å§	ğŸ‘‰',
        path: path,
        imageUrl: config.Upyun + 'small-iconImages/heboImg/freeling_share199yuan.jpg',
        success: function (res) {
          // è½¬å‘æˆåŠŸ
        },
        fail: function (res) {
          // è½¬å‘å¤±è´¥
        }
      }

    }
  },
})